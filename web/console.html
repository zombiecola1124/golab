<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoLab Â· ì½˜ì†”</title>
  <style>
    :root{
      --bg:#f5f7fa;--card:#ffffff;--border:#e5e7eb;
      --text:#0f172a;--text-kpi:#0f172a;--muted:#64748b;
      --primary:#2563eb;--warn:#dc2626;--accent:#16a34a;--orange:#d97706;
      --purple:#7c3aed;--chip:#f8fafc;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size:13px;line-height:1.5}

    /* â”€ Header â”€ */
    header{padding:12px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);z-index:20;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:15px;font-weight:800;color:var(--primary);letter-spacing:-.2px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:6px 10px;border-radius:8px;border:1px solid var(--border);color:var(--muted);text-decoration:none;font-size:11px;font-weight:600;background:transparent;transition:all .15s}
    .tab:hover{color:var(--text);border-color:#cbd5e1}
    .tab.active{color:var(--primary);background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.3)}

    /* â”€ Layout: 3 Column â”€ */
    .bento{display:grid;grid-template-columns:200px 1fr 280px;gap:20px;max-width:1440px;margin:0 auto;padding:20px 20px 40px;min-height:calc(100vh - 50px)}

    /* â”€ Left Sidebar â”€ */
    .sidebar{display:flex;flex-direction:column;gap:12px}
    .quick-btn{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;text-decoration:none;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .quick-btn:hover{border-color:rgba(37,99,235,.3);background:rgba(37,99,235,.04)}
    .quick-btn .icon{font-size:16px;width:24px;text-align:center;flex-shrink:0}

    /* â”€ Center â”€ */
    .center{display:flex;flex-direction:column;gap:20px;min-width:0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .card-header{display:flex;align-items:center;gap:8px;margin-bottom:14px}
    .card-header h2{font-size:14px;font-weight:700;color:var(--text)}
    .card-header .badge{font-size:10px;padding:2px 8px;border-radius:6px;font-weight:700}
    .card-header .badge.red{background:#fee2e2;color:var(--warn)}
    .card-header .badge.green{background:#dcfce7;color:var(--accent)}
    .card-header .badge.blue{background:#dbeafe;color:var(--primary)}
    .card-header .count{margin-left:auto;font-size:11px;color:var(--muted);font-weight:400}

    /* â”€ TODAY ZONE â”€ */
    .today-zone{border:2px solid var(--primary);border-radius:12px;background:var(--card);padding:20px;box-shadow:0 2px 8px rgba(37,99,235,.06)}
    .today-zone .zone-header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    .today-zone .zone-title{font-size:16px;font-weight:800;color:var(--text)}
    .today-zone .zone-count{font-size:12px;font-weight:700;color:var(--primary);background:rgba(37,99,235,.08);padding:3px 10px;border-radius:6px}
    .today-zone .zone-overdue{font-size:11px;font-weight:700;color:var(--warn);background:#fee2e2;padding:3px 10px;border-radius:6px}
    .today-zone .add-row{display:flex;gap:8px;margin-bottom:16px}
    .today-zone .add-row input{flex:1;border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:12px;outline:none;background:var(--chip);color:var(--text);font-family:inherit}
    .today-zone .add-row input:focus{border-color:var(--primary)}
    .today-zone .add-row button{background:var(--primary);border:none;color:#fff;border-radius:8px;padding:8px 16px;font-size:12px;cursor:pointer;font-weight:600;white-space:nowrap}
    .today-zone .add-row button:hover{background:#1d4ed8}

    .all-clear{text-align:center;padding:30px 20px;color:var(--accent)}
    .all-clear .icon{font-size:32px;margin-bottom:8px}
    .all-clear .msg{font-size:14px;font-weight:700}
    .all-clear .sub{font-size:11px;color:var(--muted);margin-top:4px}

    /* â”€ Action Items â”€ */
    .action-list{list-style:none}
    .action-item{display:flex;align-items:flex-start;gap:10px;padding:12px 0;border-bottom:1px solid var(--border);transition:background .1s}
    .action-item:last-child{border-bottom:none}
    .action-item .chk{width:20px;height:20px;border-radius:5px;border:2px solid var(--border);cursor:pointer;flex-shrink:0;margin-top:1px;display:flex;align-items:center;justify-content:center;transition:all .15s;font-size:11px;background:var(--card)}
    .action-item .chk:hover{border-color:var(--accent);background:rgba(22,163,74,.08)}
    .action-item .chk.done{border-color:var(--accent);background:var(--accent);color:#fff;font-weight:900}
    .action-item.completed{opacity:.35}
    .action-item.completed .act-title{text-decoration:line-through;color:var(--muted)}
    .action-item .act-body{flex:1;min-width:0;cursor:pointer}
    .action-item .act-title{font-size:13px;font-weight:600;color:var(--text)}
    .action-item .act-meta{font-size:10px;color:var(--muted);margin-top:3px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .act-meta .overdue-tag{color:var(--warn);font-weight:700}
    .act-meta .today-tag{color:var(--primary);font-weight:600}
    .act-meta .vendor-tag{color:var(--primary);cursor:pointer;font-weight:600}
    .act-meta .vendor-tag:hover{text-decoration:underline}
    .pri-badge{font-size:9px;font-weight:700;padding:1px 6px;border-radius:4px;text-transform:uppercase}
    .pri-badge.HIGH{background:#fee2e2;color:#991b1b}
    .pri-badge.LOW{background:#f1f5f9;color:var(--muted)}
    .action-item .act-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;padding:4px;opacity:.2;margin-top:2px}
    .action-item .act-del:hover{opacity:1;color:var(--warn)}

    .more-btn{display:flex;align-items:center;justify-content:center;padding:10px;cursor:pointer;color:var(--primary);font-size:12px;font-weight:600;border-top:1px solid var(--border);margin-top:4px}
    .more-btn:hover{background:rgba(37,99,235,.04);border-radius:0 0 8px 8px}

    /* â”€ Week/Overdue Sections â”€ */
    .section-summary{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:8px;cursor:pointer;transition:all .12s;margin-bottom:4px}
    .section-summary:hover{background:rgba(37,99,235,.04)}
    .section-summary .s-icon{font-size:14px}
    .section-summary .s-label{font-size:12px;font-weight:700;color:var(--text)}
    .section-summary .s-count{font-size:11px;font-weight:700;padding:2px 8px;border-radius:6px;margin-left:auto}
    .section-summary .s-count.red{background:#fee2e2;color:var(--warn)}
    .section-summary .s-count.blue{background:#dbeafe;color:var(--primary)}
    .section-summary .s-count.muted{background:#f1f5f9;color:var(--muted)}
    .section-expand{display:none;padding:0 4px 12px}
    .section-expand.open{display:block}

    /* â”€ Timeline â”€ */
    .tl-filters{display:flex;gap:6px;margin-bottom:10px}
    button.filter-btn{font-size:11px;padding:5px 10px;color:var(--muted);border:1px solid var(--border);background:var(--card);border-radius:8px;cursor:pointer;font-weight:600}
    button.filter-btn.active{color:var(--primary);background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.3)}
    .timeline{list-style:none}
    .tl-item{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
    .tl-item:last-child{border-bottom:none}
    .tl-dot{width:7px;height:7px;border-radius:50%;margin-top:6px;flex-shrink:0}
    .tl-dot.purchase{background:var(--primary)}
    .tl-dot.sale{background:var(--orange)}
    .tl-dot.work{background:var(--purple)}
    .tl-body{flex:1;min-width:0}
    .tl-text{font-size:12px;color:var(--text)}
    .tl-text .vendor-link{color:var(--primary);cursor:pointer;font-weight:600}
    .tl-text .vendor-link:hover{text-decoration:underline}
    .tl-time{font-size:10px;color:var(--muted);margin-top:1px}

    /* â”€ Right Sidebar â”€ */
    .right{display:flex;flex-direction:column;gap:16px}
    .cal-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .cal-header span,.cal-header a{font-size:12px;font-weight:700;color:var(--text);text-decoration:none}
    .cal-header a:hover{color:var(--primary);text-decoration:underline}
    .cal-nav{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:2px 6px}
    .cal-nav:hover{color:var(--text)}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center}
    .cal-dow{font-size:9px;color:var(--muted);font-weight:700;padding:4px 0}
    .cal-day{font-size:11px;padding:5px 0;border-radius:6px;cursor:pointer;color:#94a3b8;position:relative}
    .cal-day.current-month{color:var(--text)}
    .cal-day:hover{background:#f1f5f9}
    .cal-day.today{background:transparent;color:var(--primary);font-weight:700;border:2px solid var(--primary);border-radius:6px}
    .cal-day.has-action{font-weight:700}
    .cal-day.has-action::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--primary)}
    .cal-day.has-overdue::after{background:var(--warn)}
    .cal-day.today.has-action::after{background:var(--primary)}

    .kpi-stack{display:flex;flex-direction:column;gap:8px}
    .kpi-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px 14px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .kpi-card .t{font-size:10px;color:var(--muted);font-weight:600}
    .kpi-card .v{font-size:24px;font-weight:600;color:var(--text-kpi);margin-top:4px}

    /* â”€ Vendor Drawer â”€ */
    .drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.2);z-index:90}
    .drawer-overlay.open{display:block}
    .drawer{position:fixed;top:0;right:-42%;width:40%;height:100vh;background:var(--bg);border-left:1px solid var(--border);z-index:100;overflow-y:auto;padding:0;transition:right .25s ease}
    .drawer.open{right:0}
    .drawer-header{padding:20px 20px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:2}
    .drawer-header .top-row{display:flex;align-items:center;justify-content:space-between}
    .drawer-header h3{font-size:16px;font-weight:800;color:var(--text)}
    .drawer-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:4px 8px}
    .drawer-close:hover{color:var(--warn)}
    .drawer-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
    .d-stat{padding:10px;background:var(--card);border:1px solid var(--border);border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .d-stat .t{font-size:9px;color:var(--muted);font-weight:700;text-transform:uppercase}
    .d-stat .v{font-size:14px;font-weight:900;margin-top:3px;color:var(--text)}
    .drawer-tags{padding:0 20px;margin-top:12px;display:flex;gap:6px;flex-wrap:wrap}
    .htag{font-size:10px;padding:3px 8px;border-radius:6px;background:rgba(37,99,235,.08);color:var(--primary);font-weight:600}
    .drawer-body{padding:16px 20px}
    .drawer-body h4{font-size:11px;color:var(--muted);font-weight:700;margin-bottom:10px;text-transform:uppercase;letter-spacing:.3px}
    .drawer-footer{padding:16px 20px;border-top:1px solid var(--border)}
    .drawer-footer h4{font-size:11px;color:var(--muted);font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:.3px}
    .drawer-todo{font-size:12px;color:var(--text);padding:6px 0;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center}
    .drawer-todo:last-child{border-bottom:none}
    .drawer-todo .dt-dot{width:6px;height:6px;border-radius:50%;background:var(--orange);flex-shrink:0}

    /* â”€ Action Modal â”€ */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:110;align-items:flex-start;justify-content:center;padding-top:80px}
    .modal-overlay.open{display:flex}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:12px;width:440px;max-width:90vw;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.12)}
    .modal h3{font-size:14px;font-weight:800;color:var(--text);margin-bottom:14px}
    .modal label{display:block;font-size:10px;color:var(--muted);margin-bottom:3px;margin-top:10px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
    .modal input,.modal select{width:100%;border-radius:8px;border:1px solid var(--border);background:var(--chip);color:var(--text);padding:8px 10px;font-size:12px;outline:none;transition:border .15s;font-family:inherit}
    .modal input:focus{border-color:var(--primary)}
    .modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
    .modal-btns button{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:8px;padding:8px 16px;font-size:12px;cursor:pointer;font-weight:600;transition:all .15s}
    .modal-btns button:hover{border-color:#cbd5e1;background:#f8fafc}
    .modal-btns .btn-primary{background:var(--primary);border:none;color:#fff}
    .modal-btns .btn-primary:hover{background:#1d4ed8}
    .modal-btns .btn-danger{color:var(--warn);border-color:rgba(220,38,38,.3)}
    .modal-btns .btn-danger:hover{background:#fee2e2}

    /* â”€ Vendor Search Modal â”€ */
    .search-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:80;align-items:flex-start;justify-content:center;padding-top:120px}
    .search-overlay.open{display:flex}
    .search-modal{background:var(--card);border:1px solid var(--border);border-radius:12px;width:400px;max-width:90vw;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.12)}
    .search-modal label{display:block;font-size:10px;color:var(--muted);margin-bottom:4px;font-weight:700;text-transform:uppercase}
    .search-modal input{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:12px;outline:none;background:var(--chip);color:var(--text)}
    .search-modal input:focus{border-color:var(--primary)}
    .search-results{list-style:none;margin-top:10px;max-height:300px;overflow-y:auto}
    .search-results li{padding:8px 10px;cursor:pointer;border-radius:6px;font-size:12px;color:var(--text);transition:background .1s}
    .search-results li:hover{background:rgba(37,99,235,.08)}

    /* â”€ Data Management Section â”€ */
    .data-mgmt{margin-top:auto;border-top:1px solid var(--border);padding-top:12px}
    .data-mgmt-toggle{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--muted);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;width:100%;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .data-mgmt-toggle:hover{color:var(--text);border-color:#cbd5e1}
    .data-mgmt-toggle .dm-icon{font-size:14px}
    .data-mgmt-toggle .dm-arrow{margin-left:auto;font-size:10px;transition:transform .2s}
    .data-mgmt-toggle.open .dm-arrow{transform:rotate(180deg)}
    .data-mgmt-body{display:none;margin-top:8px;padding:12px;background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .data-mgmt-body.open{display:block}
    .dm-info{font-size:10px;color:var(--muted);margin-bottom:10px;line-height:1.6}
    .dm-info .dm-val{font-weight:700;color:var(--text)}
    .dm-btn{display:flex;align-items:center;gap:8px;width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--chip);color:var(--text);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;margin-bottom:6px}
    .dm-btn:last-child{margin-bottom:0}
    .dm-btn:hover{border-color:rgba(37,99,235,.3);background:rgba(37,99,235,.04)}
    .dm-btn .dm-bi{font-size:14px;width:20px;text-align:center}

    /* â”€ Restore Panel (overlay in center) â”€ */
    .restore-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:120;align-items:flex-start;justify-content:center;padding-top:60px}
    .restore-overlay.open{display:flex}
    .restore-panel{background:var(--card);border:1px solid var(--border);border-radius:12px;width:560px;max-width:92vw;max-height:80vh;overflow-y:auto;padding:24px;box-shadow:0 12px 40px rgba(0,0,0,.15)}
    .restore-panel h3{font-size:15px;font-weight:800;color:var(--text);margin-bottom:4px}
    .restore-panel .rp-sub{font-size:11px;color:var(--muted);margin-bottom:16px}
    .rp-mode{display:flex;gap:8px;margin-bottom:16px}
    .rp-mode label{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600;cursor:pointer;padding:8px 14px;border-radius:8px;border:1px solid var(--border);transition:all .15s}
    .rp-mode label:hover{border-color:rgba(37,99,235,.3)}
    .rp-mode input[type=radio]{accent-color:var(--primary)}
    .rp-mode label.active{border-color:var(--primary);background:rgba(37,99,235,.06)}
    .rp-report{background:var(--chip);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px}
    .rp-report h4{font-size:12px;font-weight:700;color:var(--text);margin-bottom:10px}
    .rp-row{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:12px;border-bottom:1px solid var(--border)}
    .rp-row:last-child{border-bottom:none}
    .rp-row .rp-icon{font-size:14px;width:22px;text-align:center}
    .rp-row .rp-label{flex:1;color:var(--text)}
    .rp-row .rp-count{font-weight:700;color:var(--text)}
    .rp-capacity{margin-top:12px;padding:10px;background:rgba(37,99,235,.04);border-radius:8px;font-size:11px;color:var(--text)}
    .rp-capacity.warn{background:rgba(220,38,38,.06);color:var(--warn)}
    .rp-keys{margin-top:10px;max-height:200px;overflow-y:auto}
    .rp-key-item{font-size:11px;padding:4px 8px;display:flex;gap:6px;align-items:center;border-bottom:1px solid var(--border)}
    .rp-key-item:last-child{border-bottom:none}
    .rp-key-item .kname{flex:1;font-family:monospace;color:var(--text)}
    .rp-key-item .kstatus{font-size:10px;font-weight:700;padding:1px 6px;border-radius:4px}
    .rp-key-item .kstatus.overwrite{background:#dbeafe;color:var(--primary)}
    .rp-key-item .kstatus.add{background:#dcfce7;color:var(--accent)}
    .rp-key-item .kstatus.delete{background:#fee2e2;color:var(--warn)}
    .rp-key-item .kstatus.keep{background:#dcfce7;color:var(--accent)}
    .rp-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
    .rp-btns button{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:8px;padding:10px 20px;font-size:12px;cursor:pointer;font-weight:600;transition:all .15s}
    .rp-btns button:hover{border-color:#cbd5e1;background:#f8fafc}
    .rp-btns .btn-commit{background:var(--warn);border:none;color:#fff;font-weight:700}
    .rp-btns .btn-commit:hover{background:#b91c1c}
    .rp-btns .btn-commit:disabled{background:#94a3b8;cursor:not-allowed}

    /* â”€ Responsive â”€ */
    @media(max-width:1280px){
      .bento{grid-template-columns:1fr 280px}
      .sidebar{display:none}
    }
    @media(max-width:900px){
      .bento{grid-template-columns:1fr;padding:12px}
      .right{display:none}
      .drawer{width:100%;right:-102%}
    }
  </style>
</head>
<body>
<header>
  <h1>GoLab</h1>
  <nav class="tabs">
    <a class="tab active" href="./console.html">ì½˜ì†”</a>
    <a class="tab" href="./purchases.html">ì…ê³ /ì›ê°€</a>
    <a class="tab" href="./index.html">ì¬ê³ </a>
    <a class="tab" href="./trade.html">êµ¬ë§¤ ì´ë ¥</a>
    <a class="tab" href="./sales.html">ë§¤ì¶œ</a>
    <a class="tab" href="./profit.html">ìˆ˜ìµ</a>
    <a class="tab" href="./calendar.html">ìº˜ë¦°ë”</a>
  </nav>
</header>

<div class="bento">
  <!-- LEFT: Quick Menu -->
  <aside class="sidebar">
    <a class="quick-btn" href="./trade.html"><span class="icon">ğŸ“Š</span>êµ¬ë§¤ ë“±ë¡</a>
    <a class="quick-btn" href="./sales.html"><span class="icon">ğŸ’°</span>ë§¤ì¶œ ë“±ë¡</a>
    <a class="quick-btn" href="./profit.html"><span class="icon">ğŸ“ˆ</span>ìˆ˜ìµ ë¶„ì„</a>
    <button class="quick-btn" id="btnQuickTask"><span class="icon">âœï¸</span>Action ì¶”ê°€</button>
    <button class="quick-btn" id="btnQuickSearch"><span class="icon">ğŸ”</span>ê±°ë˜ì²˜ ê²€ìƒ‰</button>
    <a class="quick-btn" href="./calendar.html"><span class="icon">ğŸ“…</span>ìº˜ë¦°ë”</a>

    <!-- â•â•â• ë°ì´í„° ê´€ë¦¬ (ì ‘ì´ì‹) â•â•â• -->
    <div class="data-mgmt">
      <button class="data-mgmt-toggle" id="dmToggle">
        <span class="dm-icon">âš™ï¸</span>ë°ì´í„° ê´€ë¦¬
        <span class="dm-arrow">â–¼</span>
      </button>
      <div class="data-mgmt-body" id="dmBody">
        <div class="dm-info">
          í˜„ì¬ ìš©ëŸ‰: <span class="dm-val" id="dmSize">-</span> / 5MB<br>
          golab_ í‚¤: <span class="dm-val" id="dmKeyCount">-</span>ê°œ
        </div>
        <button class="dm-btn" id="btnFullBackup">
          <span class="dm-bi">ğŸ“¦</span>ì „ì²´ ë°±ì—…
        </button>
        <button class="dm-btn" id="btnFullRestore">
          <span class="dm-bi">ğŸ“¥</span>ë°±ì—…ì—ì„œ ë³µì›
        </button>
        <input type="file" id="restoreFileIn" accept="application/json" style="display:none" />
      </div>
    </div>
  </aside>

  <!-- CENTER: Today Zone + Week + Timeline -->
  <main class="center">

    <!-- â•â•â• TODAY ZONE (ìƒë‹¨ 40%) â•â•â• -->
    <div class="today-zone">
      <div class="zone-header">
        <span class="zone-title">ğŸ¯ ì˜¤ëŠ˜ ì‹¤í–‰</span>
        <span class="zone-count" id="todayCount">0ê±´</span>
        <span class="zone-overdue" id="overdueCount" style="display:none">ì§€ì—° 0</span>
        <span style="flex:1"></span>
        <span style="font-size:11px;color:var(--muted)" id="todayDate"></span>
      </div>

      <!-- Quick Add -->
      <div class="add-row">
        <input id="quickInput" placeholder="ì˜¤ëŠ˜ í•  ì¼ ì¶”ê°€..." />
        <button id="quickAddBtn">ì¶”ê°€</button>
      </div>

      <!-- Today Actions List -->
      <ul class="action-list" id="todayList"></ul>
      <div class="all-clear" id="todayClear" style="display:none">
        <div class="icon">ğŸŸ¢</div>
        <div class="msg">ì˜¤ëŠ˜ í•  ì¼ ì—†ìŒ</div>
        <div class="sub">ìƒˆ Actionì„ ì¶”ê°€í•˜ê±°ë‚˜ Initiativeì—ì„œ ì „í™˜í•˜ì„¸ìš”</div>
      </div>
      <div class="more-btn" id="todayMore" style="display:none"></div>
    </div>

    <!-- â•â•â• THIS WEEK / OVERDUE â•â•â• -->
    <div class="card" id="weekCard">
      <!-- Overdue Section -->
      <div class="section-summary" id="overdueToggle" style="display:none">
        <span class="s-icon">ğŸ”´</span>
        <span class="s-label">Overdue</span>
        <span class="s-count red" id="overdueNum">0</span>
      </div>
      <div class="section-expand" id="overdueExpand">
        <ul class="action-list" id="overdueList"></ul>
      </div>

      <!-- This Week Section -->
      <div class="section-summary" id="weekToggle">
        <span class="s-icon">ğŸ“…</span>
        <span class="s-label">This Week</span>
        <span class="s-count blue" id="weekNum">0</span>
      </div>
      <div class="section-expand" id="weekExpand">
        <ul class="action-list" id="weekList"></ul>
      </div>

      <!-- This Month Section -->
      <div class="section-summary" id="monthToggle">
        <span class="s-icon">ğŸ“†</span>
        <span class="s-label">This Month</span>
        <span class="s-count muted" id="monthNum">0</span>
      </div>
      <div class="section-expand" id="monthExpand">
        <ul class="action-list" id="monthList"></ul>
      </div>
    </div>

    <!-- â•â•â• TIMELINE â•â•â• -->
    <div class="card">
      <div class="card-header">
        <h2>ìµœê·¼ í™œë™</h2>
        <span id="tlCount" class="count"></span>
      </div>
      <div class="tl-filters">
        <button id="btnTlAll" class="filter-btn active">ì „ì²´</button>
        <button id="btnTlPurchase" class="filter-btn">êµ¬ë§¤</button>
        <button id="btnTlSale" class="filter-btn">ë§¤ì¶œ</button>
        <button id="btnTlWork" class="filter-btn">ì—…ë¬´</button>
      </div>
      <ul id="timeline" class="timeline"></ul>
    </div>

    <!-- â•â•â• KPI (ìµœí•˜ë‹¨) â•â•â• -->
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
      <div class="kpi-card"><div class="t">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div><div class="v" id="kSales" style="color:var(--orange)">â‚©0</div></div>
      <div class="kpi-card"><div class="t">ì´ë²ˆ ë‹¬ ë§¤ì…</div><div class="v" id="kPurchase" style="color:var(--primary)">â‚©0</div></div>
      <div class="kpi-card"><div class="t">ë§ˆì§„</div><div class="v" id="kMargin" style="color:var(--accent)">â‚©0</div></div>
      <div class="kpi-card"><div class="t">í™œì„± ê±°ë˜ì²˜</div><div class="v" id="kVendors">0</div></div>
    </div>
  </main>

  <!-- RIGHT: Calendar + Quick KPI -->
  <aside class="right">
    <div class="cal-card">
      <div class="cal-header">
        <button class="cal-nav" id="calPrev">â—€</button>
        <a id="calTitle" href="./calendar.html">2026ë…„ 2ì›”</a>
        <button class="cal-nav" id="calNext">â–¶</button>
      </div>
      <div class="cal-grid" id="calGrid"></div>
    </div>

    <div class="kpi-stack">
      <div class="kpi-card"><div class="t">Overdue</div><div class="v" id="rOverdue" style="color:var(--warn)">0</div></div>
      <div class="kpi-card"><div class="t">This Week</div><div class="v" id="rWeek" style="color:var(--primary)">0</div></div>
      <div class="kpi-card"><div class="t">Completed (ì´ë²ˆ ë‹¬)</div><div class="v" id="rCompleted" style="color:var(--accent)">0</div></div>
    </div>
  </aside>
</div>

<!-- â•â•â• ACTION MODAL â•â•â• -->
<div class="modal-overlay" id="actionModal">
  <div class="modal">
    <h3 id="actModalTitle">Action ì¶”ê°€</h3>
    <label>ì œëª©</label>
    <input id="actTitle" placeholder="í•  ì¼ ì…ë ¥..." />
    <label>ë§ˆê°ì¼</label>
    <input id="actDate" type="date" />
    <label>ìš°ì„ ìˆœìœ„</label>
    <select id="actPriority">
      <option value="NORMAL">ë³´í†µ</option>
      <option value="HIGH">ë†’ìŒ</option>
      <option value="LOW">ë‚®ìŒ</option>
    </select>
    <label>ê±°ë˜ì²˜ (ì„ íƒ)</label>
    <input id="actVendor" list="dlVendors" placeholder="ì—…ì²´ëª…" />
    <datalist id="dlVendors"></datalist>
    <div class="modal-btns">
      <button id="actDelete" class="btn-danger" style="display:none">ì‚­ì œ</button>
      <span style="flex:1"></span>
      <button id="actCancel">ì·¨ì†Œ</button>
      <button id="actSave" class="btn-primary">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â• VENDOR DRAWER â•â•â• -->
<div class="drawer-overlay" id="drawerOverlay"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div class="top-row">
      <h3 id="vpName">ê±°ë˜ì²˜ëª…</h3>
      <button class="drawer-close" id="vpClose">âœ•</button>
    </div>
    <div class="drawer-stats">
      <div class="d-stat"><div class="t">ì´ ê±°ë˜ì•¡</div><div class="v" id="vpTotal">â‚©0</div></div>
      <div class="d-stat"><div class="t">ìµœê·¼ ê±°ë˜ì¼</div><div class="v" id="vpLatest">-</div></div>
      <div class="d-stat"><div class="t">ê±°ë˜ ê±´ìˆ˜</div><div class="v" id="vpCount">0</div></div>
      <div class="d-stat"><div class="t">ë¯¸ì™„ë£Œ Action</div><div class="v" id="vpTasks">0ê±´</div></div>
    </div>
  </div>
  <div class="drawer-tags" id="vpTags"></div>
  <div class="drawer-body">
    <h4>íˆìŠ¤í† ë¦¬</h4>
    <ul id="vpTimeline" class="timeline"></ul>
  </div>
  <div class="drawer-footer" id="vpFooter">
    <h4>ë¯¸ì™„ë£Œ Action</h4>
    <div id="vpTodos"></div>
  </div>
</div>

<!-- â•â•â• RESTORE PANEL â•â•â• -->
<div class="restore-overlay" id="restoreOverlay">
  <div class="restore-panel">
    <h3>ğŸ“¥ ë°±ì—…ì—ì„œ ë³µì›</h3>
    <div class="rp-sub">DRY_RUN ê²°ê³¼ë¥¼ í™•ì¸í•œ ë’¤ COMMITì„ ì‹¤í–‰í•˜ì„¸ìš”</div>

    <!-- ëª¨ë“œ ì„ íƒ -->
    <div class="rp-mode" id="rpMode">
      <label class="active"><input type="radio" name="restoreMode" value="replace" checked /> Replace (ì´ˆê¸°í™” í›„ êµì²´)</label>
      <label><input type="radio" name="restoreMode" value="merge" /> Merge (ê¸°ì¡´ ìœ ì§€ + ë®ì–´ì“°ê¸°)</label>
    </div>

    <!-- DRY_RUN ë¦¬í¬íŠ¸ -->
    <div class="rp-report" id="rpReport">
      <h4>DRY_RUN ë¦¬í¬íŠ¸</h4>
      <div id="rpSummary"></div>
      <div class="rp-capacity" id="rpCapacity"></div>
      <div class="rp-keys" id="rpKeys"></div>
    </div>

    <!-- ë²„íŠ¼ -->
    <div class="rp-btns">
      <button id="rpCancel">ì·¨ì†Œ</button>
      <button class="btn-commit" id="rpCommit">COMMIT ì‹¤í–‰</button>
    </div>
  </div>
</div>

<!-- â•â•â• VENDOR SEARCH â•â•â• -->
<div class="search-overlay" id="searchOverlay">
  <div class="search-modal">
    <label>ê±°ë˜ì²˜ ê²€ìƒ‰</label>
    <input id="searchInput" placeholder="ì—…ì²´ëª… ì…ë ¥..." />
    <ul class="search-results" id="searchResults"></ul>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GoLab Console v1.6 â€” Today Execution Center
   Single Source of Truth: golab_actions_v15
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const $ = id => document.getElementById(id);

/* â”€â”€ Data Keys â”€â”€ */
const ACTION_KEY = "golab_actions_v15";   // â˜… Single Source of Truth (shared with Calendar)
const INIT_KEY = "golab_initiatives_v15"; // Initiatives (read for drawer context)
const TRADE_KEY = "golab_trade_v1";
const SALES_KEY = "golab_sales_v1";
const TRADE_AUDIT = "golab_trade_audit";
const SALES_AUDIT = "golab_sales_audit";
const WORK_AUDIT = "golab_work_audit";
// Legacy (read-only migration)
const LEGACY_TASK_KEY = "golab_worklog_v1";

const TL_LIMIT = 20;

/* â”€â”€ Helpers â”€â”€ */
function uid(){ return crypto.randomUUID(); }
function todayStr(){ return new Date().toISOString().substring(0,10); }
function esc(s){ return (s||"").replace(/</g,"&lt;"); }
function n(v,fb=0){ const x=Number(v); return Number.isFinite(x)?x:fb; }
function fmt(v){ return "â‚©"+Math.round(v).toLocaleString(); }
function monthPrefix(){ return todayStr().substring(0,7); }

function relTime(iso){
  if(!iso) return "";
  const d=iso.substring(0,10), t=todayStr();
  if(d===t) return "ì˜¤ëŠ˜ "+iso.substring(11,16);
  const yd=new Date(new Date(t).getTime()-864e5).toISOString().substring(0,10);
  if(d===yd) return "ì–´ì œ "+iso.substring(11,16);
  return d;
}
function extractHashtags(text){
  if(!text) return [];
  const m=text.match(/#[^\s#]+/g);
  return m?[...new Set(m)]:[];
}

/* â”€â”€ Date Helpers â”€â”€ */
function parseDate(s){ const p=s.split("-"); return new Date(+p[0],+p[1]-1,+p[2]); }
function dateStr(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0"); }

function getEndOfWorkWeek(today){
  const d = typeof today==="string" ? parseDate(today) : new Date(today);
  const dow = d.getDay();
  const daysToFri = dow===0 ? 5 : (dow<=5 ? 5-dow : 5+(7-dow));
  const fri = new Date(d); fri.setDate(fri.getDate()+daysToFri);
  return dateStr(fri);
}
function getEndOfMonth(today){
  const d = typeof today==="string" ? parseDate(today) : new Date(today);
  return dateStr(new Date(d.getFullYear(), d.getMonth()+1, 0));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SINGLE SOURCE: Actions CRUD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadActions(){ try{return JSON.parse(localStorage.getItem(ACTION_KEY)||"[]")}catch{return[]} }
function saveActions(arr){ localStorage.setItem(ACTION_KEY, JSON.stringify(arr)); }

/* â”€â”€ Legacy Migration (one-time, non-destructive) â”€â”€ */
function migrateLegacyTasks(){
  const legacy = JSON.parse(localStorage.getItem(LEGACY_TASK_KEY)||"[]");
  if(!legacy.length) return;
  const actions = loadActions();
  const existingTitles = new Set(actions.map(a=>a.title));
  let migrated = 0;
  legacy.forEach(t => {
    if(existingTitles.has(t.text)) return; // skip duplicates
    actions.push({
      id: t.id || uid(),
      title: t.text || "",
      dueDate: t.due || todayStr(),
      type: "ACTION",
      status: t.done ? "DONE" : "OPEN",
      priority: "NORMAL",
      vendorId: t.vendor || "",
      createdAt: t.createdAt || new Date().toISOString(),
      updatedAt: t.createdAt || new Date().toISOString(),
      doneAt: t.completedAt || null,
      _migratedFrom: "worklog"
    });
    migrated++;
  });
  if(migrated > 0) saveActions(actions);
}
migrateLegacyTasks();

/* â”€â”€ Dynamic Escalation (same logic as Calendar) â”€â”€ */
function classifyActions(){
  const today = todayStr();
  const eow = getEndOfWorkWeek(today);
  const eom = getEndOfMonth(today);
  const actions = loadActions();
  const buckets = { overdue:[], today:[], week:[], month:[], completed:[], future:[] };
  const d = new Date();
  const mp = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");

  actions.forEach(a => {
    if(a.status === "DONE"){
      const doneAt = a.doneAt || a.updatedAt || "";
      if(doneAt.startsWith(mp)) buckets.completed.push(a);
      return;
    }
    if(a.dueDate < today) buckets.overdue.push(a);
    else if(a.dueDate === today) buckets.today.push(a);
    else if(a.dueDate <= eow) buckets.week.push(a);
    else if(a.dueDate <= eom) buckets.month.push(a);
    else buckets.future.push(a);
  });

  // Sort each bucket: HIGH first, then dueDate asc, then createdAt desc
  const priOrder = {HIGH:0, NORMAL:1, LOW:2};
  const sortFn = (a,b) => (priOrder[a.priority]||1)-(priOrder[b.priority]||1) || (a.dueDate||"").localeCompare(b.dueDate||"") || (b.createdAt||"").localeCompare(a.createdAt||"");
  Object.values(buckets).forEach(arr => arr.sort(sortFn));

  return buckets;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TODAY ZONE RENDER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TODAY_MAX = 3;
let showAllToday = false;

function renderTodayZone(){
  const b = classifyActions();
  const todayItems = [...b.overdue, ...b.today]; // Overdue + Today merged for display
  const today = todayStr();

  // Header badges
  $("todayDate").textContent = today;
  const activeCount = b.overdue.length + b.today.length;
  $("todayCount").textContent = activeCount + "ê±´";

  if(b.overdue.length > 0){
    $("overdueCount").style.display = "inline";
    $("overdueCount").textContent = "ì§€ì—° " + b.overdue.length;
  } else {
    $("overdueCount").style.display = "none";
  }

  // List
  const ul = $("todayList");
  const clear = $("todayClear");
  const moreBtn = $("todayMore");

  if(!todayItems.length){
    ul.innerHTML = "";
    clear.style.display = "block";
    moreBtn.style.display = "none";
    return;
  }

  clear.style.display = "none";
  const visible = showAllToday ? todayItems : todayItems.slice(0, TODAY_MAX);
  const remaining = todayItems.length - TODAY_MAX;

  ul.innerHTML = visible.map(a => renderActionItem(a, today)).join("");
  bindActionItems(ul);

  if(remaining > 0 && !showAllToday){
    moreBtn.style.display = "flex";
    moreBtn.textContent = "+ " + remaining + "ê±´ ë”ë³´ê¸°";
    moreBtn.onclick = () => { showAllToday = true; renderTodayZone(); };
  } else {
    if(showAllToday && todayItems.length > TODAY_MAX){
      moreBtn.style.display = "flex";
      moreBtn.textContent = "ì ‘ê¸°";
      moreBtn.onclick = () => { showAllToday = false; renderTodayZone(); };
    } else {
      moreBtn.style.display = "none";
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEEK / OVERDUE / MONTH SECTIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSections(){
  const b = classifyActions();
  const today = todayStr();

  // Overdue (separate section below Today Zone)
  if(b.overdue.length > 0){
    $("overdueToggle").style.display = "flex";
    $("overdueNum").textContent = b.overdue.length;
    $("overdueList").innerHTML = b.overdue.map(a => renderActionItem(a, today)).join("");
    bindActionItems($("overdueList"));
  } else {
    $("overdueToggle").style.display = "none";
    $("overdueExpand").classList.remove("open");
  }

  // This Week
  $("weekNum").textContent = b.week.length;
  if(b.week.length){
    $("weekList").innerHTML = b.week.map(a => renderActionItem(a, today)).join("");
    bindActionItems($("weekList"));
  } else {
    $("weekList").innerHTML = '<div style="padding:8px 0;color:var(--muted);font-size:12px">ì´ë²ˆ ì£¼ ì¶”ê°€ Action ì—†ìŒ</div>';
  }

  // This Month
  $("monthNum").textContent = b.month.length;
  if(b.month.length){
    $("monthList").innerHTML = b.month.map(a => renderActionItem(a, today)).join("");
    bindActionItems($("monthList"));
  } else {
    $("monthList").innerHTML = '<div style="padding:8px 0;color:var(--muted);font-size:12px">ì´ë²ˆ ë‹¬ ì¶”ê°€ Action ì—†ìŒ</div>';
  }

  // Right sidebar KPI
  $("rOverdue").textContent = b.overdue.length;
  $("rWeek").textContent = b.week.length;
  $("rCompleted").textContent = b.completed.length;
}

/* â”€â”€ Section Toggle â”€â”€ */
["overdue","week","month"].forEach(key => {
  $(key+"Toggle").onclick = () => {
    const expand = $(key+"Expand");
    expand.classList.toggle("open");
  };
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTION ITEM RENDERER (Shared)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderActionItem(a, today){
  const isDone = a.status === "DONE";
  const isOverdue = !isDone && a.dueDate < today;
  const isToday = !isDone && a.dueDate === today;

  let tags = "";
  if(isOverdue) tags += '<span class="overdue-tag">' + a.dueDate + ' ì§€ì—°</span>';
  else if(isToday) tags += '<span class="today-tag">ì˜¤ëŠ˜ ë§ˆê°</span>';
  else if(a.dueDate) tags += '<span>' + a.dueDate + '</span>';

  if(a.vendorId) tags += '<span class="vendor-tag" data-vendor="'+esc(a.vendorId)+'">'+esc(a.vendorId)+'</span>';
  if(a.priority && a.priority !== "NORMAL") tags += '<span class="pri-badge '+a.priority+'">'+a.priority+'</span>';

  return `<li class="action-item${isDone?' completed':''}">
    <div class="chk${isDone?' done':''}" data-toggle="${a.id}">${isDone?'âœ“':''}</div>
    <div class="act-body" data-edit="${a.id}">
      <div class="act-title">${esc(a.title)}</div>
      <div class="act-meta">${tags}</div>
    </div>
    <button class="act-del" data-del="${a.id}">âœ•</button>
  </li>`;
}

function bindActionItems(container){
  container.querySelectorAll("[data-toggle]").forEach(el => {
    el.onclick = e => { e.stopPropagation(); toggleAction(el.dataset.toggle); };
  });
  container.querySelectorAll("[data-edit]").forEach(el => {
    el.onclick = () => openActionModal(el.dataset.edit);
  });
  container.querySelectorAll("[data-del]").forEach(el => {
    el.onclick = e => { e.stopPropagation(); if(confirm("ì‚­ì œ?")) deleteAction(el.dataset.del); };
  });
  container.querySelectorAll("[data-vendor]").forEach(el => {
    el.onclick = e => { e.stopPropagation(); openDrawer(el.dataset.vendor); };
  });
}

/* â”€â”€ Action Toggle/Delete â”€â”€ */
function toggleAction(id){
  const actions = loadActions();
  const a = actions.find(x => x.id === id);
  if(!a) return;
  if(a.status === "DONE"){ a.status = "OPEN"; a.doneAt = null; }
  else { a.status = "DONE"; a.doneAt = new Date().toISOString(); }
  a.updatedAt = new Date().toISOString();
  saveActions(actions);
  emitWorkAudit(a.status==="DONE"?"COMPLETE":"REOPEN", {id:a.id, text:a.title, vendor:a.vendorId});
  renderAll();
}

function deleteAction(id){
  const actions = loadActions();
  const a = actions.find(x => x.id === id);
  if(a) emitWorkAudit("DELETE", {id, text:a.title, vendor:a.vendorId});
  saveActions(actions.filter(x => x.id !== id));
  renderAll();
}

/* â”€â”€ Quick Add â”€â”€ */
$("quickAddBtn").onclick = quickAdd;
$("quickInput").addEventListener("keydown", e => { if(e.key==="Enter") quickAdd(); });

function quickAdd(){
  const title = $("quickInput").value.trim();
  if(!title){ $("quickInput").focus(); return; }
  const actions = loadActions();
  const a = {
    id: uid(), title, dueDate: todayStr(),
    type: "ACTION", status: "OPEN", priority: "NORMAL",
    vendorId: "", createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  actions.push(a);
  saveActions(actions);
  emitWorkAudit("CREATE", {id:a.id, text:title, vendor:""});
  $("quickInput").value = "";
  renderAll();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTION MODAL (Full CRUD)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let editingActionId = null;

function openActionModal(id){
  refreshVendorList();
  if(id){
    editingActionId = id;
    const a = loadActions().find(x => x.id === id);
    if(!a) return;
    $("actModalTitle").textContent = "Action ìˆ˜ì •";
    $("actTitle").value = a.title;
    $("actDate").value = a.dueDate;
    $("actPriority").value = a.priority || "NORMAL";
    $("actVendor").value = a.vendorId || "";
    $("actDelete").style.display = "inline-block";
  } else {
    editingActionId = null;
    $("actModalTitle").textContent = "Action ì¶”ê°€";
    $("actTitle").value = "";
    $("actDate").value = todayStr();
    $("actPriority").value = "NORMAL";
    $("actVendor").value = "";
    $("actDelete").style.display = "none";
  }
  $("actionModal").classList.add("open");
  setTimeout(() => $("actTitle").focus(), 100);
}

function saveActionModal(){
  const title = $("actTitle").value.trim();
  if(!title){ $("actTitle").focus(); return; }
  const actions = loadActions();
  if(editingActionId){
    const a = actions.find(x => x.id === editingActionId);
    if(a){
      a.title = title; a.dueDate = $("actDate").value;
      a.priority = $("actPriority").value; a.vendorId = $("actVendor").value.trim();
      a.updatedAt = new Date().toISOString();
    }
  } else {
    const a = {
      id: uid(), title, dueDate: $("actDate").value || todayStr(),
      type: "ACTION", status: "OPEN", priority: $("actPriority").value || "NORMAL",
      vendorId: $("actVendor").value.trim(), createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    actions.push(a);
    emitWorkAudit("CREATE", {id:a.id, text:title, vendor:a.vendorId});
  }
  saveActions(actions);
  closeActionModal();
  renderAll();
}

function deleteActionModal(){
  if(!editingActionId) return;
  if(!confirm("ì´ Actionì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  const actions = loadActions();
  const a = actions.find(x => x.id === editingActionId);
  if(a) emitWorkAudit("DELETE", {id:a.id, text:a.title, vendor:a.vendorId});
  saveActions(actions.filter(x => x.id !== editingActionId));
  closeActionModal();
  renderAll();
}

function closeActionModal(){
  $("actionModal").classList.remove("open");
  editingActionId = null;
}

$("actCancel").onclick = closeActionModal;
$("actSave").onclick = saveActionModal;
$("actDelete").onclick = deleteActionModal;
$("actionModal").onclick = e => { if(e.target===$("actionModal")) closeActionModal(); };
$("actTitle").addEventListener("keydown", e => { if(e.key==="Enter") saveActionModal(); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMELINE (Legacy audit-based)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let tlFilter = "all";

function emitWorkAudit(event,detail){
  try{
    const log = JSON.parse(localStorage.getItem(WORK_AUDIT)||"[]");
    log.push({event, ts:new Date().toISOString(), detail:detail||{}});
    if(log.length>2000) log.splice(0,log.length-2000);
    localStorage.setItem(WORK_AUDIT, JSON.stringify(log));
  }catch{}
}

function buildTimeline(){
  const items = [];
  try{JSON.parse(localStorage.getItem(TRADE_AUDIT)||"[]").forEach(a=>{
    if(a.event==="IMPORTED") return;
    items.push({type:"purchase",ts:a.ts,event:a.event,vendor:a.detail?.vendor||"",text:fmtAudit("êµ¬ë§¤",a.event,a.detail)});
  });}catch{}
  try{JSON.parse(localStorage.getItem(SALES_AUDIT)||"[]").forEach(a=>{
    if(a.event==="IMPORTED") return;
    items.push({type:"sale",ts:a.ts,event:a.event,vendor:a.detail?.client||"",text:fmtAudit("ë§¤ì¶œ",a.event,a.detail)});
  });}catch{}
  try{JSON.parse(localStorage.getItem(WORK_AUDIT)||"[]").forEach(a=>{
    items.push({type:"work",ts:a.ts,event:a.event,vendor:a.detail?.vendor||"",text:fmtWork(a.event,a.detail)});
  });}catch{}
  items.sort((a,b)=>b.ts.localeCompare(a.ts));
  return items;
}

function fmtAudit(m,ev,d){
  const nm=esc(d?.itemName||"");
  if(ev==="CREATE")return`${m} ë“±ë¡ â€” ${nm}`;
  if(ev==="UPDATE")return`${m} ìˆ˜ì • â€” ${nm}`;
  if(ev==="DELETE")return`${m} ì‚­ì œ â€” ${nm}`;
  return`${m} ${ev}`;
}
function fmtWork(ev,d){
  const tx=esc(d?.text||"");
  if(ev==="CREATE")return`Action ë“±ë¡ â€” ${tx}`;
  if(ev==="COMPLETE")return`Action ì™„ë£Œ â€” ${tx}`;
  if(ev==="REOPEN")return`Action ì¬ê°œ â€” ${tx}`;
  if(ev==="DELETE")return`Action ì‚­ì œ â€” ${tx}`;
  return`Action ${ev}`;
}

function renderTimeline(){
  let items = buildTimeline();
  if(tlFilter!=="all") items = items.filter(x=>x.type===tlFilter);
  const shown = items.slice(0,TL_LIMIT);
  $("tlCount").textContent = items.length+"ê±´";
  const ul = $("timeline"); ul.innerHTML = "";
  if(!shown.length){ ul.innerHTML='<li class="tl-item"><div class="tl-body"><div class="tl-text" style="color:var(--muted);padding:16px 0">í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div></div></li>'; return; }
  shown.forEach(it=>{
    const li=document.createElement("li"); li.className="tl-item";
    const vl=it.vendor?`<span class="vendor-link" data-vendor="${esc(it.vendor)}">[${esc(it.vendor)}]</span> `:"";
    li.innerHTML=`<div class="tl-dot ${it.type}"></div><div class="tl-body"><div class="tl-text">${vl}${it.text}</div><div class="tl-time">${relTime(it.ts)}</div></div>`;
    ul.appendChild(li);
  });
  ul.querySelectorAll("[data-vendor]").forEach(el=>{el.onclick=()=>openDrawer(el.dataset.vendor);});
  document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
  const map={all:"btnTlAll",purchase:"btnTlPurchase",sale:"btnTlSale",work:"btnTlWork"};
  if(map[tlFilter]) $(map[tlFilter]).classList.add("active");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MONTHLY KPI (â‚© í†µì¼)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function computeKPI(){
  const mp = monthPrefix();
  let sT=0, pT=0; const allV=new Set();
  try{JSON.parse(localStorage.getItem(SALES_KEY)||"[]").forEach(r=>{
    if((r.salesDate||"").startsWith(mp)){sT+=n(r.sellUnitPrice)*n(r.qty); if(r.client) allV.add(r.client);}
  });}catch{}
  try{JSON.parse(localStorage.getItem(TRADE_KEY)||"[]").forEach(r=>{
    if((r.purchaseDate||"").startsWith(mp)){pT+=n(r.buyUnitPrice)*n(r.qty); if(r.vendor) allV.add(r.vendor);}
  });}catch{}
  const margin = sT - pT;
  $("kSales").textContent = fmt(sT);
  $("kPurchase").textContent = fmt(pT);
  $("kMargin").textContent = fmt(margin);
  $("kMargin").style.color = margin >= 0 ? "var(--accent)" : "var(--warn)";
  $("kVendors").textContent = allV.size;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MINI CALENDAR (Right sidebar)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let calYear, calMonth;
(function(){ const d=new Date(); calYear=d.getFullYear(); calMonth=d.getMonth(); })();

function renderMiniCal(){
  const mNames=["1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”","7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"];
  const calLink=$("calTitle");
  calLink.textContent=calYear+"ë…„ "+mNames[calMonth];
  calLink.href="./calendar.html?y="+calYear+"&m="+(calMonth+1);

  const first=new Date(calYear,calMonth,1);
  const lastDay=new Date(calYear,calMonth+1,0).getDate();
  const startDow=first.getDay();
  const today=todayStr();

  // Action dates for dots
  const actionDates=new Map();
  loadActions().forEach(a => {
    if(!a.dueDate) return;
    if(!actionDates.has(a.dueDate)) actionDates.set(a.dueDate, {open:false, overdue:false});
    const info = actionDates.get(a.dueDate);
    if(a.status !== "DONE"){ info.open = true; if(a.dueDate < today) info.overdue = true; }
  });

  const grid=$("calGrid"); grid.innerHTML="";
  ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "].forEach(d=>{
    const s=document.createElement("div"); s.className="cal-dow"; s.textContent=d; grid.appendChild(s);
  });
  const prevLast=new Date(calYear,calMonth,0).getDate();
  for(let i=startDow-1;i>=0;i--){
    const d=document.createElement("div"); d.className="cal-day"; d.textContent=prevLast-i; grid.appendChild(d);
  }
  for(let day=1;day<=lastDay;day++){
    const d=document.createElement("div");
    const ds=`${calYear}-${String(calMonth+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
    d.className="cal-day current-month";
    if(ds===today) d.classList.add("today");
    const info = actionDates.get(ds);
    if(info && info.open){ d.classList.add("has-action"); if(info.overdue) d.classList.add("has-overdue"); }
    d.textContent=day;
    d.onclick=()=>{window.location.href="./calendar.html?date="+ds;};
    grid.appendChild(d);
  }
  const total=startDow+lastDay, rem=total%7===0?0:7-total%7;
  for(let i=1;i<=rem;i++){
    const d=document.createElement("div"); d.className="cal-day"; d.textContent=i; grid.appendChild(d);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VENDOR DRAWER (uses Action data)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openDrawer(vendor){
  if(!vendor) return;
  $("drawer").classList.add("open"); $("drawerOverlay").classList.add("open");
  $("vpName").textContent = vendor;

  let trades=[], sales=[];
  try{trades=JSON.parse(localStorage.getItem(TRADE_KEY)||"[]").filter(r=>r.vendor===vendor);}catch{}
  try{sales=JSON.parse(localStorage.getItem(SALES_KEY)||"[]").filter(r=>r.client===vendor);}catch{}

  // Actions for this vendor (Single Source of Truth)
  const vendorActions = loadActions().filter(a => a.vendorId === vendor && a.status !== "DONE");

  const tTotal=trades.reduce((s,r)=>s+n(r.buyUnitPrice)*n(r.qty),0);
  const sTotal=sales.reduce((s,r)=>s+n(r.sellUnitPrice)*n(r.qty),0);
  const allDates=[...trades.map(r=>r.purchaseDate),...sales.map(r=>r.salesDate)].filter(Boolean).sort();
  $("vpTotal").textContent=fmt(tTotal+sTotal);
  $("vpLatest").textContent=allDates.length?allDates[allDates.length-1]:"-";
  $("vpCount").textContent=(trades.length+sales.length);
  $("vpTasks").textContent=vendorActions.length+"ê±´";

  // Hashtags
  const allMemos=[...trades.map(r=>r.memo),...sales.map(r=>r.memo),...vendorActions.map(a=>a.title)];
  const tags=new Set();
  allMemos.forEach(m=>extractHashtags(m).forEach(h=>tags.add(h)));
  $("vpTags").innerHTML=[...tags].map(t=>`<span class="htag">${esc(t)}</span>`).join("");

  // Timeline
  const items=buildTimeline().filter(x=>x.vendor===vendor).slice(0,30);
  const ul=$("vpTimeline"); ul.innerHTML="";
  if(!items.length){
    ul.innerHTML='<li class="tl-item"><div class="tl-body"><div class="tl-text" style="color:var(--muted)">ì´ë ¥ ì—†ìŒ</div></div></li>';
  } else {
    items.forEach(it=>{
      const li=document.createElement("li"); li.className="tl-item";
      li.innerHTML=`<div class="tl-dot ${it.type}"></div><div class="tl-body"><div class="tl-text">${it.text}</div><div class="tl-time">${relTime(it.ts)}</div></div>`;
      ul.appendChild(li);
    });
  }

  // Footer: pending actions (from Single Source)
  const todoDiv=$("vpTodos"); todoDiv.innerHTML="";
  if(!vendorActions.length){
    todoDiv.innerHTML='<div style="color:var(--muted);font-size:12px;padding:4px 0">ë¯¸ì™„ë£Œ Action ì—†ìŒ</div>';
  } else {
    vendorActions.forEach(a=>{
      const d=document.createElement("div"); d.className="drawer-todo";
      const overdueTag = a.dueDate < todayStr() ? ' <span style="color:var(--warn);font-size:10px;font-weight:700">ì§€ì—°</span>' : '';
      d.innerHTML=`<div class="dt-dot"></div><span>${esc(a.title)}${overdueTag}</span>`;
      todoDiv.appendChild(d);
    });
  }
}
function closeDrawer(){ $("drawer").classList.remove("open"); $("drawerOverlay").classList.remove("open"); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VENDOR SEARCH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getAllVendors(){
  const v=new Set();
  try{JSON.parse(localStorage.getItem(TRADE_KEY)||"[]").forEach(r=>{if(r.vendor)v.add(r.vendor);});}catch{}
  try{JSON.parse(localStorage.getItem(SALES_KEY)||"[]").forEach(r=>{if(r.client)v.add(r.client);});}catch{}
  loadActions().forEach(a=>{if(a.vendorId)v.add(a.vendorId);});
  return[...v].sort();
}
function refreshVendorList(){
  const dl=$("dlVendors"); dl.innerHTML="";
  getAllVendors().forEach(v=>{const o=document.createElement("option"); o.value=v; dl.appendChild(o);});
}
function openSearch(){
  $("searchOverlay").classList.add("open");
  $("searchInput").value=""; $("searchInput").focus();
  renderSearchResults("");
}
function closeSearch(){ $("searchOverlay").classList.remove("open"); }
function renderSearchResults(q){
  const all=getAllVendors();
  const filtered=q?all.filter(v=>v.toLowerCase().includes(q.toLowerCase())):all;
  const ul=$("searchResults"); ul.innerHTML="";
  filtered.slice(0,20).forEach(v=>{
    const li=document.createElement("li");
    li.textContent=v;
    li.onclick=()=>{closeSearch();openDrawer(v);};
    ul.appendChild(li);
  });
  if(!filtered.length) ul.innerHTML='<li style="padding:10px;color:var(--muted);font-size:12px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</li>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER ALL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAll(){
  renderTodayZone();
  renderSections();
  renderTimeline();
  computeKPI();
  renderMiniCal();
}

/* â”€â”€ Event Bindings â”€â”€ */
$("btnQuickTask").onclick = () => openActionModal(null);
$("btnQuickSearch").onclick = openSearch;
$("searchOverlay").onclick = e => { if(e.target===$("searchOverlay")) closeSearch(); };
$("searchInput").addEventListener("input", e => renderSearchResults(e.target.value));

$("btnTlAll").onclick=()=>{tlFilter="all";renderTimeline();};
$("btnTlPurchase").onclick=()=>{tlFilter="purchase";renderTimeline();};
$("btnTlSale").onclick=()=>{tlFilter="sale";renderTimeline();};
$("btnTlWork").onclick=()=>{tlFilter="work";renderTimeline();};

$("vpClose").onclick = closeDrawer;
$("drawerOverlay").onclick = closeDrawer;

$("calPrev").onclick=()=>{calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderMiniCal();};
$("calNext").onclick=()=>{calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderMiniCal();};

document.addEventListener("keydown",e=>{
  if(e.key==="Escape"){ closeActionModal(); closeDrawer(); closeSearch(); closeRestorePanel(); }
});

/* â”€â”€ í¬ë¡œìŠ¤íƒ­ ë™ê¸°í™”: ë‹¤ë¥¸ íƒ­(calendar)ì—ì„œ ACTION ë³€ê²½ ì‹œ ìë™ ë°˜ì˜ â”€â”€ */
window.addEventListener("storage", e => { if(e.key === ACTION_KEY) renderAll(); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA MANAGEMENT â€” ì „ì²´ ë°±ì—…/ë³µì›
   (golab_ ì ‘ë‘ì‚¬ í‚¤ ì „ìˆ˜ ìŠ¤ìº”)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ golab_ í‚¤ ì „ìˆ˜ ìŠ¤ìº” ìœ í‹¸ â”€â”€ */
function scanGolabKeys(){
  const keys = [];
  for(let i=0; i<localStorage.length; i++){
    const k = localStorage.key(i);
    if(k && k.startsWith("golab_")) keys.push(k);
  }
  return keys.sort();
}

/* â”€â”€ ìš©ëŸ‰ ê³„ì‚° (bytes) â”€â”€ */
function calcStorageBytes(keys){
  let total = 0;
  keys.forEach(k => {
    const v = localStorage.getItem(k) || "";
    total += new Blob([k]).size + new Blob([v]).size;
  });
  return total;
}

function fmtBytes(b){
  if(b < 1024) return b + " B";
  if(b < 1048576) return (b/1024).toFixed(1) + " KB";
  return (b/1048576).toFixed(2) + " MB";
}

/* â”€â”€ ë°ì´í„° ê´€ë¦¬ íŒ¨ë„ í† ê¸€ â”€â”€ */
$("dmToggle").onclick = () => {
  $("dmToggle").classList.toggle("open");
  $("dmBody").classList.toggle("open");
  if($("dmBody").classList.contains("open")) refreshDmInfo();
};

function refreshDmInfo(){
  const keys = scanGolabKeys();
  const bytes = calcStorageBytes(keys);
  $("dmSize").textContent = fmtBytes(bytes);
  $("dmKeyCount").textContent = keys.length;
}

/* â”€â”€ ì „ì²´ ë°±ì—… (Full Backup) â”€â”€ */
$("btnFullBackup").onclick = function(){
  const keys = scanGolabKeys();
  if(!keys.length){ alert("ë°±ì—…í•  golab_ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

  // golab_ í‚¤ ì „ìˆ˜ ìˆ˜ì§‘
  const data = {};
  keys.forEach(k => {
    try{ data[k] = JSON.parse(localStorage.getItem(k)); }
    catch{ data[k] = localStorage.getItem(k); }
  });

  const totalBytes = calcStorageBytes(keys);
  const now = new Date();
  const ts = now.toISOString().replace(/[-:]/g,"").replace("T","_").substring(0,15);
  const filename = `GoLab_FullBackup_${ts}.json`;

  // ë©”íƒ€ ì •ë³´ í¬í•¨
  const payload = {
    _meta: {
      version: "1.6.1",
      timestamp: now.toISOString(),
      keyCount: keys.length,
      totalBytes: totalBytes
    },
    keys: data
  };

  // Blob ë‹¤ìš´ë¡œë“œ
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);

  // audit ê¸°ë¡: FULL_BACKUP
  emitWorkAudit("FULL_BACKUP", { keyCount: keys.length, totalBytes, filename });

  alert(`ì „ì²´ ë°±ì—… ì™„ë£Œ!\n\ní‚¤: ${keys.length}ê°œ\nìš©ëŸ‰: ${fmtBytes(totalBytes)}\níŒŒì¼: ${filename}`);
  refreshDmInfo();
};

/* â”€â”€ ë³µì›: íŒŒì¼ ì„ íƒ â†’ DRY_RUN â”€â”€ */
var restorePayload = null; // íŒŒì‹±ëœ ë°±ì—… ë°ì´í„° ë³´ê´€ (var: ì½˜ì†” í…ŒìŠ¤íŠ¸ ì ‘ê·¼ í—ˆìš©)

$("btnFullRestore").onclick = () => $("restoreFileIn").click();

$("restoreFileIn").addEventListener("change", e => {
  const f = e.target.files?.[0];
  if(!f) return;
  e.target.value = "";

  const reader = new FileReader();
  reader.onload = ev => {
    try{
      const parsed = JSON.parse(ev.target.result);

      // ê²€ì¦: _meta + keys êµ¬ì¡°
      if(!parsed._meta || !parsed.keys || typeof parsed.keys !== "object"){
        alert("ì˜¬ë°”ë¥¸ GoLab ì „ì²´ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.\n(_meta + keys êµ¬ì¡° í•„ìš”)");
        return;
      }

      restorePayload = parsed;
      runDryRun();
    }catch(err){
      alert("JSON íŒŒì‹± ì‹¤íŒ¨:\n" + err.message);
    }
  };
  reader.readAsText(f);
});

/* â”€â”€ DRY_RUN ë¦¬í¬íŠ¸ ìƒì„± â”€â”€ */
function runDryRun(){
  if(!restorePayload) return;

  const backupKeys = Object.keys(restorePayload.keys).filter(k => k.startsWith("golab_")).sort();
  const currentKeys = scanGolabKeys();
  const mode = getRestoreMode();

  const backupSet = new Set(backupKeys);
  const currentSet = new Set(currentKeys);

  // í‚¤ ë¶„ë¥˜
  const overwrite = []; // ë°±ì—…ì—ë„ ìˆê³  í˜„ì¬ì—ë„ ìˆìŒ
  const add = [];       // ë°±ì—…ì— ìˆê³  í˜„ì¬ì— ì—†ìŒ
  const extra = [];     // í˜„ì¬ì— ìˆê³  ë°±ì—…ì— ì—†ìŒ

  backupKeys.forEach(k => {
    if(currentSet.has(k)) overwrite.push(k);
    else add.push(k);
  });
  currentKeys.forEach(k => {
    if(!backupSet.has(k)) extra.push(k);
  });

  // ìš©ëŸ‰ ê³„ì‚°
  let estimatedBytes = 0;
  backupKeys.forEach(k => {
    const v = JSON.stringify(restorePayload.keys[k]) || "";
    estimatedBytes += new Blob([k]).size + new Blob([v]).size;
  });
  if(mode === "merge"){
    extra.forEach(k => {
      const v = localStorage.getItem(k) || "";
      estimatedBytes += new Blob([k]).size + new Blob([v]).size;
    });
  }

  // ë¦¬í¬íŠ¸ ë Œë”ë§
  const extraLabel = mode === "replace"
    ? `ğŸ”´ ì‚­ì œë¨: ${extra.length}ê°œ í‚¤`
    : `ğŸŸ¢ ìœ ì§€ë¨: ${extra.length}ê°œ í‚¤`;

  $("rpSummary").innerHTML = `
    <div class="rp-row"><span class="rp-icon">âœ…</span><span class="rp-label">ë®ì–´ì“°ê¸°</span><span class="rp-count">${overwrite.length}ê°œ í‚¤</span></div>
    <div class="rp-row"><span class="rp-icon">â•</span><span class="rp-label">ìƒˆë¡œ ì¶”ê°€</span><span class="rp-count">${add.length}ê°œ í‚¤</span></div>
    <div class="rp-row"><span class="rp-icon">${mode==="replace"?"ğŸ”´":"ğŸŸ¢"}</span><span class="rp-label">${mode==="replace"?"ì‚­ì œë¨":"ìœ ì§€ë¨"}</span><span class="rp-count">${extra.length}ê°œ í‚¤</span></div>
  `;

  // ìš©ëŸ‰ ê°€ë“œ
  const MB5 = 5 * 1024 * 1024;
  const MB4_5 = 4.5 * 1024 * 1024;
  const capClass = estimatedBytes > MB4_5 ? "rp-capacity warn" : "rp-capacity";
  let capMsg = `ì˜ˆìƒ ìš©ëŸ‰: ${fmtBytes(estimatedBytes)} / 5MB`;
  if(estimatedBytes > MB5) capMsg += " â›” ìš©ëŸ‰ ì´ˆê³¼! ë³µì› ë¶ˆê°€";
  else if(estimatedBytes > MB4_5) capMsg += " âš ï¸ ìš©ëŸ‰ ê²½ê³ ";
  $("rpCapacity").className = capClass;
  $("rpCapacity").textContent = capMsg;

  // COMMIT ë²„íŠ¼ í™œì„±/ë¹„í™œì„±
  $("rpCommit").disabled = (estimatedBytes > MB5);

  // í‚¤ ìƒì„¸ ëª©ë¡
  let keysHtml = "";
  overwrite.forEach(k => {
    keysHtml += `<div class="rp-key-item"><span class="kname">${k}</span><span class="kstatus overwrite">ë®ì–´ì“°ê¸°</span></div>`;
  });
  add.forEach(k => {
    keysHtml += `<div class="rp-key-item"><span class="kname">${k}</span><span class="kstatus add">ì¶”ê°€</span></div>`;
  });
  extra.forEach(k => {
    if(mode === "replace"){
      keysHtml += `<div class="rp-key-item"><span class="kname">${k}</span><span class="kstatus delete">ì‚­ì œë¨</span></div>`;
    } else {
      keysHtml += `<div class="rp-key-item"><span class="kname">${k}</span><span class="kstatus keep">ìœ ì§€ë¨</span></div>`;
    }
  });
  $("rpKeys").innerHTML = keysHtml;

  // ë©”íƒ€ ì •ë³´
  const meta = restorePayload._meta;
  $("rpReport").querySelector("h4").innerHTML = `DRY_RUN ë¦¬í¬íŠ¸ <span style="font-size:10px;color:var(--muted);font-weight:400">(ë°±ì—…: ${meta.timestamp?.substring(0,16)||"?"}, ${meta.keyCount||"?"}í‚¤, ${fmtBytes(meta.totalBytes||0)})</span>`;

  // íŒ¨ë„ í‘œì‹œ
  $("restoreOverlay").classList.add("open");
}

/* â”€â”€ ëª¨ë“œ ì„ íƒ í—¬í¼ â”€â”€ */
function getRestoreMode(){
  const radios = document.querySelectorAll('input[name="restoreMode"]');
  for(const r of radios) if(r.checked) return r.value;
  return "replace";
}

// ëª¨ë“œ ì „í™˜ ì‹œ DRY_RUN ì¬ì‹¤í–‰
$("rpMode").addEventListener("change", e => {
  // active í´ë˜ìŠ¤ í† ê¸€
  $("rpMode").querySelectorAll("label").forEach(l => l.classList.remove("active"));
  e.target.closest("label").classList.add("active");
  if(restorePayload) runDryRun();
});

/* â”€â”€ pre-restore ë°±ì—… (ìë™ ë‹¤ìš´ë¡œë“œ) â”€â”€ */
function downloadPreRestoreBackup(){
  const keys = scanGolabKeys();
  const data = {};
  keys.forEach(k => {
    try{ data[k] = JSON.parse(localStorage.getItem(k)); }
    catch{ data[k] = localStorage.getItem(k); }
  });

  const totalBytes = calcStorageBytes(keys);
  const now = new Date();
  const ts = now.getFullYear()
    + String(now.getMonth()+1).padStart(2,"0")
    + String(now.getDate()).padStart(2,"0")
    + "_" + String(now.getHours()).padStart(2,"0")
    + String(now.getMinutes()).padStart(2,"0")
    + String(now.getSeconds()).padStart(2,"0");
  const filename = `pre_restore_${ts}.json`;

  const payload = {
    _meta: {
      version: "1.6.1",
      timestamp: now.toISOString(),
      keyCount: keys.length,
      totalBytes: totalBytes,
      type: "PRE_RESTORE_BACKUP"
    },
    keys: data
  };

  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);

  // audit: BACKUP_PRE_RESTORE
  emitWorkAudit("BACKUP_PRE_RESTORE", { keyCount: keys.length, totalBytes, filename });

  return filename;
}

/* â”€â”€ COMMIT ì‹¤í–‰ (3ì¤‘ ì•ˆì „ì¥ì¹˜) â”€â”€ */
$("rpCommit").onclick = function(){
  if(!restorePayload) return;
  const mode = getRestoreMode();

  if(mode === "replace"){
    // â‘  confirm 1íšŒ
    if(!confirm("ì „ì²´ ë°ì´í„°ë¥¼ êµì²´í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    // â‘¡ confirm 2íšŒ
    if(!confirm("ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •ë§ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    // â‘¢ RESET íƒ€ì´í•‘ í™•ì¸
    const input = prompt("ìµœì¢… í™•ì¸: RESETì„ ì…ë ¥í•˜ì„¸ìš”");
    if(input !== "RESET"){
      alert("RESETì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë³µì›ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      return;
    }
  } else {
    // Merge: confirm 1íšŒë§Œ
    if(!confirm(`Merge ëª¨ë“œë¡œ ë³µì›í•©ë‹ˆë‹¤. ${Object.keys(restorePayload.keys).length}ê°œ í‚¤ë¥¼ ë®ì–´ì“°ê¸°/ì¶”ê°€í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  }

  // â‘£ pre-restore ìë™ ë°±ì—…
  const preFile = downloadPreRestoreBackup();

  // â‘¤ ì‹¤í–‰
  const backupKeys = Object.keys(restorePayload.keys).filter(k => k.startsWith("golab_"));
  const currentKeys = scanGolabKeys();
  const backupSet = new Set(backupKeys);

  let deletedKeys = [];
  let overwrittenKeys = [];
  let addedKeys = [];

  try{
    if(mode === "replace"){
      // Replace: ê¸°ì¡´ golab_ í‚¤ ì „ì²´ ì‚­ì œ
      currentKeys.forEach(k => {
        if(!backupSet.has(k)) deletedKeys.push(k);
        else overwrittenKeys.push(k);
        localStorage.removeItem(k);
      });

      // ë°±ì—… í‚¤ ì „ì²´ ì„¸íŒ…
      backupKeys.forEach(k => {
        const val = restorePayload.keys[k];
        localStorage.setItem(k, typeof val === "string" ? val : JSON.stringify(val));
        if(!overwrittenKeys.includes(k)) addedKeys.push(k);
      });
    } else {
      // Merge: ê¸°ì¡´ í‚¤ ìœ ì§€, ë°±ì—… í‚¤ë¡œ ë®ì–´ì“°ê¸°/ì¶”ê°€
      const currentSet = new Set(currentKeys);
      backupKeys.forEach(k => {
        const val = restorePayload.keys[k];
        if(currentSet.has(k)) overwrittenKeys.push(k);
        else addedKeys.push(k);
        localStorage.setItem(k, typeof val === "string" ? val : JSON.stringify(val));
      });
    }

    // â‘¥ audit: FULL_RESTORE
    const totalBytes = calcStorageBytes(scanGolabKeys());
    emitWorkAudit("FULL_RESTORE", {
      mode: mode.toUpperCase(),
      keyCount: backupKeys.length,
      overwritten: overwrittenKeys.length,
      added: addedKeys.length,
      deleted: deletedKeys.length,
      totalBytes,
      preRestoreFile: preFile
    });

    // â‘¦ ì™„ë£Œ ë¦¬í¬íŠ¸
    closeRestorePanel();
    alert(
      `âœ… ë³µì› ì™„ë£Œ! (${mode.toUpperCase()} ëª¨ë“œ)\n\n`
      + `ë®ì–´ì“°ê¸°: ${overwrittenKeys.length}ê°œ\n`
      + `ì¶”ê°€: ${addedKeys.length}ê°œ\n`
      + (mode==="replace" ? `ì‚­ì œ: ${deletedKeys.length}ê°œ\n` : "")
      + `\npre-restore ë°±ì—…: ${preFile}\n\n`
      + `í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.`
    );
    location.reload();

  }catch(err){
    alert("ë³µì› ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n" + err.message + "\n\npre-restore ë°±ì—…(" + preFile + ")ìœ¼ë¡œ ë³µêµ¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  }
};

/* â”€â”€ ë³µì› íŒ¨ë„ ë‹«ê¸° â”€â”€ */
function closeRestorePanel(){
  $("restoreOverlay").classList.remove("open");
  restorePayload = null;
}
$("rpCancel").onclick = closeRestorePanel;
$("restoreOverlay").onclick = e => { if(e.target===$("restoreOverlay")) closeRestorePanel(); };

/* â”€â”€ Init â”€â”€ */
renderAll();
</script>
</body>
</html>
