<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoLab Â· ì½˜ì†”</title>
  <style>
    :root{
      --bg:#f5f7fa;--card:#ffffff;--border:#e5e7eb;
      --text:#0f172a;--text-kpi:#0f172a;--muted:#64748b;
      --primary:#2563eb;--warn:#dc2626;--accent:#16a34a;--orange:#d97706;
      --purple:#7c3aed;--chip:#f8fafc;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size:13px;line-height:1.5}

    /* â”€ Header â”€ */
    header{padding:12px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);z-index:20;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:15px;font-weight:800;color:var(--primary);letter-spacing:-.2px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:6px 10px;border-radius:8px;border:1px solid var(--border);color:var(--muted);text-decoration:none;font-size:11px;font-weight:600;background:transparent;transition:all .15s}
    .tab:hover{color:var(--text);border-color:#cbd5e1}
    .tab.active{color:var(--primary);background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.3)}

    /* â”€ 3-Column Bento â”€ */
    .bento{display:grid;grid-template-columns:200px 1fr 280px;gap:20px;max-width:1440px;margin:0 auto;padding:20px 20px 40px;min-height:calc(100vh - 50px)}

    /* â”€ Left Sidebar â”€ */
    .sidebar{display:flex;flex-direction:column;gap:12px}
    .quick-btn{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;text-decoration:none;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .quick-btn:hover{border-color:rgba(37,99,235,.3);background:rgba(37,99,235,.04)}
    .quick-btn .icon{font-size:16px;width:24px;text-align:center;flex-shrink:0}
    .sidebar-section{margin-top:8px}
    .sidebar-section h4{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding:0 4px}
    .sidebar-stat{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--card);margin-bottom:8px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .sidebar-stat .t{font-size:10px;color:var(--muted);font-weight:600}
    .sidebar-stat .v{font-size:16px;font-weight:900;color:var(--text-kpi);margin-top:4px}

    /* â”€ Center â”€ */
    .center{display:flex;flex-direction:column;gap:20px;min-width:0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .card-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
    .card-header h2{font-size:13px;font-weight:700;color:var(--text)}
    .card-header .badge{font-size:10px;padding:2px 8px;border-radius:6px;font-weight:700}
    .card-header .badge.red{background:#fee2e2;color:var(--warn)}
    .card-header .badge.green{background:#dcfce7;color:var(--accent)}
    .card-header .count{margin-left:auto;font-size:11px;color:var(--muted);font-weight:400}

    /* â”€ Task Input â”€ */
    .task-input{display:flex;gap:8px;margin-bottom:12px}
    .task-input>div{flex:1}
    .task-input .wide{flex:3}
    label{display:block;font-size:10px;color:var(--muted);margin-bottom:3px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
    input,select{width:100%;border-radius:8px;border:1px solid var(--border);background:var(--chip);color:var(--text);padding:8px 10px;font-size:12px;outline:none;transition:border .15s}
    input:focus{border-color:var(--primary)}
    input::placeholder{color:#94a3b8}
    button{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:8px;padding:8px 14px;font-size:12px;cursor:pointer;font-weight:600;transition:all .15s}
    button:hover{border-color:#cbd5e1;background:#f8fafc}
    button.primary{background:var(--primary);border:none;color:#fff}
    button.primary:hover{background:#1d4ed8}
    button.filter-btn{font-size:11px;padding:5px 10px;color:var(--muted)}
    button.filter-btn.active{color:var(--primary);background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.3)}

    /* â”€ Task List â”€ */
    .task-list{list-style:none}
    .task-item{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
    .task-item:last-child{border-bottom:none}
    .check{width:18px;height:18px;border-radius:5px;border:2px solid #cbd5e1;cursor:pointer;flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;transition:all .15s;font-size:10px}
    .check:hover{border-color:var(--accent);background:rgba(22,163,74,.08)}
    .check.done{border-color:var(--accent);background:var(--accent);color:#fff;font-weight:900}
    .task-item.completed{opacity:.35}
    .task-item.completed .task-text{text-decoration:line-through}
    .task-body{flex:1;min-width:0}
    .task-text{font-size:12px;color:var(--text)}
    .task-meta{font-size:10px;color:var(--muted);margin-top:2px;display:flex;gap:8px;align-items:center}
    .vendor-tag{color:var(--primary);cursor:pointer;font-weight:600}
    .vendor-tag:hover{text-decoration:underline}
    .overdue{color:var(--warn);font-weight:700}
    .today-tag{color:var(--orange);font-weight:600}
    .task-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;padding:2px;opacity:.3;margin-top:2px}
    .task-del:hover{opacity:1;color:var(--warn)}
    .empty-msg{text-align:center;padding:20px;color:var(--muted);font-size:12px}

    /* â”€ Timeline â”€ */
    .tl-filters{display:flex;gap:6px;margin-bottom:10px}
    .timeline{list-style:none}
    .tl-item{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
    .tl-item:last-child{border-bottom:none}
    .tl-dot{width:7px;height:7px;border-radius:50%;margin-top:6px;flex-shrink:0}
    .tl-dot.purchase{background:var(--primary)}
    .tl-dot.sale{background:var(--orange)}
    .tl-dot.work{background:var(--purple)}
    .tl-body{flex:1;min-width:0}
    .tl-text{font-size:12px;color:var(--text)}
    .tl-text .vendor-link{color:var(--primary);cursor:pointer;font-weight:600}
    .tl-text .vendor-link:hover{text-decoration:underline}
    .tl-time{font-size:10px;color:var(--muted);margin-top:1px}

    /* â”€ Right Sidebar â”€ */
    .right{display:flex;flex-direction:column;gap:16px}

    /* â”€ Mini Calendar â”€ */
    .cal-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .cal-header span{font-size:12px;font-weight:700;color:var(--text)}
    .cal-header a{font-size:12px;font-weight:700;color:var(--text);text-decoration:none}
    .cal-header a:hover{color:var(--primary);text-decoration:underline}
    .cal-nav{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:2px 6px}
    .cal-nav:hover{color:var(--text)}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center}
    .cal-dow{font-size:9px;color:var(--muted);font-weight:700;padding:4px 0}
    .cal-day{font-size:11px;padding:5px 0;border-radius:6px;cursor:pointer;color:#94a3b8;position:relative}
    .cal-day.current-month{color:var(--text)}
    .cal-day:hover{background:#f1f5f9}
    .cal-day.today{background:transparent;color:var(--primary);font-weight:700;border-radius:6px;border:2px solid var(--primary)}
    .cal-day.has-task{font-weight:700}
    .cal-day.has-task::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--orange)}
    .cal-day.today.has-task::after{background:var(--primary)}

    /* â”€ KPI Cards (Right) â”€ */
    .kpi-stack{display:flex;flex-direction:column;gap:8px}
    .kpi-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px 14px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .kpi-card .t{font-size:10px;color:var(--muted);font-weight:600}
    .kpi-card .v{font-size:24px;font-weight:600;color:var(--text-kpi);margin-top:4px}
    .kpi-card .v.orange{color:var(--orange)}
    .kpi-card .v.blue{color:var(--primary)}
    .kpi-card .v.green{color:var(--accent)}

    /* â”€ Vendor Drawer (40%) â”€ */
    .drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.2);z-index:90}
    .drawer-overlay.open{display:block}
    .drawer{position:fixed;top:0;right:-42%;width:40%;height:100vh;background:var(--bg);border-left:1px solid var(--border);z-index:100;overflow-y:auto;padding:0;transition:right .25s ease}
    .drawer.open{right:0}
    .drawer-header{padding:20px 20px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:2}
    .drawer-header .top-row{display:flex;align-items:center;justify-content:space-between}
    .drawer-header h3{font-size:16px;font-weight:800;color:var(--text)}
    .drawer-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:4px 8px}
    .drawer-close:hover{color:var(--warn)}
    .drawer-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
    .d-stat{padding:10px;background:var(--card);border:1px solid var(--border);border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .d-stat .t{font-size:9px;color:var(--muted);font-weight:700;text-transform:uppercase}
    .d-stat .v{font-size:14px;font-weight:900;margin-top:3px;color:var(--text)}
    .drawer-tags{padding:0 20px;margin-top:12px;display:flex;gap:6px;flex-wrap:wrap}
    .htag{font-size:10px;padding:3px 8px;border-radius:6px;background:rgba(37,99,235,.08);color:var(--primary);font-weight:600}
    .drawer-body{padding:16px 20px}
    .drawer-body h4{font-size:11px;color:var(--muted);font-weight:700;margin-bottom:10px;text-transform:uppercase;letter-spacing:.3px}
    .drawer-footer{padding:16px 20px;border-top:1px solid var(--border)}
    .drawer-footer h4{font-size:11px;color:var(--muted);font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:.3px}
    .drawer-todo{font-size:12px;color:var(--text);padding:6px 0;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center}
    .drawer-todo:last-child{border-bottom:none}
    .drawer-todo .dt-dot{width:6px;height:6px;border-radius:50%;background:var(--orange);flex-shrink:0}

    /* â”€ Responsive â”€ */
    @media(max-width:1280px){
      .bento{grid-template-columns:1fr 280px}
      .sidebar{display:none}
    }
    @media(max-width:900px){
      .bento{grid-template-columns:1fr;padding:12px}
      .right{display:none}
      .task-input{flex-direction:column}
      .drawer{width:100%;right:-102%}
    }
  </style>
</head>
<body>
<header>
  <h1>GoLab</h1>
  <nav class="tabs">
    <a class="tab active" href="./console.html">ì½˜ì†”</a>
    <a class="tab" href="./purchases.html">ì…ê³ /ì›ê°€</a>
    <a class="tab" href="./index.html">ì¬ê³ </a>
    <a class="tab" href="./trade.html">êµ¬ë§¤ ì´ë ¥</a>
    <a class="tab" href="./sales.html">ë§¤ì¶œ</a>
    <a class="tab" href="./calendar.html">ìº˜ë¦°ë”</a>
  </nav>
</header>

<div class="bento">
  <!-- LEFT: Quick Menu -->
  <aside class="sidebar">
    <a class="quick-btn" href="./trade.html"><span class="icon">ğŸ“Š</span>êµ¬ë§¤ ë“±ë¡</a>
    <a class="quick-btn" href="./sales.html"><span class="icon">ğŸ’°</span>ë§¤ì¶œ ë“±ë¡</a>
    <button class="quick-btn" id="btnQuickTask"><span class="icon">âœï¸</span>í•  ì¼ ì¶”ê°€</button>
    <button class="quick-btn" id="btnQuickSearch"><span class="icon">ğŸ”</span>ê±°ë˜ì²˜ ê²€ìƒ‰</button>

    <div class="sidebar-section">
      <h4>ì´ë²ˆ ë‹¬</h4>
      <div class="sidebar-stat"><div class="t">ë§¤ì¶œ</div><div class="v" id="sideKpiSales">&yen; 0</div></div>
      <div class="sidebar-stat"><div class="t">ë§¤ì…</div><div class="v" id="sideKpiPurchase">&yen; 0</div></div>
      <div class="sidebar-stat"><div class="t">ë§ˆì§„</div><div class="v" id="sideKpiMargin">&yen; 0</div></div>
    </div>
  </aside>

  <!-- CENTER: Battle + Timeline -->
  <main class="center">
    <!-- Battle Zone -->
    <div class="card">
      <div class="card-header">
        <h2>ì „íˆ¬íŒ</h2>
        <span id="battleBadge" class="badge red" style="display:none"></span>
        <span id="battleCount" class="count"></span>
      </div>
      <div class="task-input" id="taskInputArea">
        <div class="wide">
          <label>ì—…ë¬´</label>
          <input id="taskText" placeholder="Aì—…ì²´ ë‹¨ê°€ í˜‘ì˜ ì „í™”, Bì—…ì²´ ìƒ˜í”Œ ë°œì†¡..." />
        </div>
        <div>
          <label>ê±°ë˜ì²˜</label>
          <input id="taskVendor" list="dlTaskVendor" placeholder="ì—…ì²´ëª…" />
          <datalist id="dlTaskVendor"></datalist>
        </div>
        <div>
          <label>ë§ˆê°ì¼</label>
          <input id="taskDue" type="date" />
        </div>
        <div style="display:flex;align-items:flex-end">
          <button id="btnTaskAdd" class="primary" style="width:100%;white-space:nowrap">ì¶”ê°€</button>
        </div>
      </div>
      <ul id="taskList" class="task-list"></ul>
      <div class="empty-msg" id="taskEmpty" style="display:none">ëª¨ë“  ì—…ë¬´ ì™„ë£Œ!</div>
    </div>

    <!-- Timeline -->
    <div class="card">
      <div class="card-header">
        <h2>ìµœê·¼ í™œë™</h2>
        <span id="tlCount" class="count"></span>
      </div>
      <div class="tl-filters">
        <button id="btnTlAll" class="filter-btn active">ì „ì²´</button>
        <button id="btnTlPurchase" class="filter-btn">êµ¬ë§¤</button>
        <button id="btnTlSale" class="filter-btn">ë§¤ì¶œ</button>
        <button id="btnTlWork" class="filter-btn">ì—…ë¬´</button>
      </div>
      <ul id="timeline" class="timeline"></ul>
    </div>
  </main>

  <!-- RIGHT: Calendar + KPI -->
  <aside class="right">
    <div class="cal-card">
      <div class="cal-header">
        <button class="cal-nav" id="calPrev">â—€</button>
        <a id="calTitle" href="./calendar.html">2026ë…„ 2ì›”</a>
        <button class="cal-nav" id="calNext">â–¶</button>
      </div>
      <div class="cal-grid" id="calGrid"></div>
    </div>

    <div class="kpi-stack">
      <div class="kpi-card"><div class="t">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div><div class="v orange" id="kSales">â‚© 0</div></div>
      <div class="kpi-card"><div class="t">ì´ë²ˆ ë‹¬ ë§¤ì…</div><div class="v blue" id="kPurchase">â‚© 0</div></div>
      <div class="kpi-card"><div class="t">ë§ˆì§„</div><div class="v green" id="kMargin">â‚© 0</div></div>
      <div class="kpi-card"><div class="t">í™œì„± ê±°ë˜ì²˜</div><div class="v" id="kVendors">0</div></div>
    </div>
  </aside>
</div>

<!-- Vendor Drawer -->
<div class="drawer-overlay" id="drawerOverlay"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div class="top-row">
      <h3 id="vpName">ê±°ë˜ì²˜ëª…</h3>
      <button class="drawer-close" id="vpClose">âœ•</button>
    </div>
    <div class="drawer-stats">
      <div class="d-stat"><div class="t">ì´ ê±°ë˜ì•¡</div><div class="v" id="vpTotal">â‚© 0</div></div>
      <div class="d-stat"><div class="t">ìµœê·¼ ê±°ë˜ì¼</div><div class="v" id="vpLatest">-</div></div>
      <div class="d-stat"><div class="t">ê±°ë˜ ê±´ìˆ˜</div><div class="v" id="vpCount">0</div></div>
      <div class="d-stat"><div class="t">ì§„í–‰ ì—…ë¬´</div><div class="v" id="vpTasks">0ê±´</div></div>
    </div>
  </div>
  <div class="drawer-tags" id="vpTags"></div>
  <div class="drawer-body">
    <h4>íˆìŠ¤í† ë¦¬</h4>
    <ul id="vpTimeline" class="timeline"></ul>
  </div>
  <div class="drawer-footer" id="vpFooter">
    <h4>ë¯¸ì™„ë£Œ ì—…ë¬´</h4>
    <div id="vpTodos"></div>
  </div>
</div>

<!-- Vendor Search Modal -->
<div id="searchOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:80;align-items:flex-start;justify-content:center;padding-top:120px">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;width:400px;max-width:90vw;padding:16px">
    <label>ê±°ë˜ì²˜ ê²€ìƒ‰</label>
    <input id="searchInput" placeholder="ì—…ì²´ëª… ì…ë ¥..." style="margin-top:4px" />
    <ul id="searchResults" style="list-style:none;margin-top:10px;max-height:300px;overflow-y:auto"></ul>
  </div>
</div>

<script>
/* â”€â”€ Constants â”€â”€ */
const TASK_KEY="golab_worklog_v1";
const TRADE_AUDIT="golab_trade_audit";
const SALES_AUDIT="golab_sales_audit";
const WORK_AUDIT="golab_work_audit";
const TRADE_KEY="golab_trade_v1";
const SALES_KEY="golab_sales_v1";
const TL_LIMIT=20;
const $=id=>document.getElementById(id);

/* â”€â”€ Helpers â”€â”€ */
function n(v,fb=0){const x=Number(v);return Number.isFinite(x)?x:fb;}
function esc(s){return(s||"").replace(/</g,"&lt;");}
function fmt(v){return"\u20a9"+Math.round(v).toLocaleString();}
function today(){return new Date().toISOString().substring(0,10);}
function monthPrefix(){return today().substring(0,7);}
function relTime(iso){
  if(!iso) return"";
  const d=iso.substring(0,10),t=today();
  if(d===t) return"ì˜¤ëŠ˜ "+iso.substring(11,16);
  const yd=new Date(new Date(t).getTime()-864e5).toISOString().substring(0,10);
  if(d===yd) return"ì–´ì œ "+iso.substring(11,16);
  return d;
}
function extractHashtags(text){
  if(!text) return[];
  const m=text.match(/#[^\s#]+/g);
  return m?[...new Set(m)]:[];
}

/* â”€â”€ TASK (WorkLog) â”€â”€ */
function loadTasks(){try{return JSON.parse(localStorage.getItem(TASK_KEY)||"[]");}catch{return[];}}
function saveTasks(arr){localStorage.setItem(TASK_KEY,JSON.stringify(arr));}

function emitWorkAudit(event,detail){
  try{
    const log=JSON.parse(localStorage.getItem(WORK_AUDIT)||"[]");
    log.push({event,ts:new Date().toISOString(),detail:detail||{}});
    if(log.length>2000) log.splice(0,log.length-2000);
    localStorage.setItem(WORK_AUDIT,JSON.stringify(log));
  }catch(e){}
}

function addTask(){
  const text=$("taskText").value.trim();
  if(!text){$("taskText").focus();return;}
  const vendor=$("taskVendor").value.trim();
  const due=$("taskDue").value||"";
  const task={id:crypto.randomUUID(),text,vendor,due,done:false,createdAt:new Date().toISOString(),completedAt:null};
  const tasks=loadTasks();
  tasks.unshift(task);
  saveTasks(tasks);
  emitWorkAudit("CREATE",{id:task.id,text,vendor});
  $("taskText").value="";$("taskVendor").value="";$("taskDue").value=today();
  renderAll();
}

function toggleTask(id){
  const tasks=loadTasks();const t=tasks.find(x=>x.id===id);if(!t)return;
  t.done=!t.done;t.completedAt=t.done?new Date().toISOString():null;
  emitWorkAudit(t.done?"COMPLETE":"REOPEN",{id:t.id,text:t.text,vendor:t.vendor});
  saveTasks(tasks);renderAll();
}

function deleteTask(id){
  const tasks=loadTasks();const t=tasks.find(x=>x.id===id);
  if(t) emitWorkAudit("DELETE",{id,text:t.text,vendor:t.vendor});
  saveTasks(tasks.filter(x=>x.id!==id));renderAll();
}

function renderTasks(){
  const tasks=loadTasks(),t=today();
  const active=tasks.filter(x=>!x.done),done=tasks.filter(x=>x.done);
  const overdue=active.filter(x=>x.due&&x.due<t);
  const todayT=active.filter(x=>x.due===t);
  const upcoming=active.filter(x=>!x.due||x.due>t);
  const sorted=[...overdue,...todayT,...upcoming,...done.slice(0,3)];

  const badge=$("battleBadge");
  if(overdue.length>0){badge.style.display="inline";badge.className="badge red";badge.textContent="ì§€ì—° "+overdue.length;}
  else if(todayT.length>0){badge.style.display="inline";badge.className="badge green";badge.textContent="ì˜¤ëŠ˜ "+todayT.length;}
  else{badge.style.display="none";}
  $("battleCount").textContent=active.length+"ê±´ ì§„í–‰ ì¤‘";

  const ul=$("taskList");ul.innerHTML="";
  if(sorted.length===0){$("taskEmpty").style.display="block";return;}
  $("taskEmpty").style.display="none";

  sorted.forEach(tk=>{
    const li=document.createElement("li");
    li.className="task-item"+(tk.done?" completed":"");
    const isOD=!tk.done&&tk.due&&tk.due<t;
    const isTD=!tk.done&&tk.due===t;
    let due="";
    if(isOD) due=`<span class="overdue">${tk.due} ì§€ì—°</span>`;
    else if(isTD) due=`<span class="today-tag">ì˜¤ëŠ˜ ë§ˆê°</span>`;
    else if(tk.due&&!tk.done) due=`<span>${tk.due}</span>`;
    const vt=tk.vendor?`<span class="vendor-tag" data-vendor="${esc(tk.vendor)}">${esc(tk.vendor)}</span>`:"";
    li.innerHTML=`
      <div class="check${tk.done?" done":""}" data-toggle="${tk.id}">${tk.done?"âœ“":""}</div>
      <div class="task-body"><div class="task-text">${esc(tk.text)}</div><div class="task-meta">${vt}${due}</div></div>
      <button class="task-del" data-tdel="${tk.id}">âœ•</button>`;
    ul.appendChild(li);
  });
  ul.querySelectorAll("[data-toggle]").forEach(el=>{el.onclick=()=>toggleTask(el.dataset.toggle);});
  ul.querySelectorAll("[data-tdel]").forEach(el=>{el.onclick=e=>{e.stopPropagation();if(confirm("ì‚­ì œ?"))deleteTask(el.dataset.tdel);};});
  ul.querySelectorAll("[data-vendor]").forEach(el=>{el.onclick=e=>{e.stopPropagation();openDrawer(el.dataset.vendor);};});
}

/* â”€â”€ TIMELINE â”€â”€ */
let tlFilter="all";

function buildTimeline(){
  const items=[];
  try{JSON.parse(localStorage.getItem(TRADE_AUDIT)||"[]").forEach(a=>{
    if(a.event==="IMPORTED")return;
    items.push({type:"purchase",ts:a.ts,event:a.event,vendor:a.detail?.vendor||"",text:fmtAudit("êµ¬ë§¤",a.event,a.detail)});
  });}catch(e){}
  try{JSON.parse(localStorage.getItem(SALES_AUDIT)||"[]").forEach(a=>{
    if(a.event==="IMPORTED")return;
    items.push({type:"sale",ts:a.ts,event:a.event,vendor:a.detail?.client||"",text:fmtAudit("ë§¤ì¶œ",a.event,a.detail)});
  });}catch(e){}
  try{JSON.parse(localStorage.getItem(WORK_AUDIT)||"[]").forEach(a=>{
    items.push({type:"work",ts:a.ts,event:a.event,vendor:a.detail?.vendor||"",text:fmtWork(a.event,a.detail)});
  });}catch(e){}
  items.sort((a,b)=>b.ts.localeCompare(a.ts));
  return items;
}
function fmtAudit(m,ev,d){
  const nm=esc(d?.itemName||"");
  if(ev==="CREATE")return`${m} ë“±ë¡ â€” ${nm}`;
  if(ev==="UPDATE")return`${m} ìˆ˜ì • â€” ${nm}`;
  if(ev==="DELETE")return`${m} ì‚­ì œ â€” ${nm}`;
  return`${m} ${ev}`;
}
function fmtWork(ev,d){
  const tx=esc(d?.text||"");
  if(ev==="CREATE")return`ì—…ë¬´ ë“±ë¡ â€” ${tx}`;
  if(ev==="COMPLETE")return`ì—…ë¬´ ì™„ë£Œ â€” ${tx}`;
  if(ev==="REOPEN")return`ì—…ë¬´ ì¬ê°œ â€” ${tx}`;
  if(ev==="DELETE")return`ì—…ë¬´ ì‚­ì œ â€” ${tx}`;
  return`ì—…ë¬´ ${ev}`;
}

function renderTimeline(){
  let items=buildTimeline();
  if(tlFilter!=="all")items=items.filter(x=>x.type===tlFilter);
  const shown=items.slice(0,TL_LIMIT);
  $("tlCount").textContent=items.length+"ê±´";
  const ul=$("timeline");ul.innerHTML="";
  if(!shown.length){ul.innerHTML='<li class="tl-item"><div class="tl-body"><div class="tl-text" style="color:var(--muted);padding:16px 0">í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div></div></li>';return;}
  shown.forEach(it=>{
    const li=document.createElement("li");li.className="tl-item";
    const vl=it.vendor?`<span class="vendor-link" data-vendor="${esc(it.vendor)}">[${esc(it.vendor)}]</span> `:"";
    li.innerHTML=`<div class="tl-dot ${it.type}"></div><div class="tl-body"><div class="tl-text">${vl}${it.text}</div><div class="tl-time">${relTime(it.ts)}</div></div>`;
    ul.appendChild(li);
  });
  ul.querySelectorAll("[data-vendor]").forEach(el=>{el.onclick=()=>openDrawer(el.dataset.vendor);});
  document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
  const map={all:"btnTlAll",purchase:"btnTlPurchase",sale:"btnTlSale",work:"btnTlWork"};
  if(map[tlFilter])$(map[tlFilter]).classList.add("active");
}

/* â”€â”€ MONTHLY KPI â”€â”€ */
function computeKPI(){
  const mp=monthPrefix();
  let sT=0,pT=0;const sV=new Set(),pV=new Set();
  try{JSON.parse(localStorage.getItem(SALES_KEY)||"[]").forEach(r=>{if((r.salesDate||"").startsWith(mp)){sT+=n(r.sellUnitPrice)*n(r.qty);if(r.client)sV.add(r.client);}});}catch{}
  try{JSON.parse(localStorage.getItem(TRADE_KEY)||"[]").forEach(r=>{if((r.purchaseDate||"").startsWith(mp)){pT+=n(r.buyUnitPrice)*n(r.qty);if(r.vendor)pV.add(r.vendor);}});}catch{}
  const allV=new Set([...sV,...pV]),margin=sT-pT;
  $("kSales").textContent=fmt(sT);$("kPurchase").textContent=fmt(pT);
  $("kMargin").textContent=fmt(margin);$("kMargin").style.color=margin>=0?"var(--accent)":"var(--warn)";
  $("kVendors").textContent=allV.size;
  // Sidebar KPI
  if($("sideKpiSales")){$("sideKpiSales").textContent=fmt(sT);$("sideKpiPurchase").textContent=fmt(pT);$("sideKpiMargin").textContent=fmt(margin);$("sideKpiMargin").style.color=margin>=0?"var(--accent)":"var(--warn)";}
}

/* â”€â”€ MINI CALENDAR â”€â”€ */
let calYear,calMonth;
(function initCal(){const d=new Date();calYear=d.getFullYear();calMonth=d.getMonth();})();

function renderCalendar(){
  const mNames=["1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”","7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"];
  const calLink=$("calTitle");
  calLink.textContent=calYear+"ë…„ "+mNames[calMonth];
  calLink.href="./calendar.html?y="+calYear+"&m="+(calMonth+1);
  const first=new Date(calYear,calMonth,1);
  const lastDay=new Date(calYear,calMonth+1,0).getDate();
  let startDow=first.getDay(); // 0=Sun
  const todayStr=today();
  // Task dates for dots
  const taskDates=new Set();
  loadTasks().filter(t=>!t.done&&t.due).forEach(t=>taskDates.add(t.due));

  const grid=$("calGrid");
  grid.innerHTML="";
  const dows=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
  dows.forEach(d=>{const s=document.createElement("div");s.className="cal-dow";s.textContent=d;grid.appendChild(s);});
  // Prev month padding
  const prevLast=new Date(calYear,calMonth,0).getDate();
  for(let i=startDow-1;i>=0;i--){
    const d=document.createElement("div");d.className="cal-day";d.textContent=prevLast-i;grid.appendChild(d);
  }
  // Current month
  for(let day=1;day<=lastDay;day++){
    const d=document.createElement("div");
    const dateStr=`${calYear}-${String(calMonth+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
    d.className="cal-day current-month";
    if(dateStr===todayStr) d.classList.add("today");
    if(taskDates.has(dateStr)) d.classList.add("has-task");
    d.textContent=day;
    d.onclick=()=>{window.location.href="./calendar.html?date="+dateStr;};
    grid.appendChild(d);
  }
  // Next month padding
  const totalCells=startDow+lastDay;
  const remaining=totalCells%7===0?0:7-totalCells%7;
  for(let i=1;i<=remaining;i++){
    const d=document.createElement("div");d.className="cal-day";d.textContent=i;grid.appendChild(d);
  }
}

/* â”€â”€ VENDOR DRAWER â”€â”€ */
function openDrawer(vendor){
  if(!vendor)return;
  $("drawer").classList.add("open");$("drawerOverlay").classList.add("open");
  $("vpName").textContent=vendor;
  let trades=[],sales=[],tasks=[];
  try{trades=JSON.parse(localStorage.getItem(TRADE_KEY)||"[]").filter(r=>r.vendor===vendor);}catch{}
  try{sales=JSON.parse(localStorage.getItem(SALES_KEY)||"[]").filter(r=>r.client===vendor);}catch{}
  try{tasks=loadTasks().filter(t=>t.vendor===vendor&&!t.done);}catch{}

  const tTotal=trades.reduce((s,r)=>s+n(r.buyUnitPrice)*n(r.qty),0);
  const sTotal=sales.reduce((s,r)=>s+n(r.sellUnitPrice)*n(r.qty),0);
  const allDates=[...trades.map(r=>r.purchaseDate),...sales.map(r=>r.salesDate)].filter(Boolean).sort();
  $("vpTotal").textContent=fmt(tTotal+sTotal);
  $("vpLatest").textContent=allDates.length?allDates[allDates.length-1]:"-";
  $("vpCount").textContent=(trades.length+sales.length);
  $("vpTasks").textContent=tasks.length+"ê±´";

  // Hashtags from all memos
  const allMemos=[...trades.map(r=>r.memo),...sales.map(r=>r.memo),...loadTasks().filter(t=>t.vendor===vendor).map(t=>t.text)];
  const tags=new Set();
  allMemos.forEach(m=>extractHashtags(m).forEach(h=>tags.add(h)));
  $("vpTags").innerHTML=[...tags].map(t=>`<span class="htag">${esc(t)}</span>`).join("");

  // Timeline
  const items=buildTimeline().filter(x=>x.vendor===vendor).slice(0,30);
  const ul=$("vpTimeline");ul.innerHTML="";
  if(!items.length){ul.innerHTML='<li class="tl-item"><div class="tl-body"><div class="tl-text" style="color:var(--muted)">ì´ë ¥ ì—†ìŒ</div></div></li>';
  }else{
    items.forEach(it=>{
      const li=document.createElement("li");li.className="tl-item";
      li.innerHTML=`<div class="tl-dot ${it.type}"></div><div class="tl-body"><div class="tl-text">${it.text}</div><div class="tl-time">${relTime(it.ts)}</div></div>`;
      ul.appendChild(li);
    });
  }

  // Footer: pending todos
  const todoDiv=$("vpTodos");todoDiv.innerHTML="";
  if(!tasks.length){todoDiv.innerHTML='<div style="color:var(--muted);font-size:12px;padding:4px 0">ë¯¸ì™„ë£Œ ì—…ë¬´ ì—†ìŒ</div>';
  }else{
    tasks.forEach(t=>{
      const d=document.createElement("div");d.className="drawer-todo";
      d.innerHTML=`<div class="dt-dot"></div><span>${esc(t.text)}</span>`;
      todoDiv.appendChild(d);
    });
  }
}
function closeDrawer(){$("drawer").classList.remove("open");$("drawerOverlay").classList.remove("open");}

/* â”€â”€ VENDOR SEARCH â”€â”€ */
function getAllVendors(){
  const v=new Set();
  try{JSON.parse(localStorage.getItem(TRADE_KEY)||"[]").forEach(r=>{if(r.vendor)v.add(r.vendor);});}catch{}
  try{JSON.parse(localStorage.getItem(SALES_KEY)||"[]").forEach(r=>{if(r.client)v.add(r.client);});}catch{}
  loadTasks().forEach(t=>{if(t.vendor)v.add(t.vendor);});
  return[...v].sort();
}
function openSearch(){
  $("searchOverlay").style.display="flex";
  $("searchInput").value="";
  $("searchInput").focus();
  renderSearchResults("");
}
function closeSearch(){$("searchOverlay").style.display="none";}
function renderSearchResults(q){
  const all=getAllVendors();
  const filtered=q?all.filter(v=>v.toLowerCase().includes(q.toLowerCase())):all;
  const ul=$("searchResults");ul.innerHTML="";
  filtered.slice(0,20).forEach(v=>{
    const li=document.createElement("li");
    li.style.cssText="padding:8px 10px;cursor:pointer;border-radius:6px;font-size:12px;color:var(--text)";
    li.textContent=v;
    li.onmouseenter=()=>li.style.background="rgba(59,130,246,.1)";
    li.onmouseleave=()=>li.style.background="";
    li.onclick=()=>{closeSearch();openDrawer(v);};
    ul.appendChild(li);
  });
  if(!filtered.length) ul.innerHTML='<li style="padding:10px;color:var(--muted);font-size:12px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</li>';
}

/* â”€â”€ Task Vendor AC â”€â”€ */
function refreshTaskVendorAC(){
  const dl=$("dlTaskVendor");dl.innerHTML="";
  getAllVendors().forEach(v=>{const o=document.createElement("option");o.value=v;dl.appendChild(o);});
}

/* â”€â”€ RENDER ALL â”€â”€ */
function renderAll(){
  renderTasks();renderTimeline();computeKPI();renderCalendar();refreshTaskVendorAC();
}

/* â”€â”€ EVENTS â”€â”€ */
$("btnTaskAdd").onclick=addTask;
$("taskText").addEventListener("keydown",e=>{if(e.key==="Enter")addTask();});
$("taskDue").value=today();

$("btnTlAll").onclick=()=>{tlFilter="all";renderTimeline();};
$("btnTlPurchase").onclick=()=>{tlFilter="purchase";renderTimeline();};
$("btnTlSale").onclick=()=>{tlFilter="sale";renderTimeline();};
$("btnTlWork").onclick=()=>{tlFilter="work";renderTimeline();};

$("vpClose").onclick=closeDrawer;
$("drawerOverlay").onclick=closeDrawer;
document.addEventListener("keydown",e=>{if(e.key==="Escape"){closeDrawer();closeSearch();}});

$("calPrev").onclick=()=>{calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderCalendar();};
$("calNext").onclick=()=>{calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderCalendar();};

$("btnQuickTask").onclick=()=>{$("taskText").focus();$("taskText").scrollIntoView({behavior:"smooth"});};
$("btnQuickSearch").onclick=openSearch;
$("searchOverlay").onclick=e=>{if(e.target===$("searchOverlay"))closeSearch();};
$("searchInput").addEventListener("input",e=>renderSearchResults(e.target.value));

/* â”€â”€ INIT â”€â”€ */
renderAll();
</script>
</body>
</html>
