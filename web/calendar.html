<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoLab Â· ìº˜ë¦°ë”</title>
  <style>
    :root{
      --bg:#f5f7fa;--card:#ffffff;--border:#e5e7eb;
      --text:#0f172a;--text-kpi:#0f172a;--muted:#64748b;
      --primary:#2563eb;--warn:#dc2626;--accent:#16a34a;--orange:#d97706;
      --purple:#7c3aed;--chip:#f8fafc;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size:13px;line-height:1.5}

    /* â”€ Header â”€ */
    header{padding:12px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);z-index:20;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:15px;font-weight:800;color:var(--primary);letter-spacing:-.2px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:6px 10px;border-radius:8px;border:1px solid var(--border);color:var(--muted);text-decoration:none;font-size:11px;font-weight:600;background:transparent;transition:all .15s}
    .tab:hover{color:var(--text);border-color:#cbd5e1}
    .tab.active{color:var(--primary);background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.3)}

    /* â”€ Sub-tabs (Calendar / Initiative) â”€ */
    .sub-tabs{display:flex;gap:0;padding:0 20px;border-bottom:1px solid var(--border);background:var(--card)}
    .sub-tab{padding:12px 24px;font-size:13px;font-weight:700;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;user-select:none}
    .sub-tab:hover{color:var(--text)}
    .sub-tab.active{color:var(--primary);border-bottom-color:var(--primary)}

    /* â”€ Section Toggle â”€ */
    .section{display:none}
    .section.active{display:block}

    /* ========================================
       CALENDAR TAB
       ======================================== */

    /* â”€ KPI Summary Cards â”€ */
    .kpi-bar{display:flex;gap:10px;padding:16px 20px;flex-wrap:wrap;max-width:1200px;margin:0 auto}
    .kpi-card{flex:1;min-width:120px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px 16px;cursor:pointer;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.04);text-align:center}
    .kpi-card:hover{border-color:rgba(37,99,235,.3);box-shadow:0 2px 8px rgba(37,99,235,.08)}
    .kpi-card.active{border-color:var(--primary);background:rgba(37,99,235,.04)}
    .kpi-card .kpi-num{font-size:24px;font-weight:600;color:var(--text-kpi)}
    .kpi-card .kpi-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;margin-top:2px}
    .kpi-card.overdue .kpi-num{color:var(--warn)}
    .kpi-card.today .kpi-num{color:var(--primary)}
    .kpi-card.completed .kpi-num{color:var(--accent)}

    /* â”€ Calendar Layout (2-col) â”€ */
    .cal-layout{display:flex;gap:0;max-width:1400px;margin:0 auto;padding:0 20px 40px}
    .cal-left{flex:1;min-width:0}
    .cal-right{width:360px;flex-shrink:0;margin-left:16px}

    /* â”€ Month Navigator â”€ */
    .month-nav{display:flex;align-items:center;justify-content:center;gap:16px;padding:16px 0 8px}
    .month-nav button{background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 14px;font-size:13px;cursor:pointer;font-weight:600;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .month-nav button:hover{border-color:#cbd5e1;background:#f8fafc}
    .month-nav h2{font-size:18px;font-weight:800;color:var(--text);min-width:160px;text-align:center}
    .month-nav .today-btn{font-size:11px;padding:5px 12px;color:var(--primary);border-color:rgba(37,99,235,.3);background:rgba(37,99,235,.06)}
    .month-nav .today-btn:hover{background:rgba(37,99,235,.12)}

    /* â”€ Calendar Grid â”€ */
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .cal-dow{background:#f8fafc;padding:10px 8px;text-align:center;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
    .cal-dow:first-child{color:var(--warn)}
    .cal-dow:last-child{color:var(--primary)}
    .cal-cell{background:#ffffff;min-height:90px;padding:6px 8px;cursor:pointer;transition:background .12s;position:relative;display:flex;flex-direction:column}
    .cal-cell:hover{background:#f1f5f9}
    .cal-cell.other-month{opacity:.3}
    .cal-cell.today{background:rgba(37,99,235,.04);border:2px solid var(--primary)}
    .cal-cell.today::before{content:none}
    .cal-cell.selected{background:rgba(37,99,235,.06);box-shadow:inset 0 0 0 1px var(--primary)}
    .day-num{font-size:12px;font-weight:700;color:var(--text);margin-bottom:4px;display:flex;align-items:center;gap:4px}
    .cal-cell.other-month .day-num{color:#94a3b8}
    .cal-cell.today .day-num{color:var(--primary);font-weight:900}
    .cal-cell:first-child .day-num, .cal-cell:nth-child(7n+1) .day-num{color:var(--warn)}
    .cal-cell:nth-child(7n) .day-num{color:var(--primary)}
    .cal-cell.other-month:first-child .day-num, .cal-cell.other-month:nth-child(7n+1) .day-num,
    .cal-cell.other-month:nth-child(7n) .day-num{color:#94a3b8}

    /* dot indicators */
    .dot-group{display:flex;gap:2px;margin-left:auto}
    .dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
    .dot.action{background:var(--primary)}
    .dot.overdue{background:var(--warn)}
    .dot.done{background:var(--accent)}
    .day-count{font-size:9px;color:var(--muted);font-weight:600}

    /* â”€ Event Chips in Calendar â”€ */
    .evt-list{flex:1;overflow:hidden;display:flex;flex-direction:column;gap:2px}
    .evt-chip{font-size:10px;padding:2px 6px;border-radius:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;font-weight:600;line-height:1.4}
    .evt-chip.action{background:#dbeafe;color:#1e40af}
    .evt-chip.overdue{background:#fee2e2;color:#991b1b}
    .evt-chip.done{background:#f1f5f9;color:#94a3b8;text-decoration:line-through;opacity:.6}
    .evt-chip.event{background:#dbeafe;color:#1e40af}
    .evt-chip.trade,.evt-chip.trade_due{background:#dcfce7;color:#166534}
    .evt-chip.todo,.evt-chip.todo_due{background:#fee2e2;color:#991b1b}
    .evt-chip.todo.done-legacy,.evt-chip.todo_due.done-legacy{background:#f1f5f9;color:#94a3b8;text-decoration:line-through;opacity:.5}
    .evt-more{font-size:9px;color:var(--muted);padding:1px 4px;cursor:pointer}
    .evt-more:hover{color:var(--text)}

    /* â”€ Right Panel (Sticky Detail) â”€ */
    .right-panel{position:sticky;top:70px}
    .panel-card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.04);overflow:hidden}
    .panel-header{padding:16px 18px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .panel-header h3{font-size:15px;font-weight:800;color:var(--text)}
    .panel-header .badge-count{font-size:11px;color:var(--muted);font-weight:600}
    .panel-empty{text-align:center;padding:40px 20px;color:var(--muted);font-size:12px}
    .panel-empty .icon{font-size:28px;margin-bottom:8px}
    .panel-list{max-height:500px;overflow-y:auto}
    .panel-item{display:flex;align-items:flex-start;gap:10px;padding:12px 18px;border-bottom:1px solid var(--border);transition:background .1s}
    .panel-item:last-child{border-bottom:none}
    .panel-item:hover{background:#f8fafc}
    .panel-item .chk{width:18px;height:18px;border-radius:4px;border:2px solid var(--border);cursor:pointer;flex-shrink:0;margin-top:1px;display:flex;align-items:center;justify-content:center;transition:all .15s;background:var(--card)}
    .panel-item .chk:hover{border-color:var(--primary)}
    .panel-item .chk.checked{background:var(--accent);border-color:var(--accent);color:#fff}
    .panel-item .chk.checked::after{content:'âœ“';font-size:11px;font-weight:700}
    .panel-item .item-body{flex:1;min-width:0}
    .panel-item .item-title{font-size:13px;font-weight:600;color:var(--text)}
    .panel-item .item-title.strike{text-decoration:line-through;color:var(--muted)}
    .panel-item .item-meta{font-size:10px;color:var(--muted);margin-top:2px;display:flex;gap:8px}
    .panel-item .pri-badge{font-size:9px;font-weight:700;padding:1px 6px;border-radius:4px;text-transform:uppercase}
    .pri-badge.HIGH{background:#fee2e2;color:#991b1b}
    .pri-badge.LOW{background:#f1f5f9;color:#64748b}
    .panel-add{padding:12px 18px;border-top:1px solid var(--border)}
    .panel-add-row{display:flex;gap:6px}
    .panel-add input{flex:1;border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:12px;outline:none;background:var(--chip);color:var(--text);font-family:inherit}
    .panel-add input:focus{border-color:var(--primary)}
    .panel-add button{background:var(--primary);border:none;color:#fff;border-radius:8px;padding:8px 14px;font-size:12px;cursor:pointer;font-weight:600;white-space:nowrap}
    .panel-add button:hover{background:#1d4ed8}

    /* â”€ Task list filter (below KPI) â”€ */
    .task-filter-section{max-width:1200px;margin:0 auto;padding:0 20px}
    .task-list-filtered{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.04);margin-bottom:16px;display:none}
    .task-list-filtered.open{display:block}
    .tl-header{padding:14px 18px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .tl-header h3{font-size:14px;font-weight:800;color:var(--text)}
    .tl-close{background:none;border:none;font-size:16px;color:var(--muted);cursor:pointer;padding:4px}
    .tl-close:hover{color:var(--warn)}
    .tl-body{max-height:300px;overflow-y:auto}

    /* ========================================
       INITIATIVE TAB (Kanban)
       ======================================== */
    .kanban-toolbar{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;max-width:1400px;margin:0 auto}
    .kanban-toolbar h2{font-size:18px;font-weight:800;color:var(--text)}
    .kanban-toolbar button{background:var(--primary);border:none;color:#fff;border-radius:8px;padding:8px 16px;font-size:12px;cursor:pointer;font-weight:600;transition:all .15s}
    .kanban-toolbar button:hover{background:#1d4ed8}

    .kanban-board{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;padding:0 20px 40px;max-width:1400px;margin:0 auto}
    .kanban-col{background:var(--chip);border:1px solid var(--border);border-radius:10px;min-height:400px;display:flex;flex-direction:column}
    .kanban-col-header{padding:14px 14px 10px;font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
    .kanban-col-header .col-count{background:var(--border);color:var(--text);font-size:10px;padding:2px 8px;border-radius:10px;font-weight:700}
    .kanban-col.idea .kanban-col-header{color:var(--purple)}
    .kanban-col.ready .kanban-col-header{color:var(--orange)}
    .kanban-col.active .kanban-col-header{color:var(--primary)}
    .kanban-col.done .kanban-col-header{color:var(--accent)}
    .kanban-list{flex:1;padding:8px;display:flex;flex-direction:column;gap:8px;min-height:60px}
    .kanban-list.drag-over{background:rgba(37,99,235,.04);border-radius:0 0 10px 10px}

    .k-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px;cursor:grab;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .k-card:hover{border-color:rgba(37,99,235,.3);box-shadow:0 2px 8px rgba(37,99,235,.06)}
    .k-card.dragging{opacity:.5;transform:rotate(2deg)}
    .k-card .k-title{font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px}
    .k-card .k-meta{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .k-card .k-cat{font-size:9px;padding:2px 7px;border-radius:4px;background:rgba(37,99,235,.08);color:var(--primary);font-weight:600}
    .k-card .k-date{font-size:9px;color:var(--muted)}
    .k-card .k-converted{font-size:9px;padding:2px 7px;border-radius:4px;background:#dcfce7;color:#166534;font-weight:600}
    .k-card .k-actions{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}
    .k-card .k-btn{font-size:10px;padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;font-weight:600;transition:all .12s}
    .k-card .k-btn:hover{border-color:#cbd5e1;background:#f8fafc}
    .k-card .k-btn.convert{background:rgba(37,99,235,.08);color:var(--primary);border-color:rgba(37,99,235,.2)}
    .k-card .k-btn.convert:hover{background:rgba(37,99,235,.15)}
    .k-card .k-btn.danger{color:var(--warn);border-color:rgba(220,38,38,.2)}
    .k-card .k-btn.danger:hover{background:#fee2e2}
    .k-card select.status-sel{font-size:10px;padding:3px 6px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;font-weight:600;outline:none}

    /* â”€ Event Form Modal â”€ */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:110;align-items:flex-start;justify-content:center;padding-top:80px}
    .modal-overlay.open{display:flex}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:12px;width:440px;max-width:90vw;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.12)}
    .modal h3{font-size:14px;font-weight:800;color:var(--text);margin-bottom:14px}
    .modal label{display:block;font-size:10px;color:var(--muted);margin-bottom:3px;margin-top:10px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
    .modal input,.modal select,.modal textarea{width:100%;border-radius:8px;border:1px solid var(--border);background:var(--chip);color:var(--text);padding:8px 10px;font-size:12px;outline:none;transition:border .15s;font-family:inherit}
    .modal input:focus,.modal select:focus,.modal textarea:focus{border-color:var(--primary)}
    .modal textarea{resize:vertical;min-height:60px}
    .modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
    .modal-btns button{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:8px;padding:8px 16px;font-size:12px;cursor:pointer;font-weight:600;transition:all .15s}
    .modal-btns button:hover{border-color:#cbd5e1;background:#f8fafc}
    .modal-btns .btn-primary{background:var(--primary);border:none;color:#fff}
    .modal-btns .btn-primary:hover{background:#1d4ed8}
    .modal-btns .btn-danger{color:var(--warn);border-color:rgba(220,38,38,.3)}
    .modal-btns .btn-danger:hover{background:#fee2e2}

    /* â”€ Vendor Tag in Panel â”€ */
    .vendor-tag{color:var(--primary);cursor:pointer;font-weight:600;font-size:10px}
    .vendor-tag:hover{text-decoration:underline}

    /* â”€ Vendor Drawer â”€ */
    .drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.2);z-index:90}
    .drawer-overlay.open{display:block}
    .drawer{position:fixed;top:0;right:-42%;width:40%;height:100vh;background:var(--bg);border-left:1px solid var(--border);z-index:100;overflow-y:auto;padding:0;transition:right .25s ease}
    .drawer.open{right:0}
    .drawer-header{padding:20px 20px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:2}
    .drawer-header .top-row{display:flex;align-items:center;justify-content:space-between}
    .drawer-header h3{font-size:16px;font-weight:800;color:var(--text)}
    .drawer-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:4px 8px}
    .drawer-close:hover{color:var(--warn)}
    .drawer-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
    .d-stat{padding:10px;background:var(--card);border:1px solid var(--border);border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .d-stat .t{font-size:9px;color:var(--muted);font-weight:700;text-transform:uppercase}
    .d-stat .v{font-size:14px;font-weight:900;margin-top:3px;color:var(--text)}
    .drawer-body{padding:16px 20px}
    .drawer-body h4{font-size:11px;color:var(--muted);font-weight:700;margin-bottom:10px;text-transform:uppercase;letter-spacing:.3px}
    .drawer-footer{padding:16px 20px;border-top:1px solid var(--border)}
    .drawer-footer h4{font-size:11px;color:var(--muted);font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:.3px}
    .drawer-todo{font-size:12px;color:var(--text);padding:6px 0;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center}
    .drawer-todo:last-child{border-bottom:none}
    .drawer-todo .dt-dot{width:6px;height:6px;border-radius:50%;background:var(--orange);flex-shrink:0}
    .tl-item{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
    .tl-item:last-child{border-bottom:none}
    .tl-dot{width:7px;height:7px;border-radius:50%;margin-top:6px;flex-shrink:0}
    .tl-dot.purchase{background:var(--primary)}
    .tl-dot.sale{background:var(--orange)}
    .tl-dot.work{background:var(--purple)}
    .tl-text{font-size:12px;color:var(--text)}
    .tl-time{font-size:10px;color:var(--muted);margin-top:1px}
    .timeline{list-style:none}

    /* â”€ Responsive â”€ */
    @media(max-width:1100px){
      .cal-layout{flex-direction:column}
      .cal-right{width:100%;margin-left:0;margin-top:16px}
      .right-panel{position:static}
    }
    @media(max-width:900px){
      .kanban-board{grid-template-columns:repeat(2,1fr)}
      .cal-cell{min-height:70px;padding:4px}
      .day-num{font-size:11px}
      .evt-chip{font-size:9px;padding:1px 4px}
    }
    @media(max-width:600px){
      .kanban-board{grid-template-columns:1fr}
      .cal-cell{min-height:55px}
      .evt-list{display:none}
      .kpi-bar{gap:6px}
      .kpi-card{min-width:80px;padding:10px 8px}
      .kpi-card .kpi-num{font-size:20px}
      .drawer{width:100%;right:-102%}
    }
  </style>
</head>
<body>
<header>
  <h1>GoLab</h1>
  <nav class="tabs">
    <a class="tab" href="./console.html">ğŸ  ì½˜ì†”</a>
    <a class="tab" href="./index.html">ğŸ“¦ ì¬ê³ </a>
    <a class="tab" href="./purchases.html">ğŸ“¥ ì…ê³ </a>
    <a class="tab" href="./sales.html">ğŸ’° ë§¤ì¶œ</a>
    <a class="tab active" href="./calendar.html">ğŸ“… ìº˜ë¦°ë”</a>
    <a class="tab" href="./profit.html">ğŸ“Š ìˆ˜ìµ</a>
  </nav>
</header>

<!-- Sub-tabs: Calendar / Initiative -->
<div class="sub-tabs">
  <div class="sub-tab active" data-section="calendarSection">Calendar</div>
  <div class="sub-tab" data-section="initiativeSection">Initiative</div>
</div>

<!-- ================ CALENDAR SECTION ================ -->
<div class="section active" id="calendarSection">

  <!-- KPI Summary -->
  <div class="kpi-bar" id="kpiBar">
    <div class="kpi-card overdue" data-filter="overdue">
      <div class="kpi-num" id="kpiOverdue">0</div>
      <div class="kpi-label">Overdue</div>
    </div>
    <div class="kpi-card today" data-filter="today">
      <div class="kpi-num" id="kpiToday">0</div>
      <div class="kpi-label">Today</div>
    </div>
    <div class="kpi-card" data-filter="week">
      <div class="kpi-num" id="kpiWeek">0</div>
      <div class="kpi-label">This Week</div>
    </div>
    <div class="kpi-card" data-filter="month">
      <div class="kpi-num" id="kpiMonth">0</div>
      <div class="kpi-label">This Month</div>
    </div>
    <div class="kpi-card completed" data-filter="completed">
      <div class="kpi-num" id="kpiCompleted">0</div>
      <div class="kpi-label">Completed</div>
    </div>
  </div>

  <!-- Filtered Task List (shown when KPI clicked) -->
  <div class="task-filter-section">
    <div class="task-list-filtered" id="filteredList">
      <div class="tl-header">
        <h3 id="filteredTitle">Tasks</h3>
        <button class="tl-close" id="filteredClose">âœ•</button>
      </div>
      <div class="tl-body" id="filteredBody"></div>
    </div>
  </div>

  <!-- 2-Column: Calendar + Right Panel -->
  <div class="cal-layout">
    <div class="cal-left">
      <div class="month-nav">
        <button id="btnPrev">â—€</button>
        <button class="today-btn" id="btnToday">ì˜¤ëŠ˜</button>
        <h2 id="monthTitle">2026ë…„ 2ì›”</h2>
        <button id="btnNext">â–¶</button>
      </div>
      <div class="cal-grid" id="calGrid"></div>
    </div>
    <div class="cal-right">
      <div class="right-panel" id="rightPanel">
        <div class="panel-card">
          <div class="panel-header">
            <h3 id="panelTitle">ì˜¤ëŠ˜</h3>
            <span class="badge-count" id="panelCount">0ê±´</span>
          </div>
          <div class="panel-list" id="panelList">
            <div class="panel-empty" id="panelEmpty">
              <div class="icon">ğŸ“‹</div>
              ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”
            </div>
          </div>
          <div class="panel-add" id="panelAdd">
            <div class="panel-add-row">
              <input id="quickInput" placeholder="Action ì¶”ê°€..." />
              <button id="quickAddBtn">ì¶”ê°€</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================ INITIATIVE SECTION ================ -->
<div class="section" id="initiativeSection">
  <div class="kanban-toolbar">
    <h2>Initiative Board</h2>
    <button id="btnAddInitiative">+ Initiative ì¶”ê°€</button>
  </div>
  <div class="kanban-board" id="kanbanBoard">
    <div class="kanban-col idea" data-status="IDEA">
      <div class="kanban-col-header">ğŸ’¡ Idea <span class="col-count" id="cntIdea">0</span></div>
      <div class="kanban-list" id="listIdea"></div>
    </div>
    <div class="kanban-col ready" data-status="READY">
      <div class="kanban-col-header">ğŸ“‹ Ready <span class="col-count" id="cntReady">0</span></div>
      <div class="kanban-list" id="listReady"></div>
    </div>
    <div class="kanban-col active" data-status="ACTIVE">
      <div class="kanban-col-header">ğŸ”¥ Active <span class="col-count" id="cntActive">0</span></div>
      <div class="kanban-list" id="listActive"></div>
    </div>
    <div class="kanban-col done" data-status="DONE">
      <div class="kanban-col-header">âœ… Done <span class="col-count" id="cntDone">0</span></div>
      <div class="kanban-list" id="listDone"></div>
    </div>
  </div>
</div>

<!-- ================ MODALS ================ -->

<!-- Action Modal (Calendar) -->
<div class="modal-overlay" id="actionModal">
  <div class="modal">
    <h3 id="actionModalTitle">Action ì¶”ê°€</h3>
    <label>ì œëª©</label>
    <input id="actTitle" placeholder="í•  ì¼ ì…ë ¥..." />
    <label>ë§ˆê°ì¼</label>
    <input id="actDate" type="date" />
    <label>ìš°ì„ ìˆœìœ„</label>
    <select id="actPriority">
      <option value="NORMAL">ë³´í†µ</option>
      <option value="HIGH">ë†’ìŒ</option>
      <option value="LOW">ë‚®ìŒ</option>
    </select>
    <label>ê±°ë˜ì²˜ (ì„ íƒ)</label>
    <input id="actVendor" list="dlVendors" placeholder="ì—…ì²´ëª…" />
    <datalist id="dlVendors"></datalist>
    <div class="modal-btns">
      <button id="actDelete" class="btn-danger" style="display:none">ì‚­ì œ</button>
      <span style="flex:1"></span>
      <button id="actCancel">ì·¨ì†Œ</button>
      <button id="actSave" class="btn-primary">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Initiative Modal -->
<div class="modal-overlay" id="initModal">
  <div class="modal">
    <h3 id="initModalTitle">Initiative ì¶”ê°€</h3>
    <label>ì œëª©</label>
    <input id="initTitle" placeholder="ì•„ì´ë””ì–´ / í”„ë¡œì íŠ¸ëª…..." />
    <label>ì¹´í…Œê³ ë¦¬</label>
    <select id="initCategory">
      <option value="">ì—†ìŒ</option>
      <option value="ì˜ì—…">ì˜ì—…</option>
      <option value="êµ¬ë§¤">êµ¬ë§¤</option>
      <option value="ë¦¬ì„œì¹˜">ë¦¬ì„œì¹˜</option>
      <option value="ë¸Œëœë”©">ë¸Œëœë”©</option>
      <option value="ìš´ì˜">ìš´ì˜</option>
      <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    </select>
    <label>ìš°ì„ ìˆœìœ„</label>
    <select id="initPriority">
      <option value="NORMAL">ë³´í†µ</option>
      <option value="HIGH">ë†’ìŒ</option>
      <option value="LOW">ë‚®ìŒ</option>
    </select>
    <div class="modal-btns">
      <button id="initDelete" class="btn-danger" style="display:none">ì‚­ì œ</button>
      <span style="flex:1"></span>
      <button id="initCancel">ì·¨ì†Œ</button>
      <button id="initSave" class="btn-primary">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Convert to Action Modal -->
<div class="modal-overlay" id="convertModal">
  <div class="modal">
    <h3>ì‹¤í–‰ìœ¼ë¡œ ì „í™˜</h3>
    <p style="font-size:12px;color:var(--muted);margin-bottom:10px" id="convertDesc"></p>
    <label>ë§ˆê°ì¼</label>
    <input id="convertDate" type="date" />
    <label>ìš°ì„ ìˆœìœ„</label>
    <select id="convertPriority">
      <option value="NORMAL">ë³´í†µ</option>
      <option value="HIGH">ë†’ìŒ</option>
      <option value="LOW">ë‚®ìŒ</option>
    </select>
    <div class="modal-btns">
      <button id="convertCancel">ì·¨ì†Œ</button>
      <button id="convertSave" class="btn-primary">ì „í™˜</button>
    </div>
  </div>
</div>

<!-- â•â•â• VENDOR DRAWER â•â•â• -->
<div class="drawer-overlay" id="drawerOverlay"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div class="top-row">
      <h3 id="vpName">ê±°ë˜ì²˜ëª…</h3>
      <button class="drawer-close" id="vpClose">âœ•</button>
    </div>
    <div class="drawer-stats">
      <div class="d-stat"><div class="t">ì´ ê±°ë˜ì•¡</div><div class="v" id="vpTotal">â‚©0</div></div>
      <div class="d-stat"><div class="t">ìµœê·¼ ê±°ë˜ì¼</div><div class="v" id="vpLatest">-</div></div>
      <div class="d-stat"><div class="t">ê±°ë˜ ê±´ìˆ˜</div><div class="v" id="vpCount">0</div></div>
      <div class="d-stat"><div class="t">ë¯¸ì™„ë£Œ Action</div><div class="v" id="vpTasks">0ê±´</div></div>
    </div>
  </div>
  <div class="drawer-body">
    <h4>íˆìŠ¤í† ë¦¬</h4>
    <ul id="vpTimeline" class="timeline"></ul>
  </div>
  <div class="drawer-footer" id="vpFooter">
    <h4>ë¯¸ì™„ë£Œ Action</h4>
    <div id="vpTodos"></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   v1.5 Calendar + Initiative Kanban
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const $ = id => document.getElementById(id);
const ACTION_KEY = "golab_actions_v15";
const INIT_KEY = "golab_initiatives_v15";
/* Legacy keys (read-only for calendar display) */
const TASK_KEY = "golab_worklog_v1";
const TRADE_KEY = "golab_trade_v1";
const SALES_KEY = "golab_sales_v1";
const CAL_KEY = "golab_calendar_v1";
const TRADE_AUDIT = "golab_trade_audit";
const SALES_AUDIT = "golab_sales_audit";
const WORK_AUDIT = "golab_work_audit";

/* â”€â”€ Helpers â”€â”€ */
function uid(){ return crypto.randomUUID(); }
function todayStr(){ return new Date().toISOString().substring(0,10); }
function esc(s){ return (s||"").replace(/</g,"&lt;"); }
function n(v,fb=0){ const x=Number(v); return Number.isFinite(x)?x:fb; }

/* â”€â”€ Date Helpers â”€â”€ */
function parseDate(s){ const p=s.split("-"); return new Date(+p[0],+p[1]-1,+p[2]); }
function dateStr(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0"); }

function getEndOfWorkWeek(today){
  // End of work week = Friday of current week (Mon-based)
  const d = typeof today === "string" ? parseDate(today) : new Date(today);
  const dow = d.getDay(); // 0=Sun
  const daysToFri = dow === 0 ? 5 : (dow <= 5 ? 5 - dow : 5 + (7 - dow));
  const fri = new Date(d); fri.setDate(fri.getDate() + daysToFri);
  return dateStr(fri);
}
function getEndOfMonth(today){
  const d = typeof today === "string" ? parseDate(today) : new Date(today);
  const last = new Date(d.getFullYear(), d.getMonth()+1, 0);
  return dateStr(last);
}
function getNextFriday(){
  const d = new Date();
  const dow = d.getDay();
  const daysToFri = dow === 0 ? 5 : (dow <= 5 ? 5 - dow : 5 + (7 - dow));
  if(daysToFri === 0){
    d.setDate(d.getDate()+7);
  } else {
    d.setDate(d.getDate()+daysToFri);
  }
  return dateStr(d);
}

/* â”€â”€ LocalStorage CRUD â”€â”€ */
function loadActions(){ try{return JSON.parse(localStorage.getItem(ACTION_KEY)||"[]")}catch{return[]} }
function saveActions(arr){ localStorage.setItem(ACTION_KEY, JSON.stringify(arr)); }
function loadInitiatives(){ try{return JSON.parse(localStorage.getItem(INIT_KEY)||"[]")}catch{return[]} }
function saveInitiatives(arr){ localStorage.setItem(INIT_KEY, JSON.stringify(arr)); }

/* Legacy data loaders */
function loadLegacyTasks(){ try{return JSON.parse(localStorage.getItem(TASK_KEY)||"[]")}catch{return[]} }
function loadLegacyTrades(){ try{return JSON.parse(localStorage.getItem(TRADE_KEY)||"[]")}catch{return[]} }
function loadLegacySales(){ try{return JSON.parse(localStorage.getItem(SALES_KEY)||"[]")}catch{return[]} }
function loadLegacyCalEvents(){ try{return JSON.parse(localStorage.getItem(CAL_KEY)||"[]")}catch{return[]} }

function fmt(v){ return "â‚©"+Math.round(v).toLocaleString(); }

/* Vendor helpers */
function getAllVendors(){
  const v=new Set();
  try{JSON.parse(localStorage.getItem(TRADE_KEY)||"[]").forEach(r=>{if(r.vendor)v.add(r.vendor);});}catch{}
  try{JSON.parse(localStorage.getItem(SALES_KEY)||"[]").forEach(r=>{if(r.client)v.add(r.client);});}catch{}
  loadActions().forEach(a=>{if(a.vendorId)v.add(a.vendorId);});
  return[...v].sort();
}
function refreshVendorList(){
  const dl=$("dlVendors"); if(!dl) return;
  dl.innerHTML="";
  getAllVendors().forEach(v=>{const o=document.createElement("option"); o.value=v; dl.appendChild(o);});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUB-TAB SWITCHING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll(".sub-tab").forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll(".sub-tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    tab.classList.add("active");
    $(tab.dataset.section).classList.add("active");
    if(tab.dataset.section === "initiativeSection") renderKanban();
  };
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDAR TAB
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let calYear, calMonth, selectedDate = null;
let editingActionId = null;
let activeKpiFilter = null;

function initCalDate(){
  const p = new URLSearchParams(window.location.search);
  const d = new Date();
  if(p.get("date")){ const pts=p.get("date").split("-"); calYear=+pts[0]; calMonth=+pts[1]-1; selectedDate=p.get("date"); }
  else { calYear=d.getFullYear(); calMonth=d.getMonth(); selectedDate=todayStr(); }
}
initCalDate();

/* â”€â”€ Dynamic Escalation â”€â”€ */
function classifyActions(){
  const today = todayStr();
  const eow = getEndOfWorkWeek(today);
  const eom = getEndOfMonth(today);
  const actions = loadActions();
  const buckets = { overdue:[], today:[], week:[], month:[], completed:[] };

  // This month range for completed
  const d = new Date();
  const monthPrefix = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");

  actions.forEach(a => {
    if(a.status === "DONE"){
      const doneAt = a.doneAt || a.updatedAt || "";
      if(doneAt.startsWith(monthPrefix)){
        buckets.completed.push(a);
      }
      return;
    }
    // status == OPEN
    if(a.dueDate < today) buckets.overdue.push(a);
    else if(a.dueDate === today) buckets.today.push(a);
    else if(a.dueDate <= eow) buckets.week.push(a);
    else if(a.dueDate <= eom) buckets.month.push(a);
    // Beyond this month: not shown in KPI
  });

  return buckets;
}

function renderKPI(){
  const b = classifyActions();
  $("kpiOverdue").textContent = b.overdue.length;
  $("kpiToday").textContent = b.today.length;
  $("kpiWeek").textContent = b.week.length;
  $("kpiMonth").textContent = b.month.length;
  $("kpiCompleted").textContent = b.completed.length;
}

/* â”€â”€ KPI card click â†’ filter list â”€â”€ */
document.querySelectorAll(".kpi-card").forEach(card => {
  card.onclick = () => {
    const filter = card.dataset.filter;
    if(activeKpiFilter === filter){
      closeFilteredList();
      return;
    }
    activeKpiFilter = filter;
    document.querySelectorAll(".kpi-card").forEach(c => c.classList.remove("active"));
    card.classList.add("active");
    showFilteredList(filter);
  };
});

function showFilteredList(filter){
  const b = classifyActions();
  const names = { overdue:"Overdue", today:"Today", week:"This Week", month:"This Month", completed:"Completed (This Month)" };
  $("filteredTitle").textContent = names[filter] || filter;
  const items = b[filter] || [];
  const body = $("filteredBody");

  if(!items.length){
    body.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
  } else {
    body.innerHTML = items.map(a => {
      const isDone = a.status === "DONE";
      const priBadge = a.priority && a.priority !== "NORMAL" ? `<span class="pri-badge ${a.priority}">${a.priority}</span>` : "";
      const vendorTag = a.vendorId ? `<span class="vendor-tag" data-vendor="${esc(a.vendorId)}">${esc(a.vendorId)}</span>` : '';
      return `<div class="panel-item">
        <div class="chk ${isDone?"checked":""}" data-id="${a.id}" data-toggle="action"></div>
        <div class="item-body">
          <div class="item-title ${isDone?"strike":""}">${esc(a.title)}</div>
          <div class="item-meta"><span>${a.dueDate}</span>${vendorTag}${priBadge}</div>
        </div>
      </div>`;
    }).join("");
    bindCheckboxes(body);
  }
  $("filteredList").classList.add("open");
}

$("filteredClose").onclick = closeFilteredList;
function closeFilteredList(){
  activeKpiFilter = null;
  $("filteredList").classList.remove("open");
  document.querySelectorAll(".kpi-card").forEach(c => c.classList.remove("active"));
}

/* â”€â”€ Calendar Render â”€â”€ */
function getAllCalendarItems(year, month){
  const prefix = `${year}-${String(month+1).padStart(2,"0")}`;
  const items = [];

  // v1.5 Actions
  loadActions().forEach(a => {
    if((a.dueDate||"").startsWith(prefix)){
      items.push({ id:a.id, type:"action", date:a.dueDate, title:a.title, status:a.status, priority:a.priority, source:"action" });
    }
  });

  // Legacy: calendar events
  loadLegacyCalEvents().forEach(e => {
    if((e.date||"").startsWith(prefix)){
      items.push({ id:e.id, type:e.type||"event", date:e.date, title:e.title, source:"legacy_cal", done:false });
    }
  });

  // Legacy: trade due
  loadLegacyTrades().forEach(r => {
    if((r.purchaseDate||"").startsWith(prefix)){
      items.push({ id:r.id, type:"trade_due", date:r.purchaseDate, title:r.itemName||r.partNo||"êµ¬ë§¤ ê±´", source:"legacy_trade", done:false });
    }
  });

  // Legacy: worklog tasks
  loadLegacyTasks().forEach(t => {
    if((t.due||"").startsWith(prefix)){
      items.push({ id:t.id, type:"todo_due", date:t.due, title:t.text, source:"legacy_task", done:!!t.done });
    }
  });

  return items;
}

function buildItemMap(year, month){
  const items = getAllCalendarItems(year, month);
  const map = {};
  items.forEach(e => { if(!map[e.date]) map[e.date]=[]; map[e.date].push(e); });
  return map;
}

function renderCalendar(){
  const mNames=["1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”","7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"];
  $("monthTitle").textContent = calYear+"ë…„ "+mNames[calMonth];

  const first=new Date(calYear,calMonth,1);
  const lastDay=new Date(calYear,calMonth+1,0).getDate();
  const startDow=first.getDay();
  const prevLast=new Date(calYear,calMonth,0).getDate();
  const today=todayStr();

  const itemMap = buildItemMap(calYear, calMonth);
  // Adjacent months for padding
  const pm=calMonth===0?11:calMonth-1, py=calMonth===0?calYear-1:calYear;
  const nm=calMonth===11?0:calMonth+1, ny=calMonth===11?calYear+1:calYear;
  const prevMap=buildItemMap(py,pm), nextMap=buildItemMap(ny,nm);

  const grid=$("calGrid");
  grid.innerHTML="";

  // DOW headers
  ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "].forEach(d=>{
    const div=document.createElement("div");
    div.className="cal-dow"; div.textContent=d; grid.appendChild(div);
  });

  function makeCell(day, dateStr, isOther){
    const cell=document.createElement("div");
    cell.className="cal-cell"+(isOther?" other-month":"");
    if(dateStr===today) cell.classList.add("today");
    if(dateStr===selectedDate) cell.classList.add("selected");

    const map = isOther ? (day>15?prevMap:nextMap) : itemMap;
    const dayItems = map[dateStr] || [];

    // Day number + dots
    const numRow=document.createElement("div");
    numRow.className="day-num";
    numRow.textContent=day;

    if(dayItems.length>0 && !isOther){
      const dotGrp=document.createElement("span");
      dotGrp.className="dot-group";
      const hasOverdue = dayItems.some(i=>i.source==="action"&&i.status!=="DONE"&&i.date<today);
      const hasAction = dayItems.some(i=>i.source==="action"&&i.status!=="DONE");
      const hasDone = dayItems.some(i=>(i.source==="action"&&i.status==="DONE")||(i.done));
      const hasLegacy = dayItems.some(i=>i.source!=="action");

      if(hasOverdue){ const d=document.createElement("span"); d.className="dot overdue"; dotGrp.appendChild(d); }
      else if(hasAction){ const d=document.createElement("span"); d.className="dot action"; dotGrp.appendChild(d); }
      if(hasLegacy){ const d=document.createElement("span"); d.className="dot action"; d.style.background="var(--orange)"; dotGrp.appendChild(d); }
      if(hasDone){ const d=document.createElement("span"); d.className="dot done"; dotGrp.appendChild(d); }

      const cnt=document.createElement("span");
      cnt.className="day-count";
      cnt.textContent=dayItems.length;
      dotGrp.appendChild(cnt);
      numRow.appendChild(dotGrp);
    }
    cell.appendChild(numRow);

    // Chips (max 2)
    if(!isOther && dayItems.length>0){
      const evtList=document.createElement("div");
      evtList.className="evt-list";
      dayItems.slice(0,2).forEach(it=>{
        const chip=document.createElement("div");
        let cls="evt-chip ";
        if(it.source==="action"){
          if(it.status==="DONE") cls+="done";
          else if(it.date<today) cls+="overdue";
          else cls+="action";
        } else {
          cls+=it.type;
          if(it.done) cls+=" done-legacy";
        }
        chip.className=cls;
        chip.textContent=it.title;
        chip.title=it.title;
        evtList.appendChild(chip);
      });
      if(dayItems.length>2){
        const more=document.createElement("div");
        more.className="evt-more";
        more.textContent="+"+(dayItems.length-2)+"ê±´";
        evtList.appendChild(more);
      }
      cell.appendChild(evtList);
    }

    cell.onclick = () => { selectedDate=dateStr; renderCalendar(); renderRightPanel(); };
    grid.appendChild(cell);
  }

  // Prev month padding
  for(let i=startDow-1;i>=0;i--){
    const day=prevLast-i;
    const ds=`${py}-${String(pm+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
    makeCell(day,ds,true);
  }
  // Current month
  for(let day=1;day<=lastDay;day++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
    makeCell(day,ds,false);
  }
  // Next month padding
  const total=startDow+lastDay;
  const rem=total%7===0?0:7-total%7;
  for(let i=1;i<=rem;i++){
    const ds=`${ny}-${String(nm+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    makeCell(i,ds,true);
  }
}

/* â”€â”€ Right Panel â”€â”€ */
function renderRightPanel(){
  const date = selectedDate || todayStr();
  const today = todayStr();

  // Actions for this date
  const actions = loadActions().filter(a => a.dueDate === date);
  // Also overdue if viewing today
  const overdue = date === today ? loadActions().filter(a => a.dueDate < today && a.status !== "DONE") : [];

  // Legacy items
  const legacyCal = loadLegacyCalEvents().filter(e => e.date === date);
  const legacyTrade = loadLegacyTrades().filter(r => r.purchaseDate === date);
  const legacyTasks = loadLegacyTasks().filter(t => t.due === date);

  const allItems = [...overdue.map(a=>({...a, _overdue:true})), ...actions, ...legacyCal.map(e=>({...e, _legacy:"cal"})), ...legacyTrade.map(r=>({...r, _legacy:"trade"})), ...legacyTasks.map(t=>({...t, _legacy:"task"}))];

  $("panelTitle").textContent = date === today ? "ì˜¤ëŠ˜ Â· " + date : date;
  $("panelCount").textContent = allItems.length + "ê±´";

  const list = $("panelList");
  const empty = $("panelEmpty");

  if(!allItems.length){
    empty.style.display="block";
    empty.innerHTML = '<div class="icon">ğŸ“‹</div>ì´ ë‚ ì§œì— í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤';
    list.innerHTML = "";
    list.appendChild(empty);
    return;
  }

  empty.style.display="none";
  let html = "";

  // Overdue section
  if(overdue.length && date === today){
    html += overdue.map(a => renderPanelAction(a, true)).join("");
  }

  // Actions
  actions.forEach(a => { html += renderPanelAction(a, false); });

  // Legacy items
  legacyCal.forEach(e => {
    html += `<div class="panel-item">
      <div style="width:18px;height:18px;border-radius:4px;background:#dbeafe;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0">ğŸ“…</div>
      <div class="item-body">
        <div class="item-title">${esc(e.title)}</div>
        <div class="item-meta"><span style="color:var(--primary)">ì¼ì •</span>${e.vendor?'<span>'+esc(e.vendor)+'</span>':''}</div>
      </div>
    </div>`;
  });
  legacyTrade.forEach(r => {
    html += `<div class="panel-item">
      <div style="width:18px;height:18px;border-radius:4px;background:#dcfce7;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0">ğŸ“¦</div>
      <div class="item-body">
        <div class="item-title">${esc(r.itemName||r.partNo||"êµ¬ë§¤ ê±´")}</div>
        <div class="item-meta"><span style="color:var(--accent)">êµ¬ë§¤ ë‚©ê¸°</span>${r.vendor?'<span>'+esc(r.vendor)+'</span>':''}</div>
      </div>
    </div>`;
  });
  legacyTasks.forEach(t => {
    html += `<div class="panel-item">
      <div style="width:18px;height:18px;border-radius:4px;background:${t.done?'#f1f5f9':'#fee2e2'};display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0">${t.done?'âœ“':'ğŸ“'}</div>
      <div class="item-body">
        <div class="item-title ${t.done?'strike':''}">${esc(t.text)}</div>
        <div class="item-meta"><span style="color:var(--warn)">í•  ì¼</span></div>
      </div>
    </div>`;
  });

  list.innerHTML = html;
  bindCheckboxes(list);
}

function renderPanelAction(a, isOverdue){
  const isDone = a.status === "DONE";
  const priBadge = a.priority && a.priority !== "NORMAL" ? `<span class="pri-badge ${a.priority}">${a.priority}</span>` : "";
  const overdueTag = isOverdue ? '<span style="color:var(--warn);font-weight:700">OVERDUE</span>' : '';
  const vendorTag = a.vendorId ? `<span class="vendor-tag" data-vendor="${esc(a.vendorId)}">${esc(a.vendorId)}</span>` : '';
  return `<div class="panel-item">
    <div class="chk ${isDone?"checked":""}" data-id="${a.id}" data-toggle="action"></div>
    <div class="item-body" style="cursor:pointer" data-edit-action="${a.id}">
      <div class="item-title ${isDone?"strike":""}">${esc(a.title)}</div>
      <div class="item-meta">${overdueTag}<span>${a.dueDate}</span>${vendorTag}${priBadge}</div>
    </div>
  </div>`;
}

function bindCheckboxes(container){
  container.querySelectorAll("[data-toggle='action']").forEach(el => {
    el.onclick = (e) => {
      e.stopPropagation();
      toggleActionDone(el.dataset.id);
    };
  });
  container.querySelectorAll("[data-edit-action]").forEach(el => {
    el.onclick = () => openActionModal(el.dataset.editAction);
  });
  container.querySelectorAll("[data-vendor]").forEach(el => {
    el.onclick = (e) => { e.stopPropagation(); openDrawer(el.dataset.vendor); };
  });
}

function toggleActionDone(id){
  const actions = loadActions();
  const a = actions.find(x => x.id === id);
  if(!a) return;
  if(a.status === "DONE"){
    a.status = "OPEN";
    a.doneAt = null;
  } else {
    a.status = "DONE";
    a.doneAt = new Date().toISOString();
  }
  a.updatedAt = new Date().toISOString();
  saveActions(actions);
  refreshAll();
}

/* â”€â”€ Action CRUD Modal â”€â”€ */
function openActionModal(id){
  refreshVendorList();
  if(id){
    editingActionId = id;
    const a = loadActions().find(x => x.id === id);
    if(!a) return;
    $("actionModalTitle").textContent = "Action ìˆ˜ì •";
    $("actTitle").value = a.title;
    $("actDate").value = a.dueDate;
    $("actPriority").value = a.priority || "NORMAL";
    $("actVendor").value = a.vendorId || "";
    $("actDelete").style.display = "inline-block";
  } else {
    editingActionId = null;
    $("actionModalTitle").textContent = "Action ì¶”ê°€";
    $("actTitle").value = "";
    $("actDate").value = selectedDate || todayStr();
    $("actPriority").value = "NORMAL";
    $("actVendor").value = "";
    $("actDelete").style.display = "none";
  }
  $("actionModal").classList.add("open");
  setTimeout(() => $("actTitle").focus(), 100);
}

function saveAction(){
  const title = $("actTitle").value.trim();
  if(!title){ $("actTitle").focus(); return; }
  const actions = loadActions();
  if(editingActionId){
    const a = actions.find(x => x.id === editingActionId);
    if(a){
      a.title = title;
      a.dueDate = $("actDate").value;
      a.priority = $("actPriority").value;
      a.vendorId = $("actVendor").value.trim();
      a.updatedAt = new Date().toISOString();
    }
  } else {
    actions.push({
      id: uid(),
      title: title,
      dueDate: $("actDate").value || todayStr(),
      type: "ACTION",
      status: "OPEN",
      priority: $("actPriority").value || "NORMAL",
      vendorId: $("actVendor").value.trim(),
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });
  }
  saveActions(actions);
  closeActionModal();
  refreshAll();
}

function deleteAction(){
  if(!editingActionId) return;
  if(!confirm("ì´ Actionì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  saveActions(loadActions().filter(a => a.id !== editingActionId));
  closeActionModal();
  refreshAll();
}

function closeActionModal(){
  $("actionModal").classList.remove("open");
  editingActionId = null;
}

/* â”€â”€ Quick Add (right panel) â”€â”€ */
$("quickAddBtn").onclick = quickAdd;
$("quickInput").addEventListener("keydown", e => { if(e.key==="Enter") quickAdd(); });

function quickAdd(){
  const title = $("quickInput").value.trim();
  if(!title) return;
  const actions = loadActions();
  actions.push({
    id: uid(),
    title: title,
    dueDate: selectedDate || todayStr(),
    type: "ACTION",
    status: "OPEN",
    priority: "NORMAL",
    vendorId: "",
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  });
  saveActions(actions);
  $("quickInput").value = "";
  refreshAll();
}

/* â”€â”€ Nav â”€â”€ */
$("btnPrev").onclick = () => { calMonth--; if(calMonth<0){calMonth=11;calYear--;} selectedDate=null; renderCalendar(); renderRightPanel(); };
$("btnNext").onclick = () => { calMonth++; if(calMonth>11){calMonth=0;calYear++;} selectedDate=null; renderCalendar(); renderRightPanel(); };
$("btnToday").onclick = () => { const d=new Date(); calYear=d.getFullYear(); calMonth=d.getMonth(); selectedDate=todayStr(); renderCalendar(); renderRightPanel(); };

$("actCancel").onclick = closeActionModal;
$("actSave").onclick = saveAction;
$("actDelete").onclick = deleteAction;
$("actionModal").onclick = e => { if(e.target===$("actionModal")) closeActionModal(); };
$("actTitle").addEventListener("keydown", e => { if(e.key==="Enter") saveAction(); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INITIATIVE TAB (Kanban)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let editingInitId = null;
let convertingInitId = null;

function renderKanban(){
  const inits = loadInitiatives();
  const cols = { IDEA:[], READY:[], ACTIVE:[], DONE:[] };
  inits.forEach(i => { if(cols[i.status]) cols[i.status].push(i); else cols.IDEA.push(i); });

  // Sort: HIGH first, then by createdAt desc
  const priOrder = { HIGH:0, NORMAL:1, LOW:2 };
  Object.values(cols).forEach(arr => arr.sort((a,b) => (priOrder[a.priority]||1) - (priOrder[b.priority]||1) || (b.createdAt||"").localeCompare(a.createdAt||"")));

  ["IDEA","READY","ACTIVE","DONE"].forEach(status => {
    const list = $("list"+status.charAt(0)+status.slice(1).toLowerCase());
    const cnt = $("cnt"+status.charAt(0)+status.slice(1).toLowerCase());
    if(!list) return;
    cnt.textContent = cols[status].length;
    list.innerHTML = cols[status].map(i => renderKCard(i)).join("");

    // Drag & drop
    list.ondragover = e => { e.preventDefault(); list.classList.add("drag-over"); };
    list.ondragleave = () => list.classList.remove("drag-over");
    list.ondrop = e => {
      e.preventDefault();
      list.classList.remove("drag-over");
      const id = e.dataTransfer.getData("text/plain");
      if(id) changeInitStatus(id, status);
    };

    // Bind card events
    list.querySelectorAll(".k-card").forEach(card => {
      card.draggable = true;
      card.ondragstart = e => { e.dataTransfer.setData("text/plain", card.dataset.id); card.classList.add("dragging"); };
      card.ondragend = () => card.classList.remove("dragging");
    });
    list.querySelectorAll(".status-sel").forEach(sel => {
      sel.onchange = () => changeInitStatus(sel.dataset.id, sel.value);
    });
    list.querySelectorAll("[data-convert]").forEach(btn => {
      btn.onclick = () => openConvertModal(btn.dataset.convert);
    });
    list.querySelectorAll("[data-edit-init]").forEach(el => {
      el.onclick = () => openInitModal(el.dataset.editInit);
    });
    list.querySelectorAll("[data-del-init]").forEach(btn => {
      btn.onclick = () => {
        if(confirm("ì´ Initiativeë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
          saveInitiatives(loadInitiatives().filter(x => x.id !== btn.dataset.delInit));
          renderKanban();
        }
      };
    });
  });
}

function renderKCard(i){
  const priBadge = i.priority && i.priority !== "NORMAL" ? `<span class="pri-badge ${i.priority}">${i.priority}</span>` : "";
  const catBadge = i.category ? `<span class="k-cat">${esc(i.category)}</span>` : "";
  const converted = i.convertedEventId ? `<span class="k-converted">ì‹¤í–‰ ì „í™˜ë¨</span>` : "";
  const date = (i.createdAt||"").substring(0,10);

  // Status dropdown
  const statuses = ["IDEA","READY","ACTIVE","DONE"];
  const statusOpts = statuses.map(s => `<option value="${s}"${s===i.status?" selected":""}>${s}</option>`).join("");

  const convertBtn = i.status !== "DONE" && !i.convertedEventId ? `<button class="k-btn convert" data-convert="${i.id}">ì‹¤í–‰ìœ¼ë¡œ ì „í™˜</button>` : "";

  return `<div class="k-card" data-id="${i.id}">
    <div class="k-title" data-edit-init="${i.id}" style="cursor:pointer">${esc(i.title)}</div>
    <div class="k-meta">${catBadge}${priBadge}${converted}<span class="k-date">${date}</span></div>
    <div class="k-actions">
      <select class="status-sel" data-id="${i.id}">${statusOpts}</select>
      ${convertBtn}
      <button class="k-btn danger" data-del-init="${i.id}" title="ì‚­ì œ">âœ•</button>
    </div>
  </div>`;
}

function changeInitStatus(id, newStatus){
  const inits = loadInitiatives();
  const i = inits.find(x => x.id === id);
  if(!i) return;
  i.status = newStatus;
  i.updatedAt = new Date().toISOString();
  saveInitiatives(inits);
  renderKanban();
}

/* â”€â”€ Initiative CRUD Modal â”€â”€ */
$("btnAddInitiative").onclick = () => openInitModal(null);

function openInitModal(id){
  if(id){
    editingInitId = id;
    const i = loadInitiatives().find(x => x.id === id);
    if(!i) return;
    $("initModalTitle").textContent = "Initiative ìˆ˜ì •";
    $("initTitle").value = i.title;
    $("initCategory").value = i.category || "";
    $("initPriority").value = i.priority || "NORMAL";
    $("initDelete").style.display = "inline-block";
  } else {
    editingInitId = null;
    $("initModalTitle").textContent = "Initiative ì¶”ê°€";
    $("initTitle").value = "";
    $("initCategory").value = "";
    $("initPriority").value = "NORMAL";
    $("initDelete").style.display = "none";
  }
  $("initModal").classList.add("open");
  setTimeout(() => $("initTitle").focus(), 100);
}

function saveInit(){
  const title = $("initTitle").value.trim();
  if(!title){ $("initTitle").focus(); return; }
  const inits = loadInitiatives();
  if(editingInitId){
    const i = inits.find(x => x.id === editingInitId);
    if(i){
      i.title = title;
      i.category = $("initCategory").value;
      i.priority = $("initPriority").value;
      i.updatedAt = new Date().toISOString();
    }
  } else {
    inits.push({
      id: uid(),
      title: title,
      category: $("initCategory").value || "",
      status: "IDEA",
      priority: $("initPriority").value || "NORMAL",
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });
  }
  saveInitiatives(inits);
  closeInitModal();
  renderKanban();
}

function deleteInit(){
  if(!editingInitId) return;
  if(!confirm("ì´ Initiativeë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  saveInitiatives(loadInitiatives().filter(x => x.id !== editingInitId));
  closeInitModal();
  renderKanban();
}

function closeInitModal(){
  $("initModal").classList.remove("open");
  editingInitId = null;
}

$("initCancel").onclick = closeInitModal;
$("initSave").onclick = saveInit;
$("initDelete").onclick = deleteInit;
$("initModal").onclick = e => { if(e.target===$("initModal")) closeInitModal(); };
$("initTitle").addEventListener("keydown", e => { if(e.key==="Enter") saveInit(); });

/* â”€â”€ Convert to Action (ìš°ì™€ ê¸°ëŠ¥) â”€â”€ */
function openConvertModal(initId){
  convertingInitId = initId;
  const i = loadInitiatives().find(x => x.id === initId);
  if(!i) return;
  $("convertDesc").textContent = `"${i.title}"ì„(ë¥¼) Calendar Actionìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.`;
  $("convertDate").value = getNextFriday();
  $("convertPriority").value = i.priority || "NORMAL";
  $("convertModal").classList.add("open");
}

function executeConvert(){
  if(!convertingInitId) return;
  const inits = loadInitiatives();
  const i = inits.find(x => x.id === convertingInitId);
  if(!i) return;

  // Create Action
  const actionId = uid();
  const actions = loadActions();
  actions.push({
    id: actionId,
    title: i.title,
    dueDate: $("convertDate").value || getNextFriday(),
    type: "ACTION",
    status: "OPEN",
    priority: $("convertPriority").value || "NORMAL",
    vendorId: "",
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    fromInitiativeId: i.id
  });
  saveActions(actions);

  // Update initiative: ACTIVE + link
  i.convertedEventId = actionId;
  i.updatedAt = new Date().toISOString();
  // Keep ACTIVE (don't auto-DONE)
  if(i.status === "IDEA" || i.status === "READY") i.status = "ACTIVE";
  saveInitiatives(inits);

  closeConvertModal();
  renderKanban();
  refreshAll();
}

function closeConvertModal(){
  $("convertModal").classList.remove("open");
  convertingInitId = null;
}

$("convertCancel").onclick = closeConvertModal;
$("convertSave").onclick = executeConvert;
$("convertModal").onclick = e => { if(e.target===$("convertModal")) closeConvertModal(); };

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VENDOR DRAWER (uses Action data via Single Source)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function relTime(iso){
  if(!iso) return "";
  const d=iso.substring(0,10), t=todayStr();
  if(d===t) return "ì˜¤ëŠ˜ "+iso.substring(11,16);
  const yd=new Date(new Date(t).getTime()-864e5).toISOString().substring(0,10);
  if(d===yd) return "ì–´ì œ "+iso.substring(11,16);
  return d;
}

function buildTimeline(){
  const items = [];
  try{JSON.parse(localStorage.getItem(TRADE_AUDIT)||"[]").forEach(a=>{
    if(a.event==="IMPORTED") return;
    items.push({type:"purchase",ts:a.ts,vendor:a.detail?.vendor||"",text:fmtAudit("êµ¬ë§¤",a.event,a.detail)});
  });}catch{}
  try{JSON.parse(localStorage.getItem(SALES_AUDIT)||"[]").forEach(a=>{
    if(a.event==="IMPORTED") return;
    items.push({type:"sale",ts:a.ts,vendor:a.detail?.client||"",text:fmtAudit("ë§¤ì¶œ",a.event,a.detail)});
  });}catch{}
  try{JSON.parse(localStorage.getItem(WORK_AUDIT)||"[]").forEach(a=>{
    items.push({type:"work",ts:a.ts,vendor:a.detail?.vendor||"",text:fmtWork(a.event,a.detail)});
  });}catch{}
  items.sort((a,b)=>b.ts.localeCompare(a.ts));
  return items;
}
function fmtAudit(m,ev,d){
  const nm=esc(d?.itemName||"");
  if(ev==="CREATE")return`${m} ë“±ë¡ â€” ${nm}`;
  if(ev==="UPDATE")return`${m} ìˆ˜ì • â€” ${nm}`;
  if(ev==="DELETE")return`${m} ì‚­ì œ â€” ${nm}`;
  return`${m} ${ev}`;
}
function fmtWork(ev,d){
  const tx=esc(d?.text||"");
  if(ev==="CREATE")return`Action ë“±ë¡ â€” ${tx}`;
  if(ev==="COMPLETE")return`Action ì™„ë£Œ â€” ${tx}`;
  if(ev==="REOPEN")return`Action ì¬ê°œ â€” ${tx}`;
  if(ev==="DELETE")return`Action ì‚­ì œ â€” ${tx}`;
  return`Action ${ev}`;
}

function openDrawer(vendor){
  if(!vendor) return;
  $("drawer").classList.add("open"); $("drawerOverlay").classList.add("open");
  $("vpName").textContent = vendor;

  let trades=[], sales=[];
  try{trades=JSON.parse(localStorage.getItem(TRADE_KEY)||"[]").filter(r=>r.vendor===vendor);}catch{}
  try{sales=JSON.parse(localStorage.getItem(SALES_KEY)||"[]").filter(r=>r.client===vendor);}catch{}

  // Actions for this vendor (Single Source of Truth)
  const vendorActions = loadActions().filter(a => a.vendorId === vendor && a.status !== "DONE");

  const tTotal=trades.reduce((s,r)=>s+n(r.buyUnitPrice)*n(r.qty),0);
  const sTotal=sales.reduce((s,r)=>s+n(r.sellUnitPrice)*n(r.qty),0);
  const allDates=[...trades.map(r=>r.purchaseDate),...sales.map(r=>r.salesDate)].filter(Boolean).sort();
  $("vpTotal").textContent=fmt(tTotal+sTotal);
  $("vpLatest").textContent=allDates.length?allDates[allDates.length-1]:"-";
  $("vpCount").textContent=(trades.length+sales.length);
  $("vpTasks").textContent=vendorActions.length+"ê±´";

  // Timeline
  const items=buildTimeline().filter(x=>x.vendor===vendor).slice(0,30);
  const ul=$("vpTimeline"); ul.innerHTML="";
  if(!items.length){
    ul.innerHTML='<li class="tl-item"><div style="flex:1;min-width:0"><div class="tl-text" style="color:var(--muted)">ì´ë ¥ ì—†ìŒ</div></div></li>';
  } else {
    items.forEach(it=>{
      const li=document.createElement("li"); li.className="tl-item";
      li.innerHTML=`<div class="tl-dot ${it.type}"></div><div style="flex:1;min-width:0"><div class="tl-text">${it.text}</div><div class="tl-time">${relTime(it.ts)}</div></div>`;
      ul.appendChild(li);
    });
  }

  // Footer: pending actions
  const todoDiv=$("vpTodos"); todoDiv.innerHTML="";
  if(!vendorActions.length){
    todoDiv.innerHTML='<div style="color:var(--muted);font-size:12px;padding:4px 0">ë¯¸ì™„ë£Œ Action ì—†ìŒ</div>';
  } else {
    vendorActions.forEach(a=>{
      const d=document.createElement("div"); d.className="drawer-todo";
      const overdueTag = a.dueDate < todayStr() ? ' <span style="color:var(--warn);font-size:10px;font-weight:700">ì§€ì—°</span>' : '';
      d.innerHTML=`<div class="dt-dot"></div><span>${esc(a.title)}${overdueTag}</span>`;
      todoDiv.appendChild(d);
    });
  }
}
function closeDrawer(){ $("drawer").classList.remove("open"); $("drawerOverlay").classList.remove("open"); }

$("vpClose").onclick = closeDrawer;
$("drawerOverlay").onclick = closeDrawer;

/* â”€â”€ Global â”€â”€ */
function refreshAll(){
  renderKPI();
  renderCalendar();
  renderRightPanel();
  if(activeKpiFilter) showFilteredList(activeKpiFilter);
}

document.addEventListener("keydown", e => {
  if(e.key==="Escape"){
    closeActionModal();
    closeInitModal();
    closeConvertModal();
    closeFilteredList();
    closeDrawer();
  }
});

/* â”€â”€ í¬ë¡œìŠ¤íƒ­ ë™ê¸°í™”: ë‹¤ë¥¸ íƒ­(console)ì—ì„œ ACTION ë³€ê²½ ì‹œ ìë™ ë°˜ì˜ (INIT_KEY ì œì™¸) â”€â”€ */
window.addEventListener("storage", e => { if(e.key === ACTION_KEY) refreshAll(); });

/* â”€â”€ Init â”€â”€ */
refreshAll();
</script>
</body>
</html>
