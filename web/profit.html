<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoLab Â· ìˆ˜ìµ ëŒ€ì‹œë³´ë“œ</title>
  <style>
    :root{
      --bg:#f5f7fa;--card:#ffffff;--border:#e5e7eb;
      --text:#0f172a;--muted:#64748b;
      --primary:#2563eb;--warn:#dc2626;--accent:#16a34a;--orange:#d97706;
      --purple:#7c3aed;--chip:#f8fafc;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size:13px;line-height:1.5}

    /* â”€ Header â”€ */
    header{padding:12px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);z-index:20;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:15px;font-weight:800;color:var(--primary);letter-spacing:-.2px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:6px 10px;border-radius:8px;border:1px solid var(--border);color:var(--muted);text-decoration:none;font-size:11px;font-weight:600;background:transparent;transition:all .15s}
    .tab:hover{color:var(--text);border-color:#cbd5e1}
    .tab.active{color:var(--primary);background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.3)}

    /* â”€ Container â”€ */
    .container{max-width:1200px;margin:0 auto;padding:20px}

    /* â”€ ê²½ê³  ì¹´ë“œ â”€ */
    .warn-bar{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
    .warn-card{display:flex;align-items:center;gap:8px;padding:10px 16px;border-radius:10px;font-size:12px;font-weight:600;border:1px solid}
    .warn-card.orange{background:#fffbeb;border-color:#fbbf24;color:#92400e}
    .warn-card.red{background:#fef2f2;border-color:#fca5a5;color:#991b1b}
    .warn-card .wi{font-size:16px}
    .warn-card .wv{font-weight:800;margin-left:4px}

    /* â”€ ê¸°ê°„ í•„í„° â”€ */
    .filter-bar{display:flex;align-items:center;gap:8px;margin-bottom:20px;flex-wrap:wrap}
    .fbtn{padding:7px 14px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--muted);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s}
    .fbtn:hover{color:var(--text);border-color:#cbd5e1}
    .fbtn.active{color:var(--primary);background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.3)}
    .date-input{padding:6px 10px;border-radius:8px;border:1px solid var(--border);font-size:11px;font-family:inherit;color:var(--text);background:var(--chip);outline:none}
    .date-input:focus{border-color:var(--primary)}
    .date-sep{color:var(--muted);font-size:11px}

    /* â”€ KPI ì¹´ë“œ 4ê°œ â”€ */
    .kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
    .kpi{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:18px 20px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .kpi .label{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.3px}
    .kpi .value{font-size:28px;font-weight:800;margin-top:6px;letter-spacing:-.5px}
    .kpi .sub{font-size:10px;color:var(--muted);margin-top:4px}
    .kpi .value.blue{color:var(--primary)}
    .kpi .value.red{color:var(--warn)}
    .kpi .value.green{color:var(--accent)}
    .kpi .value.orange{color:var(--orange)}

    /* â”€ í…Œì´ë¸” ì¹´ë“œ â”€ */
    .table-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
    .tcard{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .tcard h3{font-size:13px;font-weight:700;color:var(--text);margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .tcard h3 .badge{font-size:10px;padding:2px 8px;border-radius:6px;font-weight:700;background:#dbeafe;color:var(--primary)}
    table{width:100%;border-collapse:collapse;font-size:12px}
    thead th{text-align:left;padding:8px 10px;border-bottom:2px solid var(--border);color:var(--muted);font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:.3px}
    thead th.right{text-align:right}
    tbody td{padding:8px 10px;border-bottom:1px solid var(--border);color:var(--text)}
    tbody td.right{text-align:right;font-weight:600;font-variant-numeric:tabular-nums}
    tbody td.name{font-weight:600;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    tbody tr:hover{background:rgba(37,99,235,.03)}
    .margin-positive{color:var(--accent)}
    .margin-negative{color:var(--warn)}
    .no-data{text-align:center;padding:30px 20px;color:var(--muted);font-size:12px}

    /* â”€ ë§ˆì§„ ë°” (ì¸ë¼ì¸) â”€ */
    .margin-bar{display:inline-block;height:6px;border-radius:3px;min-width:2px;vertical-align:middle;margin-right:6px}

    /* â”€ Responsive â”€ */
    @media(max-width:900px){
      .kpi-row{grid-template-columns:repeat(2,1fr)}
      .table-row{grid-template-columns:1fr}
    }
    @media(max-width:600px){
      .kpi-row{grid-template-columns:1fr}
      .container{padding:12px}
    }
  </style>
</head>
<body>
<header>
  <h1>GoLab</h1>
  <nav class="tabs">
    <a class="tab" href="./console.html">ì½˜ì†”</a>
    <a class="tab" href="./purchases.html">ì…ê³ /ì›ê°€</a>
    <a class="tab" href="./index.html">ì¬ê³ </a>
    <a class="tab" href="./trade.html">êµ¬ë§¤ ì´ë ¥</a>
    <a class="tab" href="./sales.html">ë§¤ì¶œ</a>
    <a class="tab active" href="./profit.html">ìˆ˜ìµ</a>
    <a class="tab" href="./calendar.html">ìº˜ë¦°ë”</a>
  </nav>
</header>

<div class="container">

  <!-- â•â•â• ê²½ê³  ë°” â•â•â• -->
  <div class="warn-bar" id="warnBar"></div>

  <!-- â•â•â• ê¸°ê°„ í•„í„° â•â•â• -->
  <div class="filter-bar">
    <button class="fbtn active" data-range="month">ì´ë²ˆ ë‹¬</button>
    <button class="fbtn" data-range="30d">ìµœê·¼ 30ì¼</button>
    <button class="fbtn" data-range="all">ì „ì²´</button>
    <button class="fbtn" data-range="custom">ì§ì ‘ ì…ë ¥</button>
    <input type="date" class="date-input" id="dateFrom" style="display:none" />
    <span class="date-sep" id="dateSep" style="display:none">~</span>
    <input type="date" class="date-input" id="dateTo" style="display:none" />
  </div>

  <!-- â•â•â• KPI ìš”ì•½ ì¹´ë“œ â•â•â• -->
  <div class="kpi-row">
    <div class="kpi">
      <div class="label">ì´ ë§¤ì¶œ</div>
      <div class="value orange" id="kRevenue">â‚©0</div>
      <div class="sub" id="kRevenueSub">0ê±´</div>
    </div>
    <div class="kpi">
      <div class="label">ì´ ì›ê°€</div>
      <div class="value blue" id="kCost">â‚©0</div>
      <div class="sub" id="kCostSub">0ê±´</div>
    </div>
    <div class="kpi">
      <div class="label">ì´ ë§ˆì§„</div>
      <div class="value green" id="kMargin">â‚©0</div>
      <div class="sub" id="kMarginSub">ì›ê°€ í™•ì¸ëœ ë§¤ì¶œ ê¸°ì¤€</div>
    </div>
    <div class="kpi">
      <div class="label">ë§ˆì§„ìœ¨</div>
      <div class="value green" id="kRate">0.0%</div>
      <div class="sub" id="kRateSub">ë§ˆì§„ Ã· ë§¤ì¶œ</div>
    </div>
  </div>

  <!-- â•â•â• í…Œì´ë¸” 2ê°œ â•â•â• -->
  <div class="table-row">
    <!-- ê±°ë˜ì²˜ë³„ ë§ˆì§„ TOP -->
    <div class="tcard">
      <h3>ê±°ë˜ì²˜ë³„ ë§ˆì§„ TOP <span class="badge" id="clientBadge">0</span></h3>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>ê±°ë˜ì²˜</th>
            <th class="right">ë§¤ì¶œ</th>
            <th class="right">ì›ê°€</th>
            <th class="right">ë§ˆì§„</th>
            <th class="right">ë§ˆì§„ìœ¨</th>
          </tr>
        </thead>
        <tbody id="clientTable"></tbody>
      </table>
      <div class="no-data" id="clientEmpty" style="display:none">í•´ë‹¹ ê¸°ê°„ ë°ì´í„° ì—†ìŒ</div>
    </div>

    <!-- í’ˆëª©ë³„ ë§ˆì§„ TOP -->
    <div class="tcard">
      <h3>í’ˆëª©ë³„ ë§ˆì§„ TOP <span class="badge" id="itemBadge">0</span></h3>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>í’ˆëª©</th>
            <th class="right">ë§¤ì¶œ</th>
            <th class="right">ì›ê°€</th>
            <th class="right">ë§ˆì§„</th>
            <th class="right">ë§ˆì§„ìœ¨</th>
          </tr>
        </thead>
        <tbody id="itemTable"></tbody>
      </table>
      <div class="no-data" id="itemEmpty" style="display:none">í•´ë‹¹ ê¸°ê°„ ë°ì´í„° ì—†ìŒ</div>
    </div>
  </div>

</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GoLab Profit Dashboard v1.0
   ì½ê¸° ì „ìš© â€” golab_* localStorageë§Œ ì°¸ì¡°
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const $ = id => document.getElementById(id);

/* â”€â”€ ìœ í‹¸ â”€â”€ */
function n(v, fb=0){ const x=Number(v); return Number.isFinite(x)?x:fb; }
function fmtW(v){ return "â‚©"+Math.round(v).toLocaleString(); }
function fmtRate(v){ return (v*100).toFixed(1)+"%"; }

/* â”€â”€ ë‚ ì§œ ìœ í‹¸ â”€â”€ */
function todayStr(){ return new Date().toISOString().substring(0,10); }
function monthStart(){
  const d=new Date();
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-01";
}
function daysAgo(n){
  const d=new Date(); d.setDate(d.getDate()-n);
  return d.toISOString().substring(0,10);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   1ï¸âƒ£ ë‚ ì§œ í•„ë“œ ìë™ íƒì§€
   ìš°ì„ ìˆœìœ„: salesDate â†’ saleDate â†’ date â†’ createdAt
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DATE_FIELDS = ["salesDate","saleDate","date","createdAt"];

function extractDate(rec){
  for(const f of DATE_FIELDS){
    if(rec[f] && typeof rec[f] === "string" && rec[f].length >= 10){
      return rec[f].substring(0,10);
    }
  }
  return null; // ë‚ ì§œ ë¯¸ì •
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   2ï¸âƒ£ ì›ê°€(avgPrice) ë§¤í•‘ â€” ìë™ íƒì§€
   ì†ŒìŠ¤: golab_trade_v1 â†’ buyUnitPrice ê¸°ì¤€ í’ˆëª©ë³„ ê°€ì¤‘í‰ê· 
         golab_inventory_v01 â†’ buyPrice (ì´ë™í‰ê·  ì›ê°€)
         golab_purchases_v2 â†’ inbound_history unitPriceKrw
   ë§¤í•‘ í‚¤: partNo â†’ itemName fallback
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildCostMap(){
  const costMap = new Map(); // key â†’ { totalCost, totalQty }

  // (A) golab_trade_v1 â€” êµ¬ë§¤ ì´ë ¥ì—ì„œ í’ˆëª©ë³„ ê°€ì¤‘í‰ê·  ì›ê°€
  try{
    const trades = JSON.parse(localStorage.getItem("golab_trade_v1")||"[]");
    trades.forEach(t => {
      const price = n(t.buyUnitPrice);
      const qty = n(t.qty);
      if(price <= 0 || qty <= 0) return;

      // partNo ìš°ì„ , ì—†ìœ¼ë©´ itemName
      const keys = [];
      if(t.partNo) keys.push("partNo:"+t.partNo);
      if(t.itemName) keys.push("name:"+t.itemName);
      // itemIdë„ ì‹œë„
      if(t.itemId) keys.push("itemId:"+t.itemId);

      keys.forEach(k => {
        const prev = costMap.get(k) || {totalCost:0, totalQty:0};
        prev.totalCost += price * qty;
        prev.totalQty += qty;
        costMap.set(k, prev);
      });
    });
  }catch{}

  // (B) golab_inventory_v01 â€” ì¬ê³  ë§ˆìŠ¤í„°ì˜ buyPrice
  try{
    const inv = JSON.parse(localStorage.getItem("golab_inventory_v01")||"[]");
    inv.forEach(item => {
      const price = n(item.buyPrice);
      if(price <= 0) return;
      if(item.name){
        const k = "name:"+item.name;
        if(!costMap.has(k)){
          costMap.set(k, {totalCost: price, totalQty: 1}); // ë‹¨ê°€ ì§ì ‘
        }
      }
    });
  }catch{}

  // (C) golab_purchases_v2 â†’ inbound_historyì—ì„œ ë‹¨ê°€
  try{
    const history = JSON.parse(localStorage.getItem("golab_inventory_inbound_history_v01")||"[]");
    history.forEach(h => {
      const price = n(h.unitPriceKrw);
      const qty = n(h.qty);
      if(price <= 0 || qty <= 0) return;
      if(h.name){
        const k = "name:"+h.name;
        const prev = costMap.get(k) || {totalCost:0, totalQty:0};
        prev.totalCost += price * qty;
        prev.totalQty += qty;
        costMap.set(k, prev);
      }
    });
  }catch{}

  // ê°€ì¤‘í‰ê·  ë‹¨ê°€ë¡œ ë³€í™˜
  const avgMap = new Map();
  costMap.forEach((v,k) => {
    if(v.totalQty > 0) avgMap.set(k, Math.round(v.totalCost / v.totalQty));
  });

  return avgMap;
}

/* â”€â”€ ë§¤ì¶œ ë ˆì½”ë“œì—ì„œ ì›ê°€ ì°¾ê¸° â”€â”€ */
function lookupCost(rec, avgMap){
  // 1ìˆœìœ„: partNo (itemCode) ê¸°ì¤€
  if(rec.partNo){
    const v = avgMap.get("partNo:"+rec.partNo);
    if(v !== undefined) return v;
  }
  // 2ìˆœìœ„: itemId
  if(rec.itemId){
    const v = avgMap.get("itemId:"+rec.itemId);
    if(v !== undefined) return v;
  }
  // 3ìˆœìœ„: itemName fallback
  if(rec.itemName){
    const v = avgMap.get("name:"+rec.itemName);
    if(v !== undefined) return v;
  }
  return null; // ë§¤í•‘ ì‹¤íŒ¨ â†’ ë§ˆì§„ ê³„ì‚° ì œì™¸
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë°ì´í„° ë¡œë“œ + ë¶„ì„
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentRange = "month";
let customFrom = "";
let customTo = "";

/* Fix-1: sales í‚¤ ìë™ íƒì§€ (golab_sales prefix ì „ìˆ˜ ìŠ¤ìº”) */
function detectSalesKey(){
  // 1ìˆœìœ„: golab_sales_v1 ì¡´ì¬í•˜ë©´ ì¦‰ì‹œ ë°˜í™˜
  if(localStorage.getItem("golab_sales_v1") !== null) return "golab_sales_v1";
  // 2ìˆœìœ„: golab_sales* ì¤‘ JSON ë°°ì—´ íŒŒì‹± ê°€ëŠ¥í•œ í›„ë³´ â†’ ë ˆì½”ë“œ ìˆ˜ ìµœëŒ€
  let best = null, bestLen = -1;
  for(let i = 0; i < localStorage.length; i++){
    const k = localStorage.key(i);
    if(!k.startsWith("golab_sales")) continue;
    try{
      const arr = JSON.parse(localStorage.getItem(k));
      if(Array.isArray(arr) && arr.length > bestLen){ best = k; bestLen = arr.length; }
    }catch{}
  }
  return best; // nullì´ë©´ í‚¤ ì—†ìŒ
}

function loadSales(){
  const key = detectSalesKey();
  console.log("[Profit] sales key â†’", key || "(ì—†ìŒ)");
  if(!key) return [];
  try{ return JSON.parse(localStorage.getItem(key)||"[]"); }
  catch{ return []; }
}

/* Fix-2: ì¢…ë£Œì¼ â€” presetì€ todayStr(), customì€ ì‚¬ìš©ì ì§€ì • ê°’ */
function getDateRange(){
  const today = todayStr();
  if(currentRange === "month") return { from: monthStart(), to: today };
  if(currentRange === "30d") return { from: daysAgo(30), to: today };
  if(currentRange === "all") return { from: "0000-01-01", to: today };
  if(currentRange === "custom") return { from: customFrom || "0000-01-01", to: customTo || today };
  return { from: monthStart(), to: today };
}

function analyze(){
  const sales = loadSales();
  const avgMap = buildCostMap();
  const range = getDateRange();

  // ì§‘ê³„ ë³€ìˆ˜
  let totalRevenue = 0;
  let totalCost = 0;
  let totalMargin = 0;
  let revenueCount = 0;     // ê¸°ê°„ ë‚´ ì „ì²´ ë§¤ì¶œ ê±´ìˆ˜
  let marginCount = 0;      // ì›ê°€ í™•ì¸ëœ ê±´ìˆ˜
  let noDateCount = 0;       // ë‚ ì§œ ë¯¸ì • ê±´ìˆ˜
  let noCostCount = 0;       // ì›ê°€ ë¯¸ì • ê±´ìˆ˜
  let noCostRevenue = 0;     // ì›ê°€ ë¯¸ì • ë§¤ì¶œì•¡
  let marginRevenue = 0;     // ë§ˆì§„ ê³„ì‚° í¬í•¨ ë§¤ì¶œì•¡

  // ê±°ë˜ì²˜ë³„ / í’ˆëª©ë³„ ì§‘ê³„
  const byClient = new Map();
  const byItem = new Map();

  sales.forEach(rec => {
    const dt = extractDate(rec);

    // ë‚ ì§œ ë¯¸ì •: ê¸°ê°„ í•„í„°ì—ì„œ ì œì™¸
    if(!dt){
      noDateCount++;
      return;
    }

    // ê¸°ê°„ í•„í„°
    if(dt < range.from || dt > range.to) return;

    const revenue = n(rec.sellUnitPrice) * n(rec.qty);
    totalRevenue += revenue;
    revenueCount++;

    // ì›ê°€ ì¡°íšŒ
    const unitCost = lookupCost(rec, avgMap);

    if(unitCost === null){
      // 3ï¸âƒ£ ì›ê°€ ë¯¸ì •: ë§ˆì§„ ê³„ì‚°ì—ì„œ ì œì™¸
      noCostCount++;
      noCostRevenue += revenue;
      // ê±°ë˜ì²˜/í’ˆëª© ì§‘ê³„ì—ëŠ” ë§¤ì¶œë§Œ í¬í•¨ (ì›ê°€=null í‘œì‹œ)
      accumulateGroup(byClient, rec.client || "(ë¯¸ì§€ì •)", revenue, null, n(rec.qty));
      accumulateGroup(byItem, rec.itemName || rec.partNo || "(ë¯¸ì§€ì •)", revenue, null, n(rec.qty));
      return;
    }

    const cost = unitCost * n(rec.qty);
    const margin = revenue - cost;
    totalCost += cost;
    totalMargin += margin;
    marginCount++;
    marginRevenue += revenue;

    accumulateGroup(byClient, rec.client || "(ë¯¸ì§€ì •)", revenue, cost, n(rec.qty));
    accumulateGroup(byItem, rec.itemName || rec.partNo || "(ë¯¸ì§€ì •)", revenue, cost, n(rec.qty));
  });

  return {
    totalRevenue, totalCost, totalMargin, marginRevenue,
    revenueCount, marginCount,
    noDateCount, noCostCount, noCostRevenue,
    byClient, byItem
  };
}

function accumulateGroup(map, key, revenue, cost, qty){
  const prev = map.get(key) || {revenue:0, cost:0, qty:0, hasCost:false, count:0, noCostRevenue:0, noCostCount:0};
  prev.revenue += revenue;
  prev.qty += qty;
  prev.count++;
  if(cost !== null){
    prev.cost += cost;
    prev.hasCost = true;
  } else {
    prev.noCostRevenue += revenue;
    prev.noCostCount++;
  }
  map.set(key, prev);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë Œë”ë§
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render(){
  const r = analyze();

  // â”€â”€ ê²½ê³  ë°” â”€â”€
  let warns = "";
  if(r.noDateCount > 0){
    warns += `<div class="warn-card orange"><span class="wi">âš ï¸</span>ë‚ ì§œ ë¯¸ì • ë§¤ì¶œ<span class="wv">${r.noDateCount}ê±´</span> â€” ê¸°ê°„ í•„í„° ì§‘ê³„ì—ì„œ ì œì™¸ë¨</div>`;
  }
  if(r.noCostCount > 0){
    warns += `<div class="warn-card red"><span class="wi">ğŸ”´</span>ì›ê°€ ë¯¸ì • ë§¤ì¶œ<span class="wv">${fmtW(r.noCostRevenue)} (${r.noCostCount}ê±´)</span> â€” ë§ˆì§„ ê³„ì‚°ì—ì„œ ì œì™¸ë¨</div>`;
  }
  $("warnBar").innerHTML = warns;

  // â”€â”€ KPI ì¹´ë“œ â”€â”€
  $("kRevenue").textContent = fmtW(r.totalRevenue);
  $("kRevenueSub").textContent = r.revenueCount + "ê±´";

  $("kCost").textContent = fmtW(r.totalCost);
  $("kCostSub").textContent = r.marginCount + "ê±´ (ì›ê°€ í™•ì¸)";

  $("kMargin").textContent = fmtW(r.totalMargin);
  $("kMargin").className = "value " + (r.totalMargin >= 0 ? "green" : "red");
  $("kMarginSub").textContent = `ì›ê°€ í™•ì¸ëœ ${r.marginCount}ê±´ ê¸°ì¤€`;

  const rate = r.marginRevenue > 0 ? r.totalMargin / r.marginRevenue : 0;
  $("kRate").textContent = fmtRate(rate);
  $("kRate").className = "value " + (rate >= 0 ? "green" : "red");
  $("kRateSub").textContent = `ë§ˆì§„ Ã· ì›ê°€í™•ì¸ ë§¤ì¶œ`;

  // â”€â”€ ê±°ë˜ì²˜ë³„ í…Œì´ë¸” â”€â”€
  renderGroupTable(r.byClient, "clientTable", "clientEmpty", "clientBadge");

  // â”€â”€ í’ˆëª©ë³„ í…Œì´ë¸” â”€â”€
  renderGroupTable(r.byItem, "itemTable", "itemEmpty", "itemBadge");
}

function renderGroupTable(map, tbodyId, emptyId, badgeId){
  // ë§ˆì§„ ê³„ì‚° ê°€ëŠ¥í•œ í•­ëª©ë§Œ ì •ë ¬ (ì›ê°€ ìˆëŠ” ë§¤ì¶œ - ì›ê°€)
  const entries = [...map.entries()].map(([name, v]) => {
    const marginableRevenue = v.revenue - v.noCostRevenue;
    const margin = marginableRevenue - v.cost;
    const marginRate = marginableRevenue > 0 ? margin / marginableRevenue : 0;
    return { name, revenue: v.revenue, cost: v.cost, margin, marginRate, count: v.count, hasCost: v.hasCost, noCostCount: v.noCostCount };
  });

  // ë§ˆì§„ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  entries.sort((a,b) => b.margin - a.margin);
  const top20 = entries.slice(0, 20);

  $(badgeId).textContent = entries.length;

  if(!top20.length){
    $(tbodyId).innerHTML = "";
    $(emptyId).style.display = "block";
    return;
  }

  $(emptyId).style.display = "none";
  const maxMargin = Math.max(...top20.map(e => Math.abs(e.margin)), 1);

  $(tbodyId).innerHTML = top20.map((e, i) => {
    const barWidth = Math.max(2, Math.round(Math.abs(e.margin) / maxMargin * 60));
    const barColor = e.margin >= 0 ? "var(--accent)" : "var(--warn)";
    const marginClass = e.margin >= 0 ? "margin-positive" : "margin-negative";
    const costDisplay = e.hasCost ? fmtW(e.cost) : '<span style="color:var(--muted)">ë¯¸ì •</span>';
    const marginDisplay = e.hasCost
      ? `<span class="${marginClass}">${fmtW(e.margin)}</span>`
      : '<span style="color:var(--muted)">â€”</span>';
    const rateDisplay = e.hasCost
      ? `<span class="${marginClass}">${fmtRate(e.marginRate)}</span>`
      : '<span style="color:var(--muted)">â€”</span>';

    return `<tr>
      <td>${i+1}</td>
      <td class="name" title="${esc(e.name)}">${esc(e.name)}${e.noCostCount ? ' <span style="color:var(--warn);font-size:9px">âš '+e.noCostCount+'</span>' : ''}</td>
      <td class="right">${fmtW(e.revenue)}</td>
      <td class="right">${costDisplay}</td>
      <td class="right"><span class="margin-bar" style="width:${barWidth}px;background:${barColor}"></span>${marginDisplay}</td>
      <td class="right">${rateDisplay}</td>
    </tr>`;
  }).join("");
}

function esc(s){ return (s||"").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ê¸°ê°„ í•„í„° ì´ë²¤íŠ¸
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll(".fbtn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".fbtn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentRange = btn.dataset.range;

    const isCustom = currentRange === "custom";
    $("dateFrom").style.display = isCustom ? "inline-block" : "none";
    $("dateSep").style.display = isCustom ? "inline" : "none";
    $("dateTo").style.display = isCustom ? "inline-block" : "none";

    if(isCustom){
      if(!$("dateFrom").value) $("dateFrom").value = monthStart();
      if(!$("dateTo").value) $("dateTo").value = todayStr();
      customFrom = $("dateFrom").value;
      customTo = $("dateTo").value;
    }

    render();
  });
});

$("dateFrom").addEventListener("change", e => { customFrom = e.target.value; render(); });
$("dateTo").addEventListener("change", e => { customTo = e.target.value; render(); });

/* â”€â”€ í¬ë¡œìŠ¤íƒ­ ë™ê¸°í™” â”€â”€ */
window.addEventListener("storage", e => {
  if(e.key && e.key.startsWith("golab_")) render();
});

/* â”€â”€ Init â”€â”€ */
render();
</script>
</body>
</html>
