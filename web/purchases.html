<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoLab Â· ìˆ˜ì…/ìœ í†µ ì›ê°€ ê´€ë¦¬ (êµ¬ë§¤/ì…ê³ )</title>
  <style>
    :root{
      --bg:#f5f7fa; --card:#ffffff; --muted:#64748b; --text:#0f172a;
      --line:#e5e7eb; --accent:#16a34a; --warn:#d97706; --bad:#dc2626; --point:#2563eb;
      --chip:#f8fafc;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial;}
    header{padding:14px 18px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter: blur(8px);z-index:10}
    header .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    header h1{margin:0;font-size:16px;letter-spacing:.2px;color:var(--point)}
    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tab{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:10px;border:1px solid var(--line);
      color:var(--muted);text-decoration:none;background:transparent;font-size:12px;
    }
    .tab.active{color:var(--point);background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.3)}
    .wrap{max-width:1300px;margin:0 auto;padding:16px 16px 36px}
    .grid{display:grid;grid-template-columns: 1fr 420px; gap:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:20px; margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .card h2{margin:0 0 12px;font-size:13px;color:var(--point); display:flex; align-items:center; gap:8px}
    .row{display:grid;grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px}
    label{display:block;font-size:11px;color:var(--muted);margin-bottom:6px; font-weight:700}
    input, select, textarea{
      width:100%;border-radius:10px;border:1px solid var(--line);background:var(--chip);color:var(--text);
      padding:10px;font-size:12px;outline:none; transition: border 0.2s;
    }
    #pUnit{
      background-color:var(--chip);
      color:var(--text);
    }
    #pUnit option,
    #pUnit optgroup{
      background-color:#ffffff;
      color:#0f172a;
    }
    #pUnit option:checked,
    #pUnit option:hover{
      background-color:var(--point);
      color:#ffffff;
    }
    .field-required{
      background:rgba(37,99,235,0.06);
    }
    .field-auto{
      background:rgba(100,116,139,0.06);
    }
    .memo-box-highlight{
      background:rgba(254,243,199,0.95) !important;
      color:#111;
    }
    input:focus, select:focus, textarea:focus{border-color:var(--point)}
    input::placeholder{color:#94a3b8}
    textarea{min-height:70px;resize:vertical}
    .btns{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    button{
      flex:1; border:1px solid var(--line);background:var(--card);color:var(--text);
      border-radius:10px;padding:12px;font-size:12px;cursor:pointer; font-weight:800;
    }
    button:hover{border-color:#cbd5e1;background:#f8fafc}
    button.primary{background:var(--point); border:none; color:#fff}
    button.primary:hover{background:#1d4ed8}
    button.save{background:var(--accent); border:none; color:#fff}
    button.save.save-disabled{
      background:#e5e7eb;
      border:1px solid var(--line);
      color:var(--muted);
      opacity:0.7;
      cursor:not-allowed;
    }
    button.save.save-ready{
      background:var(--accent);
      border:none;
      color:#fff;
    }
    button.save.save-warning{
      background:var(--warn);
      border:none;
      color:#fff;
    }
    button.save.save-error{
      background:var(--bad);
      border:none;
      color:#fff;
    }
    button.danger{color:var(--bad); background:none; border:1px solid rgba(220,38,38,.3)}
    button.secondary{background:rgba(37,99,235,.06); border:1px solid rgba(37,99,235,.25);color:var(--point)}
    .kpi-grid{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
    .kpi{padding:14px;border-radius:10px;border:1px solid var(--line);background:var(--card);box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{margin-top:8px;font-size:24px;font-weight:600; color:var(--point)}
    .tableWrap{overflow:auto; border-radius:10px; border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;min-width:1100px; font-size:12px}
    th{background:#f8fafc; color:var(--muted); text-align:left; padding:12px; position:sticky; top:0;border-bottom:1px solid var(--line)}
    td{padding:12px; border-bottom:1px solid var(--line); vertical-align:middle}
    .highlight{color:var(--accent); font-weight:900}
    .currency-tag{font-size:10px; padding:2px 6px; background:#e5e7eb; border-radius:6px; margin-left:6px; color:#475569}
    .note-box{padding:12px; background:rgba(37,99,235,0.04); border-left:3px solid var(--point); font-size:12px; color:var(--muted); line-height:1.6;border-radius:10px}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:3px 10px;border-radius:999px;border:1px solid var(--line);font-size:11px;color:var(--muted)}
    .pill .dot{width:7px;height:7px;border-radius:999px;background:var(--accent)}
    .tools{display:flex;gap:8px;flex-direction:column;margin-top:12px}
    .tools button{flex:unset}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .mini{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.5}
    input[type="file"]{display:none}
    .checkRow{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);background:rgba(37,99,235,.03);border-radius:12px;margin-top:10px}
    .checkRow input{width:auto}
  </style>
</head>
<body>
<header>
  <div class="top">
    <h1>GoLab Â· ì…ê³ /ì›ê°€ (êµ¬ë§¤ ì›ì¥)</h1>
    <nav class="tabs">
      <a class="tab" href="./console.html">ğŸ¯ ì½˜ì†”</a>
      <a class="tab active" href="./purchases.html">ğŸ“¦ ì…ê³ /ì›ê°€</a>
      <a class="tab" href="./index.html">ğŸ“ ì¬ê³  í˜„í™©</a>
      <a class="tab" href="./trade.html">ğŸ“Š êµ¬ë§¤ ì´ë ¥</a>
      <a class="tab" href="./sales.html">ğŸ’° ë§¤ì¶œ ê´€ë¦¬</a>
      <a class="tab" href="./calendar.html">ğŸ“… ìº˜ë¦°ë”</a>
    </nav>
  </div>
</header>
<div class="wrap">
  <div class="grid">
    <div class="leftCol">
      <div class="card">
        <h2>ğŸ“¦ 1ë‹¨ê³„: ë°°ì¹˜ ë° ê³µí†µ ë¹„ìš© (í™˜ìœ¨/ë¬¼ë¥˜ë¹„)</h2>
        <div class="row">
          <div>
            <label>ë°°ì¹˜ëª…</label>
            <input id="bName" placeholder="ì˜ˆ: 26ë…„ 2ì›” ì¼ë³¸ ìˆ˜ì…ë¶„" />
          </div>
          <div>
            <label>ì…ê³ ì¼</label>
            <input id="bDate" type="date" />
          </div>
        </div>
        <div class="row" style="grid-template-columns: 1fr 1fr 1fr">
          <div>
            <label>ë°°ì¹˜ í†µí™”</label>
            <select id="bCur">
              <option value="USD">USD (ë‹¬ëŸ¬)</option>
              <option value="JPY">JPY (ì—”)</option>
              <option value="KRW">KRW (ì›í™”)</option>
            </select>
            <div class="mini">â€» í•œ ë°°ì¹˜ = í†µí™” 1ê°œ(ì´ˆê¸° ë²„ì „)</div>
          </div>
          <div>
            <label>ì ìš© í™˜ìœ¨ (1 ì™¸í™”ë‹¹ KRW)</label>
            <input id="bEx" type="number" step="0.01" placeholder="ì˜ˆ: 1350.5" />
            <div class="mini">KRW ë°°ì¹˜ë©´ 1 ìë™</div>
          </div>
          <div>
            <label>ê³µí†µ ë¬¼ë¥˜ë¹„(KRW)</label>
            <input id="bLogi" type="number" placeholder="ì˜ˆ: 150000" />
            <div class="mini">ìš´ì„/í†µê´€/ê´€ì„¸ ë“± í¬í•¨ ê°€ëŠ¥(ì´ˆê¸°)</div>
          </div>
        </div>
        <div class="note-box" style="margin-top:10px">
          ğŸ’¡ <b>ì•ˆë¶„ ë¡œì§</b>: ë¬¼ë¥˜ë¹„ëŠ” ê° í’ˆëª©ì˜ <b>[KRW í™˜ì‚° ë§¤ì…ê¸ˆì•¡]</b> ë¹„ì¤‘ìœ¼ë¡œ ìë™ ë°°ë¶„ë©ë‹ˆë‹¤. (ì‹¤ë‹¨ê°€ ì‚°ì¶œ)
        </div>
      </div>
      <div class="card">
        <h2>ğŸ 2ë‹¨ê³„: í’ˆëª©ë³„ ë§¤ì… ì •ë³´ (ì˜¤íƒ€ ë°©ì§€: ìë™ì™„ì„±)</h2>
        <div class="row" style="grid-template-columns: 2fr 1fr 1fr">
          <div>
            <label>í’ˆëª… / Part No.</label>
            <input id="pName" class="field-required" list="itemList" placeholder="ì˜ˆ: Ag Powder A (AGC-123)" />
            <datalist id="itemList"></datalist>
            <div class="mini">â€» ì¬ê³ ì— ë“±ë¡ëœ í’ˆëª©ì„ ìë™ì™„ì„±ìœ¼ë¡œ ì„ íƒ ê°€ëŠ¥</div>
          </div>
          <div>
            <label>ìˆ˜ëŸ‰</label>
            <input id="pQty" class="field-required" type="number" step="0.01" placeholder="0.00" />
          </div>
          <div>
            <label>ë‹¨ìœ„</label>
            <select id="pUnit" class="field-required">
              <option value="kg">kg</option>
              <option value="g">g</option>
              <option value="ea">ea</option>
              <option value="BOX">BOX</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>ë§¤ì… ë‹¨ê°€ (ì™¸í™” ê¸°ì¤€)</label>
            <input id="pPrice" class="field-required" type="number" step="0.01" placeholder="í™˜ìœ¨ ì ìš© ì „ ë‹¨ê°€" />
          </div>
          <div>
            <label>ë©”ëª¨</label>
            <input id="pMemo" placeholder="íŠ¹ì´ì‚¬í•­ ê¸°ë¡" />
          </div>
        </div>
        <div class="btns">
          <button id="btnAddLine" class="primary">ë¼ì¸ ì¶”ê°€ (Add Item)</button>
        </div>
        <div class="mini">TIP: í’ˆëª© ì—¬ëŸ¬ ê°œ ì¶”ê°€ í›„, ì˜¤ë¥¸ìª½ì—ì„œ "ë°°ì¹˜ ì €ì¥"ì„ ëˆ„ë¥´ì„¸ìš”.</div>
      </div>
    </div>
    <div class="rightCol">
      <div class="card">
        <h2>ğŸ“Š ì‹¤ì‹œê°„ ìš”ì•½ (KRW)</h2>
        <div class="kpi-grid">
          <div class="kpi field-auto">
            <div class="t">ì´ ë§¤ì… ìì‚°(ì‹¤ì›ê°€ í•©)</div>
            <div id="kTotal" class="v">â‚© 0</div>
          </div>
          <div class="kpi field-auto">
            <div class="t">ë“±ë¡ëœ ë°°ì¹˜</div>
            <div id="kBatch" class="v">0 ê±´</div>
          </div>
        </div>
        <div class="checkRow">
          <input id="chkToInventory" type="checkbox" checked />
          <div>
            <div style="font-weight:900">ì €ì¥ ì‹œ ì¬ê³  ì‹œìŠ¤í…œìœ¼ë¡œ ì „ì†¡</div>
            <div class="mini">ë°°ì¹˜ ì €ì¥í•˜ë©´ ì¬ê³ (index.html) ìˆ˜ëŸ‰/ë‹¨ê°€ê°€ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
          </div>
        </div>
        <div class="tools">
          <button id="btnCloseBatch" class="save">í˜„ì¬ ë°°ì¹˜ í™•ì • ë° ì €ì¥</button>
          <div id="saveStatus" class="mini"></div>
          <div class="inline">
            <button id="btnExport" class="secondary">ë°±ì—…(JSON)</button>
            <button id="btnImport" class="secondary">ê°€ì ¸ì˜¤ê¸°</button>
            <input id="fileIn" type="file" accept="application/json" />
          </div>
          <button id="btnReset" class="danger">ì´ í˜ì´ì§€ ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
        <div class="note-box" style="margin-top:12px">
          âœ… ì´ˆê¸°í™”ëŠ” <b>ì´ í˜ì´ì§€(êµ¬ë§¤/ì…ê³ )</b> ë°ì´í„°ë§Œ ì‚­ì œí•©ë‹ˆë‹¤. (ì¬ê³  í˜ì´ì§€ ì˜í–¥ ì—†ìŒ)
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <h2>ğŸ“‹ ì €ì¥ëœ ì›ì¥ ë‚´ì—­</h2>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>ë°°ì¹˜/ë‚ ì§œ</th>
            <th>í’ˆëª©ëª…</th>
            <th>ìˆ˜ëŸ‰/ë‹¨ìœ„</th>
            <th>ë§¤ì… ë‹¨ê°€(ì™¸í™”)</th>
            <th>í™˜ìœ¨</th>
            <th>ë¬¼ë¥˜ë¹„(ì•ˆë¶„)</th>
            <th style="color:var(--point)">ì‹¤ì›ê°€(KRW)</th>
            <th style="color:var(--accent)">ìµœì¢… ì‹¤ë‹¨ê°€(KRW)</th>
            <th>ë©”ëª¨</th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="mini">â€» ì‹¤ì›ê°€/ì‹¤ë‹¨ê°€ëŠ” "ë°°ì¹˜ í†µí™” + í™˜ìœ¨ + ë¬¼ë¥˜ë¹„" ë°˜ì˜ KRW ê¸°ì¤€ ê°’ì…ë‹ˆë‹¤.</div>
  </div>
</div>
<script>
  const PUR_KEY = "golab_purchases_v2";
  const INV_KEY  = "golab_inventory_v01";
  const HIST_KEY = "golab_inventory_inbound_history_v01";
  const $ = (id) => document.getElementById(id);
  let draftLines = [];
  let isEventBound = false;
  $("bDate").value = new Date().toISOString().substring(0, 10);
  function n(v, fallback=0){
    const x = Number(v);
    return Number.isFinite(x) ? x : fallback;
  }
  function loadPur() {
    try { return JSON.parse(localStorage.getItem(PUR_KEY) || "[]"); }
    catch { return []; }
  }
  function savePur(data) {
    localStorage.setItem(PUR_KEY, JSON.stringify(data));
  }
  function loadInv(){
    try { return JSON.parse(localStorage.getItem(INV_KEY) || "[]"); }
    catch { return []; }
  }
  function saveInv(list){
    localStorage.setItem(INV_KEY, JSON.stringify(list));
  }
  function loadHist(){
    try { return JSON.parse(localStorage.getItem(HIST_KEY) || "[]"); }
    catch { return []; }
  }
  function saveHist(list){
    localStorage.setItem(HIST_KEY, JSON.stringify(list));
  }
  function refreshAutocomplete(){
    const dl = $("itemList");
    dl.innerHTML = "";
    const inv = loadInv();
    const names = [...new Set(inv.map(x => (x.name||"").trim()).filter(Boolean))].sort();
    names.forEach(name=>{
      const opt = document.createElement("option");
      opt.value = name;
      dl.appendChild(opt);
    });
  }
  function addLine() {
    const pName = $("pName").value.trim();
    const qty   = n($("pQty").value);
    const price = n($("pPrice").value);
    if(!pName || qty <= 0 || price <= 0) {
      alert("í’ˆëª…, ìˆ˜ëŸ‰, ë‹¨ê°€ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    draftLines.push({
      id: crypto.randomUUID(),
      pName,
      qty,
      unit: $("pUnit").value,
      price,
      memo: $("pMemo").value.trim()
    });
    $("pName").value = "";
    $("pQty").value = "";
    $("pPrice").value = "";
    $("pMemo").value = "";
    render();
    validateForm();
  }
  function transferToInventory(batch){
    const inv = loadInv();
    const hist = loadHist();
    const subTotalKrw = batch.items.reduce((sum, item) => {
      return sum + (n(item.price) * n(item.qty) * n(batch.exchangeRate, 1));
    }, 0);
    batch.items.forEach(item=>{
      const itemKrwPure = n(item.price) * n(item.qty) * n(batch.exchangeRate, 1);
      const allocatedLogi = subTotalKrw > 0
        ? (itemKrwPure / subTotalKrw) * n(batch.totalLogisticsKrw)
        : 0;
      const realTotalKrw = itemKrwPure + allocatedLogi;
      const unitPriceKrw = (n(item.qty) > 0) ? (realTotalKrw / n(item.qty)) : 0;
      let target = inv.find(x => x.id === item.inventoryItemId)
        || inv.find(x => (x.name||"").trim() === (item.pName||"").trim());
      if(!target){
        target = {
          id: crypto.randomUUID(),
          name: item.pName,
          spec: item.unit,
          vendor: "ì…ê³ ì›ì¥ ì „ì†¡",
          buyPrice: 0,
          qty: 0,
          minQty: 0,
          note: "",
          updatedAt: new Date().toISOString()
        };
        inv.unshift(target);
      }
      const oldQty = n(target.qty);
      const oldPrice = n(target.buyPrice);
      const newQty = n(item.qty);
      const totalQty = oldQty + newQty;
      if(totalQty > 0){
        target.buyPrice = (oldQty * oldPrice + newQty * unitPriceKrw) / totalQty;
      } else {
        target.buyPrice = unitPriceKrw;
      }
      target.qty = totalQty;
      const stamp = `${batch.date} / ${batch.batchName} / +${newQty}${item.unit}`;
      target.note = (target.note ? (target.note + " | ") : "") + stamp;
      target.updatedAt = new Date().toISOString();
      item.inventoryItemId = target.id;
      hist.unshift({
        at: new Date().toISOString(),
        batchId: batch.batchId,
        batchName: batch.batchName,
        date: batch.date,
        inventoryItemId: target.id,
        name: item.pName,
        qty: newQty,
        unit: item.unit,
        unitPriceKrw: unitPriceKrw,
        addedValueKrw: realTotalKrw,
        memo: item.memo || ""
      });
    });
    while(hist.length > 500) hist.pop();
    saveInv(inv);
    saveHist(hist);
  }
  function commitBatch() {
    const bName = $("bName").value.trim();
    const bCur  = $("bCur").value;
    let ex = n($("bEx").value || 1, 1);
    if(bCur === "KRW") ex = 1;
    const logi = n($("bLogi").value || 0, 0);
    if(!bName || draftLines.length === 0) {
      alert("ë°°ì¹˜ëª… ì…ë ¥ ë° í’ˆëª©ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.");
      return;
    }
    const batch = {
      batchId: crypto.randomUUID(),
      batchName: bName,
      date: $("bDate").value,
      currency: bCur,
      exchangeRate: ex,
      totalLogisticsKrw: logi,
      items: draftLines
    };
    const all = loadPur();
    all.unshift(batch);
    savePur(all);
    if($("chkToInventory").checked){
      transferToInventory(batch);
    }
    draftLines = [];
    $("bName").value = "";
    $("bLogi").value = "";
    if(bCur !== "KRW") $("bEx").value = "";
    refreshAutocomplete();
    render();
    validateForm();
    alert($("chkToInventory").checked
      ? "ë°°ì¹˜ ì €ì¥ ì™„ë£Œ + ì¬ê³ ë¡œ ì „ì†¡ ì™„ë£Œ"
      : "ë°°ì¹˜ ì €ì¥ ì™„ë£Œ");
  }
  function deleteBatch(id) {
    if(!confirm("í•´ë‹¹ ë°°ì¹˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const all = loadPur().filter(b => b.batchId !== id);
    savePur(all);
    render();
  }
  function exportJson(){
    const data = localStorage.getItem(PUR_KEY) || "[]";
    const blob = new Blob([data], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `GoLab_Purchases_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
  }
  function importJson(file){
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const data = JSON.parse(r.result);
        if(!Array.isArray(data)) throw new Error("not array");
        savePur(data);
        draftLines = [];
        render();
        validateForm();
        alert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ");
      }catch(e){
        alert("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    };
    r.readAsText(file);
  }
  function render() {
    const all = loadPur();
    const tb = $("tbody");
    tb.innerHTML = "";
    let totalKrwAsset = 0;
    if(draftLines.length > 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="10" style="background:#1a2b4b; text-align:center; color:var(--warn)">
        í˜„ì¬ ì…ë ¥ ì¤‘ì¸ í’ˆëª©ì´ ${draftLines.length}ê°œ ìˆìŠµë‹ˆë‹¤. ì˜¤ë¥¸ìª½ì—ì„œ "ë°°ì¹˜ ì €ì¥"ì„ ëˆ„ë¥´ì„¸ìš”.
      </td>`;
      tb.appendChild(tr);
    }
    all.forEach(batch => {
      const subTotalKrw = batch.items.reduce((sum, item) => {
        const itemAmountKrw = n(item.price) * n(item.qty) * n(batch.exchangeRate, 1);
        return sum + itemAmountKrw;
      }, 0);
      batch.items.forEach((item, idx) => {
        const itemKrwPure = n(item.price) * n(item.qty) * n(batch.exchangeRate, 1);
        const allocatedLogi = subTotalKrw > 0
          ? (itemKrwPure / subTotalKrw) * n(batch.totalLogisticsKrw)
          : 0;
        const realTotalKrw = itemKrwPure + allocatedLogi;
        const unitPriceKrw = (n(item.qty) > 0) ? (realTotalKrw / n(item.qty)) : 0;
        totalKrwAsset += realTotalKrw;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx === 0 ? `<b>${batch.batchName}</b><br><small class="muted">${batch.date}</small>` : ""}</td>
          <td>${item.pName}</td>
          <td>${n(item.qty).toLocaleString()} ${item.unit}</td>
          <td>${n(item.price).toLocaleString()} <span class="currency-tag">${batch.currency}</span></td>
          <td class="field-auto">${idx === 0 ? `â‚©${n(batch.exchangeRate,1).toLocaleString()}` : ""}</td>
          <td class="muted field-auto">â‚©${Math.round(allocatedLogi).toLocaleString()}</td>
          <td class="field-auto" style="color:var(--point); font-weight:900">â‚©${Math.round(realTotalKrw).toLocaleString()}</td>
          <td class="highlight field-auto">â‚©${Math.round(unitPriceKrw).toLocaleString()}</td>
          <td class="muted">${(item.memo||"").replaceAll("<","&lt;")}</td>
          <td>${idx === 0 ? `<button class="danger" style="padding:6px 10px; font-size:11px" data-del="${batch.batchId}">ì‚­ì œ</button>` : ""}</td>
        `;
        tb.appendChild(tr);
      });
    });
    $("kTotal").textContent = "â‚© " + Math.round(totalKrwAsset).toLocaleString();
    $("kBatch").textContent = all.length + " ê±´";
    tb.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.onclick = ()=> deleteBatch(btn.dataset.del);
    });
  }
  function computeAddLineState(){
    const name = ($("pName")?.value || "").trim();
    const qty  = n($("pQty")?.value);
    const unit = $("pUnit")?.value || "";
    const price = n($("pPrice")?.value);
    const memo = ($("pMemo")?.value || "").trim();
    const hasName  = !!name;
    const hasQty   = qty > 0;
    const hasUnit  = !!unit;
    const hasPrice = price > 0;
    if(!hasName || !hasQty || !hasUnit || !hasPrice){
      return { state: "disabled", message: "í’ˆëª…, ìˆ˜ëŸ‰, ë‹¨ìœ„, ë‹¨ê°€ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ë©´ ë¼ì¸ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." };
    }
    if(unit === "BOX" && !memo){
      return { state: "warning", message: "ë‹¨ìœ„ê°€ BOXì…ë‹ˆë‹¤. ë¹„ê³ ë€ì— ë°•ìŠ¤ë‹¹ êµ¬ì„± ìˆ˜ëŸ‰ì„ ì ì–´ì£¼ì„¸ìš”." };
    }
    return { state: "ready", message: "" };
  }
  function computeBatchSaveState(){
    const bName = ($("bName")?.value || "").trim();
    const bCur  = $("bCur")?.value || "KRW";
    const bEx   = n($("bEx")?.value);
    if(!bName){
      return { state: "disabled", message: "ë°°ì¹˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." };
    }
    if(draftLines.length < 1){
      return { state: "disabled", message: "í’ˆëª©ì„ 1ê°œ ì´ìƒ ì¶”ê°€í•´ì•¼ ë°°ì¹˜ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." };
    }
    if(bCur !== "KRW" && bEx <= 0){
      return { state: "disabled", message: "ì™¸í™” ë°°ì¹˜ì…ë‹ˆë‹¤. í™˜ìœ¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." };
    }
    return { state: "ready", message: `${draftLines.length}ê°œ í’ˆëª© ì¤€ë¹„ ì™„ë£Œ. ë°°ì¹˜ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.` };
  }
  function applyButtonState(btn, state){
    if(!btn) return;
    btn.classList.remove("save-disabled","save-ready","save-warning","save-error");
    btn.disabled = false;
    if(state === "disabled"){
      btn.classList.add("save-disabled");
      btn.disabled = true;
    }else if(state === "warning"){
      btn.classList.add("save-warning");
    }else if(state === "error"){
      btn.classList.add("save-error");
    }else{
      btn.classList.add("save-ready");
    }
  }
  function validateForm(){
    const addLine = computeAddLineState();
    applyButtonState($("btnAddLine"), addLine.state);
    const batch = computeBatchSaveState();
    applyButtonState($("btnCloseBatch"), batch.state);
    const statusEl = $("saveStatus");
    if(statusEl) statusEl.textContent = batch.message || addLine.message || "";
  }
  function setSaveErrorState(message){
    applyButtonState($("btnCloseBatch"), "error");
    const statusEl = $("saveStatus");
    if(statusEl) statusEl.textContent = message || "ì¹˜ëª…ì  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
  }
  function handleSaveClick(){
    const btn = $("btnCloseBatch");
    if(btn && btn.disabled) return;
    try{
      commitBatch();
    }catch(e){
      console.error(e);
      setSaveErrorState("ì¹˜ëª…ì  ì˜¤ë¥˜(ì „ì†¡ ì‹¤íŒ¨ ë“±)ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.");
    }
  }
  function bindEvents(){
    if(isEventBound) return;
    isEventBound = true;
    $("btnAddLine").onclick = addLine;
    $("btnCloseBatch").onclick = handleSaveClick;
    $("btnReset").onclick = () => {
      if(!confirm("ì´ í˜ì´ì§€(êµ¬ë§¤/ì…ê³ ) ë°ì´í„°ë§Œ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
      localStorage.removeItem(PUR_KEY);
      draftLines = [];
      render();
      validateForm();
      alert("ì´ˆê¸°í™” ì™„ë£Œ");
    };
    $("btnExport").onclick = exportJson;
    $("btnImport").onclick = ()=> $("fileIn").click();
    $("fileIn").addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if(f) importJson(f);
      e.target.value = "";
    });
    $("bCur").addEventListener("change", ()=>{
      if($("bCur").value === "KRW"){
        $("bEx").value = "1";
      }
      validateForm();
    });
    $("bName").addEventListener("input", validateForm);
    $("bEx").addEventListener("input", validateForm);
    $("pUnit").addEventListener("change", () => {
      updateMemoHighlight();
      validateForm();
    });
    $("pName").addEventListener("input", validateForm);
    $("pQty").addEventListener("input", validateForm);
    $("pPrice").addEventListener("input", validateForm);
    $("pMemo").addEventListener("input", validateForm);
  }
  function updateMemoHighlight(){
    const unit = $("pUnit").value;
    const memoInput = $("pMemo");
    if(!memoInput) return;
    if(unit === "BOX"){
      memoInput.classList.add("memo-box-highlight");
      memoInput.placeholder = "ì˜ˆ: 24 EA / BOX";
    }else{
      memoInput.classList.remove("memo-box-highlight");
      memoInput.placeholder = "íŠ¹ì´ì‚¬í•­ ê¸°ë¡";
    }
  }
  updateMemoHighlight();
  refreshAutocomplete();
  render();
  bindEvents();
  validateForm();
</script>
</body>
</html>
