<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoLab Â· êµ¬ë§¤ ì›ì¥ (Purchase Ledger)</title>
  <style>
    :root{
      --bg:#f5f7fa;--card:#ffffff;--muted:#64748b;--text:#0f172a;
      --line:#e5e7eb;--accent:#16a34a;--warn:#d97706;--bad:#dc2626;--point:#2563eb;
      --chip:#f8fafc;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR",Arial;}
    header{padding:14px 18px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(8px);z-index:10}
    header .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    header h1{margin:0;font-size:16px;letter-spacing:.2px;color:var(--point)}
    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tab{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid var(--line);color:var(--muted);text-decoration:none;background:transparent;font-size:12px}
    .tab.active{color:var(--point);background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.3)}
    .wrap{max-width:1440px;margin:0 auto;padding:16px 16px 36px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:20px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .card h2{margin:0 0 12px;font-size:13px;color:var(--point);display:flex;align-items:center;gap:8px}
    /* KPI */
    .kpi-grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
    .kpi{padding:14px;border-radius:10px;border:1px solid var(--line);background:var(--card);box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{margin-top:6px;font-size:24px;font-weight:600;color:var(--point)}
    .kpi .v.blue{color:var(--point)}
    .kpi .sub{margin-top:4px;font-size:10px;color:var(--muted);font-weight:400}
    /* Form */
    .row{display:grid;gap:10px;margin-bottom:10px}
    .r2{grid-template-columns:1fr 1fr}
    .r3{grid-template-columns:1fr 1fr 1fr}
    .r4{grid-template-columns:1fr 1fr 1fr 1fr}
    .r5{grid-template-columns:1fr 1fr 1fr 1fr 1fr}
    label{display:block;font-size:11px;color:var(--muted);margin-bottom:5px;font-weight:700}
    label .opt{font-weight:400;color:#94a3b8}
    input,select{width:100%;border-radius:10px;border:1px solid var(--line);background:var(--chip);color:var(--text);padding:9px 10px;font-size:12px;outline:none;transition:border .2s}
    input:focus,select:focus{border-color:var(--point)}
    input::placeholder{color:#94a3b8}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{border:1px solid var(--line);background:var(--card);color:var(--text);border-radius:10px;padding:10px 14px;font-size:12px;cursor:pointer;font-weight:700}
    button:hover{border-color:#cbd5e1;background:#f8fafc}
    button.primary{background:var(--point);border:none;color:#fff}
    button.primary:hover{background:#1d4ed8}
    button.save{background:var(--accent);border:none;color:#fff}
    button.danger{color:var(--bad);background:none;border:1px solid rgba(220,38,38,.3)}
    button.secondary{background:rgba(37,99,235,.06);border:1px solid rgba(37,99,235,.25);color:var(--point)}
    button:disabled{opacity:.5;cursor:not-allowed}
    /* Table */
    .tableWrap{overflow:auto;border-radius:10px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;min-width:1100px;font-size:12px}
    th{background:#f8fafc;color:var(--muted);text-align:left;padding:10px 12px;position:sticky;top:0;white-space:nowrap;z-index:2;border-bottom:1px solid var(--line)}
    th.num,td.num{text-align:right}
    td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
    tr:hover{background:rgba(37,99,235,.03)}
    .highlight{color:var(--accent);font-weight:900}
    .muted{color:var(--muted)}
    .mini{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.5}
    /* Filter */
    .filter-bar{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:12px}
    .filter-bar>div{flex:1;min-width:130px}
    .filter-bar .wide{flex:2;min-width:200px}
    .tools-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .stat-inline{font-size:11px;color:var(--muted);margin-left:auto}
    /* Pagination */
    .pagination{display:flex;gap:6px;align-items:center;justify-content:center;margin-top:12px}
    .pagination button{padding:6px 12px;font-size:11px}
    .pagination .current{color:var(--point);font-weight:900;font-size:12px}
    input[type="file"]{display:none}
    .note-box{padding:12px;background:rgba(37,99,235,.04);border-left:3px solid var(--point);font-size:12px;color:var(--muted);line-height:1.6;border-radius:10px}
    @media(max-width:900px){
      .kpi-grid{grid-template-columns:1fr 1fr}
      .r4,.r5{grid-template-columns:1fr 1fr}
      .filter-bar{flex-direction:column}
    }
  </style>
</head>
<body>
<header>
  <div class="top">
    <h1>GoLab Â· êµ¬ë§¤ ì›ì¥</h1>
    <nav class="tabs">
      <a class="tab" href="./console.html">ğŸ¯ ì½˜ì†”</a>
      <a class="tab" href="./purchases.html">ğŸ“¦ ì…ê³ /ì›ê°€</a>
      <a class="tab" href="./index.html">ğŸ“ ì¬ê³  í˜„í™©</a>
      <a class="tab active" href="./trade.html">ğŸ“Š êµ¬ë§¤ ì´ë ¥</a>
      <a class="tab" href="./sales.html">ğŸ’° ë§¤ì¶œ ê´€ë¦¬</a>
      <a class="tab" href="./calendar.html">ğŸ“… ìº˜ë¦°ë”</a>
    </nav>
  </div>
</header>
<div class="wrap">

  <!-- KPI -->
  <div class="card">
    <h2>ğŸ“Š êµ¬ë§¤ í˜„í™©</h2>
    <div class="kpi-grid">
      <div class="kpi">
        <div class="t">ì´ êµ¬ë§¤ì•¡</div>
        <div id="kTotal" class="v">â‚© 0</div>
        <div id="kTotalSub" class="sub"></div>
      </div>
      <div class="kpi">
        <div class="t">ê±°ë˜ ê±´ìˆ˜</div>
        <div id="kCount" class="v">0 ê±´</div>
        <div id="kCountSub" class="sub"></div>
      </div>
      <div class="kpi">
        <div class="t">ê±°ë˜ì²˜ ìˆ˜</div>
        <div id="kVendors" class="v">0</div>
        <div id="kVendorsSub" class="sub"></div>
      </div>
      <div class="kpi">
        <div class="t">ìµœê·¼ ê±°ë˜ì¼</div>
        <div id="kLatest" class="v blue">-</div>
        <div id="kLatestSub" class="sub"></div>
      </div>
    </div>
  </div>

  <!-- Input Form -->
  <div class="card">
    <h2>â• êµ¬ë§¤ ë“±ë¡</h2>
    <div class="row r4">
      <div>
        <label>êµ¬ë§¤ì¼</label>
        <input id="inDate" type="date" />
      </div>
      <div>
        <label>êµ¬ë§¤ì²˜(ê³µê¸‰ì‚¬)</label>
        <input id="inVendor" list="dlVendor" placeholder="ì˜ˆ: ì½”ì•„í…Œí¬" />
        <datalist id="dlVendor"></datalist>
      </div>
      <div>
        <label>ë¬¸ì„œë²ˆí˜¸ <span class="opt">(ì„ íƒ)</span></label>
        <input id="inDocNo" placeholder="ì¸ë³´ì´ìŠ¤/PO ë²ˆí˜¸" />
      </div>
      <div>
        <label>í’ˆë²ˆ <span class="opt">(ì„ íƒ)</span></label>
        <input id="inPartNo" list="dlPartNo" placeholder="ì˜ˆ: AGC-123" />
        <datalist id="dlPartNo"></datalist>
      </div>
    </div>
    <div class="row r5">
      <div>
        <label>ìƒí’ˆëª…</label>
        <input id="inItem" list="dlItem" placeholder="ì˜ˆ: Silver Powder 1kg" />
        <datalist id="dlItem"></datalist>
      </div>
      <div>
        <label>ìˆ˜ëŸ‰</label>
        <input id="inQty" type="number" step="0.01" placeholder="0" />
      </div>
      <div>
        <label>ë‹¨ìœ„</label>
        <select id="inUnit">
          <option value="ea" selected>ea</option>
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="BOX">BOX</option>
          <option value="SET">SET</option>
          <option value="L">L</option>
          <option value="mL">mL</option>
        </select>
      </div>
      <div>
        <label>êµ¬ë§¤ ë‹¨ê°€ (KRW)</label>
        <input id="inPrice" type="number" step="1" placeholder="â‚© ë‹¨ê°€" />
      </div>
      <div>
        <label>ë¹„ê³  <span class="opt">(ì„ íƒ)</span></label>
        <input id="inMemo" placeholder="íŠ¹ì´ì‚¬í•­" />
      </div>
    </div>
    <div class="row r4">
      <div style="grid-column:span 2"></div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="btnAdd" class="save" style="flex:1">ë“±ë¡</button>
        <button id="btnCancel" class="secondary" style="display:none;flex:1">ì·¨ì†Œ</button>
      </div>
      <div>
        <div id="formCalc" class="mini" style="text-align:right;margin-top:0;padding-top:12px"></div>
      </div>
    </div>
  </div>

  <!-- List -->
  <div class="card">
    <h2>
      ğŸ“‹ êµ¬ë§¤ ë‚´ì—­
      <span id="filterInfo" class="stat-inline"></span>
    </h2>
    <div class="filter-bar">
      <div class="wide">
        <label>ê²€ìƒ‰ (ìƒí’ˆëª…/í’ˆë²ˆ/êµ¬ë§¤ì²˜/ë¹„ê³ )</label>
        <input id="fSearch" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." />
      </div>
      <div>
        <label>êµ¬ë§¤ì²˜</label>
        <select id="fVendor"><option value="">ì „ì²´</option></select>
      </div>
      <div>
        <label>ì‹œì‘ì¼</label>
        <input id="fFrom" type="date" />
      </div>
      <div>
        <label>ì¢…ë£Œì¼</label>
        <input id="fTo" type="date" />
      </div>
    </div>
    <div class="tools-row">
      <button id="btnExport" class="secondary">ë‚´ë³´ë‚´ê¸°(JSON)</button>
      <button id="btnImport" class="secondary">ê°€ì ¸ì˜¤ê¸°(JSON)</button>
      <input id="fileIn" type="file" accept="application/json" />
      <button id="btnReset" class="danger">ì „ì²´ ì´ˆê¸°í™”</button>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>êµ¬ë§¤ì¼</th>
            <th>êµ¬ë§¤ì²˜</th>
            <th>ë¬¸ì„œë²ˆí˜¸</th>
            <th>í’ˆë²ˆ</th>
            <th>ìƒí’ˆëª…</th>
            <th class="num">ìˆ˜ëŸ‰</th>
            <th>ë‹¨ìœ„</th>
            <th class="num">êµ¬ë§¤ë‹¨ê°€</th>
            <th class="num">êµ¬ë§¤ì´ì•¡</th>
            <th>ë¹„ê³ </th>
            <th style="text-align:right">ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="pagination" id="pgArea"></div>
    <div class="mini">â€» êµ¬ë§¤ì´ì•¡ = ìˆ˜ëŸ‰ x êµ¬ë§¤ë‹¨ê°€ (ìë™ ê³„ì‚°)</div>
  </div>

  <div class="note-box">
    ğŸ’¡ ì´ í˜ì´ì§€ëŠ” <b>êµ¬ë§¤ ì›ê°€ ê´€ë¦¬</b> ì „ìš©ì…ë‹ˆë‹¤. íŒë§¤/ë§ˆì§„ ë¶„ì„ì€ í–¥í›„ ë§¤ì¶œ ëª¨ë“ˆì—ì„œ ë³„ë„ ì²˜ë¦¬ë©ë‹ˆë‹¤.
  </div>
</div>

<script>
/* â”€â”€ Constants â”€â”€ */
const TRADE_KEY = "golab_trade_v1";
const AUDIT_KEY = "golab_trade_audit";
const PAGE_SIZE = 50;
const DEBOUNCE_MS = 300;
const $ = id => document.getElementById(id);

/* â”€â”€ Audit Log â”€â”€ */
function emitAudit(event, detail){
  // event: CREATE | UPDATE | DELETE | IMPORTED
  try{
    const log = JSON.parse(localStorage.getItem(AUDIT_KEY)||"[]");
    log.push({
      event,
      ts: new Date().toISOString(),
      detail: detail || {}
    });
    // Keep last 2000 entries to prevent localStorage bloat
    if(log.length>2000) log.splice(0, log.length-2000);
    localStorage.setItem(AUDIT_KEY, JSON.stringify(log));
  }catch(e){ /* silent */ }
}

/* â”€â”€ State â”€â”€ */
let editingId = null;
let currentPage = 1;
let debounceTimer = null;
let _cache = null;          // in-memory cache

/* â”€â”€ Init date â”€â”€ */
$("inDate").value = new Date().toISOString().substring(0,10);

/* â”€â”€ Helpers â”€â”€ */
function n(v,fb=0){ const x=Number(v); return Number.isFinite(x)?x:fb; }
function esc(s){ return (s||"").replace(/</g,"&lt;"); }
function fmt(v){ return "â‚©"+Math.round(v).toLocaleString(); }
function normStr(s){ return (s==null)?"":String(s).trim(); }
function normUpper(s){ return normStr(s).toUpperCase(); }
function normNum(v){
  if(v==null) return 0;
  if(typeof v==="number") return Number.isFinite(v)?v:0;
  const cleaned = String(v).replace(/[â‚©,\s]/g,"");
  const x = Number(cleaned);
  return Number.isFinite(x)?x:0;
}
function normDate(v){
  if(!v) return "";
  if(v instanceof Date){
    const y=v.getFullYear(), m=String(v.getMonth()+1).padStart(2,"0"), d=String(v.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+d;
  }
  if(typeof v==="number"){
    // Excel serial date â€” UTC-safe: use manual calculation instead of Date constructor
    const base=new Date(1899,11,30); // local time
    base.setDate(base.getDate()+Math.floor(v));
    const y=base.getFullYear(), m=String(base.getMonth()+1).padStart(2,"0"), d=String(base.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+d;
  }
  let s=String(v).trim();
  // Handle YYYY.MM.DD and YYYY/MM/DD
  s=s.replace(/^(\d{4})[./](\d{1,2})[./](\d{1,2})/, (_, y, m, d) =>
    y+"-"+m.padStart(2,"0")+"-"+d.padStart(2,"0")
  );
  if(s.length>=10) return s.substring(0,10);
  return s;
}

/* â”€â”€ Deterministic itemId (djb2 hash) â”€â”€ */
function deterministicItemId(vendor, partNo, itemName){
  const src = [vendor, partNo, itemName].map(s=>normStr(s).toLowerCase()).join("|");
  let h = 5381;
  for(let i=0;i<src.length;i++) h = ((h<<5)+h) + src.charCodeAt(i);
  return "item-"+(h>>>0).toString(16).padStart(8,"0");
}

/* â”€â”€ Storage â”€â”€ */
function load(){
  if(_cache) return _cache;
  try{ _cache=JSON.parse(localStorage.getItem(TRADE_KEY)||"[]"); }
  catch{ _cache=[]; }
  return _cache;
}
function save(data){
  _cache=data;
  localStorage.setItem(TRADE_KEY,JSON.stringify(data));
}
function invalidateCache(){ _cache=null; }

/* â”€â”€ Normalize record â”€â”€ */
function normalizeRecord(r){
  const vendor = normStr(r.vendor);
  const partNo = normUpper(r.partNo);
  const itemName = normStr(r.itemName || r.product || "");
  return {
    id: r.id || crypto.randomUUID(),
    purchaseDate: normDate(r.purchaseDate || r.date || ""),
    vendor,
    docNo: normStr(r.docNo),
    itemId: r.itemId || deterministicItemId(vendor, partNo, itemName),
    partNo,
    itemName,
    qty: normNum(r.qty),
    unit: normStr(r.unit) || "ea",
    buyUnitPrice: normNum(r.buyUnitPrice || r.buyPrice || 0),
    memo: normStr(r.memo || r.note || ""),
    createdAt: r.createdAt || new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
}

/* â”€â”€ Autocomplete â”€â”€ */
function uniqueVals(key){
  return [...new Set(load().map(r=>normStr(r[key])).filter(Boolean))].sort();
}
function refreshAC(){
  const fill=(dlId,key)=>{
    const dl=$(dlId); dl.innerHTML="";
    uniqueVals(key).forEach(v=>{ const o=document.createElement("option"); o.value=v; dl.appendChild(o); });
  };
  fill("dlVendor","vendor");
  fill("dlPartNo","partNo");
  fill("dlItem","itemName");
}

/* â”€â”€ Filters â”€â”€ */
function refreshFilterSelects(){
  const sel=$("fVendor");
  const cur=sel.value;
  const opts=uniqueVals("vendor");
  sel.innerHTML='<option value="">ì „ì²´</option>';
  opts.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); });
  sel.value=cur;
}

function getFiltered(){
  let data=load();
  const q=($("fSearch").value||"").trim().toLowerCase();
  const vendor=$("fVendor").value;
  const from=$("fFrom").value;
  const to=$("fTo").value;
  if(q){
    data=data.filter(r=>
      (r.itemName||"").toLowerCase().includes(q)||
      (r.partNo||"").toLowerCase().includes(q)||
      (r.vendor||"").toLowerCase().includes(q)||
      (r.memo||"").toLowerCase().includes(q)||
      (r.docNo||"").toLowerCase().includes(q)
    );
  }
  if(vendor) data=data.filter(r=>r.vendor===vendor);
  if(from) data=data.filter(r=>(r.purchaseDate||"")>=from);
  if(to) data=data.filter(r=>(r.purchaseDate||"")<=to);
  return data;
}

/* â”€â”€ KPI â”€â”€ */
function hasActiveFilter(){
  return !!($("fSearch").value||"").trim()
    || !!$("fVendor").value
    || !!$("fFrom").value
    || !!$("fTo").value;
}
function computeKPI(){
  const all=load();
  const filtered=getFiltered();
  const isFiltered = hasActiveFilter();

  const calc=(arr)=>{
    let total=0; const vendors=new Set(); let latest="";
    arr.forEach(r=>{
      total += n(r.buyUnitPrice)*n(r.qty);
      if(r.vendor) vendors.add(r.vendor);
      if(r.purchaseDate && r.purchaseDate>latest) latest=r.purchaseDate;
    });
    return {total,count:arr.length,vendors:vendors.size,latest};
  };

  const a=calc(all);
  const f=isFiltered?calc(filtered):null;

  $("kTotal").textContent = fmt(a.total);
  $("kCount").textContent = a.count.toLocaleString()+" ê±´";
  $("kVendors").textContent = a.vendors.toLocaleString();
  $("kLatest").textContent = a.latest || "-";

  if(f){
    $("kTotalSub").textContent = "í•„í„°: "+fmt(f.total);
    $("kCountSub").textContent = "í•„í„°: "+f.count.toLocaleString()+" ê±´";
    $("kVendorsSub").textContent = "í•„í„°: "+f.vendors.toLocaleString();
    $("kLatestSub").textContent = "í•„í„°: "+(f.latest||"-");
  } else {
    $("kTotalSub").textContent="";
    $("kCountSub").textContent="";
    $("kVendorsSub").textContent="";
    $("kLatestSub").textContent="";
  }
}

/* â”€â”€ Form calc preview â”€â”€ */
function updateFormCalc(){
  const qty=n($("inQty").value);
  const price=n($("inPrice").value);
  const el=$("formCalc");
  if(qty>0 && price>0){
    el.textContent="êµ¬ë§¤ì´ì•¡: "+fmt(qty*price);
  } else {
    el.textContent="";
  }
}

/* â”€â”€ Render â”€â”€ */
function render(){
  const filtered=getFiltered();
  const total=load().length;
  const totalPages=Math.max(1,Math.ceil(filtered.length/PAGE_SIZE));
  if(currentPage>totalPages) currentPage=totalPages;
  const start=(currentPage-1)*PAGE_SIZE;
  const page=filtered.slice(start,start+PAGE_SIZE);

  $("filterInfo").textContent = filtered.length===total
    ? total+"ê±´"
    : filtered.length+" / "+total+"ê±´ (í•„í„° ì ìš© ì¤‘)";

  const tb=$("tbody");
  tb.innerHTML="";
  if(page.length===0){
    tb.innerHTML='<tr><td colspan="11" class="muted" style="text-align:center;padding:24px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
  }
  page.forEach(r=>{
    const buyTotal=n(r.buyUnitPrice)*n(r.qty);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="muted">${esc(r.purchaseDate)}</td>
      <td><b>${esc(r.vendor)}</b></td>
      <td class="muted">${esc(r.docNo)}</td>
      <td class="muted">${esc(r.partNo)}</td>
      <td>${esc(r.itemName)}</td>
      <td class="num">${n(r.qty).toLocaleString()}</td>
      <td class="muted">${esc(r.unit)}</td>
      <td class="num">${fmt(n(r.buyUnitPrice))}</td>
      <td class="num highlight">${fmt(buyTotal)}</td>
      <td class="muted">${esc(r.memo)}</td>
      <td style="text-align:right;white-space:nowrap">
        <button class="secondary" style="padding:5px 8px;font-size:11px" data-edit="${r.id}">ìˆ˜ì •</button>
        <button class="danger" style="padding:5px 8px;font-size:11px" data-del="${r.id}">ì‚­ì œ</button>
      </td>`;
    tb.appendChild(tr);
  });

  tb.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.onclick=e=>{ e.stopPropagation(); deleteRecord(btn.dataset.del); };
  });
  tb.querySelectorAll("button[data-edit]").forEach(btn=>{
    btn.onclick=e=>{ e.stopPropagation(); startEdit(btn.dataset.edit); };
  });

  // Pagination
  const pg=$("pgArea");
  pg.innerHTML="";
  if(totalPages>1){
    const mk=(label,p,dis)=>{
      const b=document.createElement("button");
      b.textContent=label; b.className="secondary"; b.disabled=dis;
      b.onclick=()=>{ currentPage=p; render(); };
      return b;
    };
    pg.appendChild(mk("â—€ ì´ì „",currentPage-1,currentPage<=1));
    const s=document.createElement("span");
    s.className="current";
    s.textContent=currentPage+" / "+totalPages;
    pg.appendChild(s);
    pg.appendChild(mk("ë‹¤ìŒ â–¶",currentPage+1,currentPage>=totalPages));
  }
}

/* â”€â”€ CRUD â”€â”€ */
function clearForm(){
  $("inDate").value=new Date().toISOString().substring(0,10);
  $("inVendor").value=""; $("inDocNo").value=""; $("inPartNo").value="";
  $("inItem").value=""; $("inQty").value=""; $("inUnit").value="ea";
  $("inPrice").value=""; $("inMemo").value="";
  editingId=null;
  $("btnAdd").textContent="ë“±ë¡";
  $("btnCancel").style.display="none";
  $("formCalc").textContent="";
}

function addOrUpdate(){
  const vendor=normStr($("inVendor").value);
  const itemName=normStr($("inItem").value);
  if(!vendor && !itemName){ alert("êµ¬ë§¤ì²˜ ë˜ëŠ” ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

  const rec=normalizeRecord({
    id: editingId||undefined,
    itemId: editingId ? (load().find(x=>x.id===editingId)||{}).itemId : undefined,
    purchaseDate: $("inDate").value,
    vendor,
    docNo: $("inDocNo").value,
    partNo: $("inPartNo").value,
    itemName,
    qty: $("inQty").value,
    unit: $("inUnit").value,
    buyUnitPrice: $("inPrice").value,
    memo: $("inMemo").value,
    createdAt: editingId ? (load().find(x=>x.id===editingId)||{}).createdAt : undefined
  });

  const all=load();
  if(editingId){
    const idx=all.findIndex(x=>x.id===editingId);
    if(idx>=0) all[idx]=rec;
    emitAudit("UPDATE",{id:rec.id, vendor:rec.vendor, itemName:rec.itemName});
  } else {
    all.unshift(rec);
    emitAudit("CREATE",{id:rec.id, vendor:rec.vendor, itemName:rec.itemName});
  }
  save(all);
  clearForm();
  refreshAC();
  refreshFilterSelects();
  computeKPI();
  render();
}

function startEdit(id){
  const r=load().find(x=>x.id===id);
  if(!r) return;
  editingId=r.id;
  $("inDate").value=r.purchaseDate||"";
  $("inVendor").value=r.vendor||"";
  $("inDocNo").value=r.docNo||"";
  $("inPartNo").value=r.partNo||"";
  $("inItem").value=r.itemName||"";
  $("inQty").value=n(r.qty)||"";
  $("inUnit").value=r.unit||"ea";
  $("inPrice").value=n(r.buyUnitPrice)||"";
  $("inMemo").value=r.memo||"";
  $("btnAdd").textContent="ì €ì¥";
  $("btnCancel").style.display="block";
  updateFormCalc();
  window.scrollTo({top:0,behavior:"smooth"});
}

function deleteRecord(id){
  if(!confirm("ì´ êµ¬ë§¤ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  const target=load().find(x=>x.id===id);
  if(target) emitAudit("DELETE",{id, vendor:target.vendor, itemName:target.itemName});
  save(load().filter(x=>x.id!==id));
  refreshFilterSelects();
  computeKPI();
  render();
}

/* â”€â”€ Import/Export â”€â”€ */
function exportJson(){
  const data=localStorage.getItem(TRADE_KEY)||"[]";
  const blob=new Blob([data],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="GoLab_PurchaseLedger_"+new Date().toISOString().slice(0,10)+".json";
  a.click();
}

/* â”€â”€ Duplicate detection key â”€â”€ */
function dupKey(r){
  return [r.purchaseDate, r.vendor, r.partNo, String(r.qty), String(r.buyUnitPrice)].join("|");
}

function importJson(file){
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const raw=JSON.parse(reader.result);
      if(!Array.isArray(raw)) throw new Error("JSON ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.");
      let ok=0, skip=0, dup=0;
      const cleaned=[];

      // Build duplicate lookup from existing data
      const existing=load();
      const existingKeys=new Set(existing.map(r=>dupKey(r)));

      raw.forEach((r,i)=>{
        try{
          const rec=normalizeRecord(r);
          const key=dupKey(rec);
          if(existingKeys.has(key)){
            dup++;
            return;
          }
          existingKeys.add(key); // prevent dupes within import file too
          cleaned.push(rec);
          ok++;
        }catch(e){
          skip++;
        }
      });

      if(skip>0) alert(skip+"ê±´ì˜ ë°ì´í„°ê°€ í˜•ì‹ ì˜¤ë¥˜ë¡œ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.");
      const merged=[...cleaned,...existing];
      save(merged);
      invalidateCache();
      refreshAC();
      refreshFilterSelects();
      computeKPI();
      render();

      emitAudit("IMPORTED",{added:ok, duplicates:dup, skipped:skip, totalAfter:merged.length});

      let msg=ok+"ê±´ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ (ê¸°ì¡´ "+existing.length+"ê±´ + ì‹ ê·œ "+ok+"ê±´ = ì´ "+merged.length+"ê±´)";
      if(dup>0) msg+="\nì¤‘ë³µ ê±´ë„ˆë›°ê¸°: "+dup+"ê±´";
      alert(msg);
    }catch(e){
      alert("JSON í˜•ì‹ ì˜¤ë¥˜: "+e.message);
    }
  };
  reader.readAsText(file);
}

/* â”€â”€ Debounced filter â”€â”€ */
function debouncedRender(){
  clearTimeout(debounceTimer);
  debounceTimer=setTimeout(()=>{
    currentPage=1;
    computeKPI();
    render();
  },DEBOUNCE_MS);
}

/* â”€â”€ Events â”€â”€ */
$("btnAdd").onclick=addOrUpdate;
$("btnCancel").onclick=clearForm;
$("btnExport").onclick=exportJson;
$("btnImport").onclick=()=>$("fileIn").click();
$("fileIn").addEventListener("change",e=>{
  const f=e.target.files?.[0];
  if(f) importJson(f);
  e.target.value="";
});
$("btnReset").onclick=()=>{
  if(!confirm("êµ¬ë§¤ ì›ì¥ ë°ì´í„°ë¥¼ ì „ì²´ ì´ˆê¸°í™”í• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)")) return;
  localStorage.removeItem(TRADE_KEY);
  invalidateCache();
  currentPage=1;
  refreshAC();
  refreshFilterSelects();
  computeKPI();
  render();
  alert("ì´ˆê¸°í™” ì™„ë£Œ");
};

// Filter events (debounced)
$("fSearch").addEventListener("input",debouncedRender);
$("fVendor").addEventListener("change",()=>{ currentPage=1; computeKPI(); render(); });
$("fFrom").addEventListener("change",()=>{ currentPage=1; computeKPI(); render(); });
$("fTo").addEventListener("change",()=>{ currentPage=1; computeKPI(); render(); });

// Form calc preview
$("inQty").addEventListener("input",updateFormCalc);
$("inPrice").addEventListener("input",updateFormCalc);

/* â”€â”€ Init â”€â”€ */
refreshAC();
refreshFilterSelects();
computeKPI();
render();
</script>
</body>
</html>
