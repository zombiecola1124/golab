<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoLab Â· êµ¬ë§¤ ì›ì¥ (Purchase Ledger)</title>
  <style>
    :root{
      --bg:#f5f7fa;--card:#ffffff;--muted:#64748b;--text:#0f172a;
      --line:#e5e7eb;--accent:#16a34a;--warn:#d97706;--bad:#dc2626;--point:#2563eb;
      --chip:#f8fafc;--purple:#7c3aed;--orange:#d97706;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR",Arial;}
    header{padding:14px 18px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(8px);z-index:10}
    header .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    header h1{margin:0;font-size:16px;letter-spacing:.2px;color:var(--point)}
    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tab{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid var(--line);color:var(--muted);text-decoration:none;background:transparent;font-size:12px}
    .tab.active{color:var(--point);background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.3)}
    .wrap{max-width:1440px;margin:0 auto;padding:16px 16px 36px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:20px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .card h2{margin:0 0 12px;font-size:13px;color:var(--point);display:flex;align-items:center;gap:8px}
    /* KPI */
    .kpi-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .kpi{padding:14px;border-radius:10px;border:1px solid var(--line);background:var(--card);box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{margin-top:6px;font-size:24px;font-weight:600;color:var(--point)}
    .kpi .v.blue{color:var(--point)}
    .kpi .v.orange{color:var(--warn)}
    .kpi .sub{margin-top:4px;font-size:10px;color:var(--muted);font-weight:400}
    /* Form */
    .row{display:grid;gap:10px;margin-bottom:10px}
    .r2{grid-template-columns:1fr 1fr}
    .r3{grid-template-columns:1fr 1fr 1fr}
    .r4{grid-template-columns:1fr 1fr 1fr 1fr}
    .r5{grid-template-columns:1fr 1fr 1fr 1fr 1fr}
    label{display:block;font-size:11px;color:var(--muted);margin-bottom:5px;font-weight:700}
    label .opt{font-weight:400;color:#94a3b8}
    input,select,textarea{width:100%;border-radius:10px;border:1px solid var(--line);background:var(--chip);color:var(--text);padding:9px 10px;font-size:12px;outline:none;transition:border .2s}
    input:focus,select:focus,textarea:focus{border-color:var(--point)}
    input::placeholder{color:#94a3b8}
    textarea{resize:vertical;min-height:36px}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{border:1px solid var(--line);background:var(--card);color:var(--text);border-radius:10px;padding:10px 14px;font-size:12px;cursor:pointer;font-weight:700}
    button:hover{border-color:#cbd5e1;background:#f8fafc}
    button.primary{background:var(--point);border:none;color:#fff}
    button.primary:hover{background:#1d4ed8}
    button.save{background:var(--accent);border:none;color:#fff}
    button.save:hover{background:#15803d}
    button.danger{color:var(--bad);background:none;border:1px solid rgba(220,38,38,.3)}
    button.secondary{background:rgba(37,99,235,.06);border:1px solid rgba(37,99,235,.25);color:var(--point)}
    button.receive-btn{background:rgba(37,99,235,.08);border:1px solid rgba(37,99,235,.3);color:var(--point);padding:5px 8px;font-size:11px}
    button.receive-btn:hover{background:rgba(37,99,235,.15)}
    button:disabled{opacity:.5;cursor:not-allowed}
    /* Table */
    .tableWrap{overflow:auto;border-radius:10px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;min-width:1300px;font-size:12px}
    th{background:#f8fafc;color:var(--muted);text-align:left;padding:10px 12px;position:sticky;top:0;white-space:nowrap;z-index:2;border-bottom:1px solid var(--line)}
    th.num,td.num{text-align:right}
    td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
    tr:hover{background:rgba(37,99,235,.03)}
    .highlight{color:var(--accent);font-weight:900}
    .muted{color:var(--muted)}
    .mini{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.5}
    /* Status tags */
    .status-tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:10px;font-weight:700;letter-spacing:.2px}
    .status-tag.ORDERED{background:#dbeafe;color:#1e40af}
    .status-tag.PARTIAL{background:#fef3c7;color:#92400e}
    .status-tag.RECEIVED{background:#dcfce7;color:#166534}
    /* Vendor link */
    .vendor-link{color:var(--point);cursor:pointer;font-weight:700}
    .vendor-link:hover{text-decoration:underline}
    /* Filter */
    .filter-bar{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:12px}
    .filter-bar>div{flex:1;min-width:110px}
    .filter-bar .wide{flex:2;min-width:200px}
    .tools-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .stat-inline{font-size:11px;color:var(--muted);margin-left:auto}
    /* Pagination */
    .pagination{display:flex;gap:6px;align-items:center;justify-content:center;margin-top:12px}
    .pagination button{padding:6px 12px;font-size:11px}
    .pagination .current{color:var(--point);font-weight:900;font-size:12px}
    input[type="file"]{display:none}
    .note-box{padding:12px;background:rgba(37,99,235,.04);border-left:3px solid var(--point);font-size:12px;color:var(--muted);line-height:1.6;border-radius:10px}
    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:999}
    .modalBack.open{display:flex}
    .modal{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.12);width:min(440px,92vw)}
    .modal h3{margin:0 0 14px;font-size:14px;color:var(--text)}
    .modal .info-row{display:flex;justify-content:space-between;padding:4px 0;font-size:12px}
    .modal .info-row .label{color:var(--muted)}
    .modal .info-row .value{font-weight:700}
    .modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
    .rcv-remaining{font-size:11px;color:var(--muted);margin-top:4px}
    .rcv-error{font-size:11px;color:var(--bad);margin-top:4px;display:none;font-weight:600}
    /* Toast */
    .toast{position:fixed;bottom:24px;right:24px;background:#166534;color:#fff;
      padding:14px 20px;border-radius:10px;font-size:13px;font-weight:600;
      box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:300;opacity:0;
      transform:translateY(10px);transition:all .3s ease;pointer-events:none}
    .toast.show{opacity:1;transform:translateY(0)}
    /* Drawer */
    .drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.2);z-index:90}
    .drawer-overlay.open{display:block}
    .drawer{position:fixed;top:0;right:-42%;width:40%;height:100vh;background:var(--bg);border-left:1px solid var(--line);z-index:100;overflow-y:auto;padding:0;transition:right .25s ease}
    .drawer.open{right:0}
    .drawer-header{padding:20px 20px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--bg);z-index:2}
    .drawer-header .top-row{display:flex;align-items:center;justify-content:space-between}
    .drawer-header h3{font-size:16px;font-weight:800;color:var(--text)}
    .drawer-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:4px 8px}
    .drawer-close:hover{color:var(--bad)}
    .drawer-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
    .d-stat{padding:10px;background:var(--card);border:1px solid var(--line);border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .d-stat .t{font-size:9px;color:var(--muted);font-weight:700;text-transform:uppercase}
    .d-stat .v{font-size:14px;font-weight:900;margin-top:3px;color:var(--text)}
    /* Drawer master info */
    .vendor-master{padding:16px 20px;border-bottom:1px solid var(--line)}
    .vendor-master .vm-row{display:flex;justify-content:space-between;padding:3px 0;font-size:12px}
    .vendor-master .vm-label{color:var(--muted);font-size:11px}
    .vendor-master .vm-value{font-weight:600}
    .vm-edit-form{display:none;padding:12px 0}
    .vm-edit-form label{margin-top:6px}
    .vm-edit-form input,.vm-edit-form textarea{margin-bottom:4px}
    /* Drawer tabs */
    .drawer-tabs{display:flex;border-bottom:1px solid var(--line);padding:0 20px}
    .drawer-tab{padding:10px 16px;font-size:12px;font-weight:700;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
    .drawer-tab:hover{color:var(--text)}
    .drawer-tab.active{color:var(--point);border-bottom-color:var(--point)}
    .drawer-panel{display:none;padding:16px 20px}
    .drawer-panel.active{display:block}
    .drawer-panel h4{font-size:11px;color:var(--muted);font-weight:700;margin-bottom:10px;text-transform:uppercase;letter-spacing:.3px}
    .drawer-purchase{font-size:12px;padding:8px 0;border-bottom:1px solid var(--line)}
    .drawer-purchase:last-child{border-bottom:none}
    .drawer-purchase .dp-top{display:flex;justify-content:space-between}
    .drawer-purchase .dp-item{font-weight:700}
    .drawer-purchase .dp-date{color:var(--muted);font-size:11px}
    .drawer-purchase .dp-detail{color:var(--muted);font-size:11px;margin-top:2px}
    .drawer-todo{font-size:12px;color:var(--text);padding:6px 0;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center}
    .drawer-todo:last-child{border-bottom:none}
    .drawer-todo .dt-dot{width:6px;height:6px;border-radius:50%;background:var(--orange);flex-shrink:0}
    @media(max-width:900px){
      .kpi-grid{grid-template-columns:1fr 1fr}
      .r4,.r5{grid-template-columns:1fr 1fr}
      .filter-bar{flex-direction:column}
      .drawer{width:100%;right:-102%}
    }
  </style>
</head>
<body>
<header>
  <div class="top">
    <h1>GoLab Â· êµ¬ë§¤ ì›ì¥</h1>
    <nav class="tabs">
      <a class="tab" href="./console.html">ğŸ¯ ì½˜ì†”</a>
      <a class="tab" href="./purchases.html">ğŸ“¦ ì…ê³ /ì›ê°€</a>
      <a class="tab" href="./index.html">ğŸ“ ì¬ê³  í˜„í™©</a>
      <a class="tab active" href="./trade.html">ğŸ“Š êµ¬ë§¤ ì´ë ¥</a>
      <a class="tab" href="./sales.html">ğŸ’° ë§¤ì¶œ ê´€ë¦¬</a>
      <a class="tab" href="./calendar.html">ğŸ“… ìº˜ë¦°ë”</a>
    </nav>
  </div>
</header>
<div class="wrap">

  <!-- KPI -->
  <div class="card">
    <h2>ğŸ“Š êµ¬ë§¤ í˜„í™©</h2>
    <div class="kpi-grid">
      <div class="kpi">
        <div class="t">ì´ êµ¬ë§¤ì•¡</div>
        <div id="kTotal" class="v">â‚©0</div>
        <div id="kTotalSub" class="sub"></div>
      </div>
      <div class="kpi">
        <div class="t">ê±°ë˜ ê±´ìˆ˜</div>
        <div id="kCount" class="v">0ê±´</div>
        <div id="kCountSub" class="sub"></div>
      </div>
      <div class="kpi">
        <div class="t">ê±°ë˜ì²˜ ìˆ˜</div>
        <div id="kVendors" class="v">0</div>
        <div id="kVendorsSub" class="sub"></div>
      </div>
      <div class="kpi">
        <div class="t">ë¯¸ì…ê³  ê±´ìˆ˜</div>
        <div id="kPending" class="v orange">0</div>
        <div id="kPendingSub" class="sub"></div>
      </div>
      <div class="kpi">
        <div class="t">ìµœê·¼ ê±°ë˜ì¼</div>
        <div id="kLatest" class="v blue">-</div>
        <div id="kLatestSub" class="sub"></div>
      </div>
    </div>
  </div>

  <!-- Input Form -->
  <div class="card">
    <h2>â• êµ¬ë§¤ ë“±ë¡</h2>
    <div class="row r4">
      <div>
        <label>êµ¬ë§¤ì¼</label>
        <input id="inDate" type="date" />
      </div>
      <div>
        <label>êµ¬ë§¤ì²˜(ê³µê¸‰ì‚¬)</label>
        <input id="inVendor" list="dlVendor" placeholder="ì˜ˆ: ì½”ì•„í…Œí¬" />
        <datalist id="dlVendor"></datalist>
      </div>
      <div>
        <label>ë¬¸ì„œë²ˆí˜¸ <span class="opt">(ì„ íƒ)</span></label>
        <input id="inDocNo" placeholder="ì¸ë³´ì´ìŠ¤/PO ë²ˆí˜¸" />
      </div>
      <div>
        <label>í’ˆë²ˆ <span class="opt">(ì„ íƒ)</span></label>
        <input id="inPartNo" list="dlPartNo" placeholder="ì˜ˆ: AGC-123" />
        <datalist id="dlPartNo"></datalist>
      </div>
    </div>
    <div class="row r5">
      <div>
        <label>ìƒí’ˆëª…</label>
        <input id="inItem" list="dlItem" placeholder="ì˜ˆ: Silver Powder 1kg" />
        <datalist id="dlItem"></datalist>
      </div>
      <div>
        <label>ë°œì£¼ ìˆ˜ëŸ‰</label>
        <input id="inQty" type="number" step="0.01" placeholder="0" />
      </div>
      <div>
        <label>ë‹¨ìœ„</label>
        <select id="inUnit">
          <option value="ea" selected>ea</option>
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="BOX">BOX</option>
          <option value="SET">SET</option>
          <option value="L">L</option>
          <option value="mL">mL</option>
        </select>
      </div>
      <div>
        <label>êµ¬ë§¤ ë‹¨ê°€ (KRW)</label>
        <input id="inPrice" type="number" step="1" placeholder="â‚© ë‹¨ê°€" />
      </div>
      <div>
        <label>ë¹„ê³  <span class="opt">(ì„ íƒ)</span></label>
        <input id="inMemo" placeholder="íŠ¹ì´ì‚¬í•­" />
      </div>
    </div>
    <div class="row r4">
      <div style="grid-column:span 2"></div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="btnAdd" class="save" style="flex:1">ë“±ë¡</button>
        <button id="btnCancel" class="secondary" style="display:none;flex:1">ì·¨ì†Œ</button>
      </div>
      <div>
        <div id="formCalc" class="mini" style="text-align:right;margin-top:0;padding-top:12px"></div>
      </div>
    </div>
  </div>

  <!-- List -->
  <div class="card">
    <h2>
      ğŸ“‹ êµ¬ë§¤ ë‚´ì—­
      <span id="filterInfo" class="stat-inline"></span>
    </h2>
    <div class="filter-bar">
      <div class="wide">
        <label>ê²€ìƒ‰ (ìƒí’ˆëª…/í’ˆë²ˆ/êµ¬ë§¤ì²˜/ë¹„ê³ )</label>
        <input id="fSearch" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." />
      </div>
      <div>
        <label>êµ¬ë§¤ì²˜</label>
        <select id="fVendor"><option value="">ì „ì²´</option></select>
      </div>
      <div>
        <label>ì…ê³  ìƒíƒœ</label>
        <select id="fStatus">
          <option value="">ì „ì²´</option>
          <option value="ORDERED">ë°œì£¼</option>
          <option value="PARTIAL">ë¶€ë¶„ì…ê³ </option>
          <option value="RECEIVED">ì…ê³ ì™„ë£Œ</option>
        </select>
      </div>
      <div>
        <label>ì‹œì‘ì¼</label>
        <input id="fFrom" type="date" />
      </div>
      <div>
        <label>ì¢…ë£Œì¼</label>
        <input id="fTo" type="date" />
      </div>
    </div>
    <div class="tools-row">
      <button id="btnExport" class="secondary">ë‚´ë³´ë‚´ê¸°(JSON)</button>
      <button id="btnImport" class="secondary">ê°€ì ¸ì˜¤ê¸°(JSON)</button>
      <input id="fileIn" type="file" accept="application/json" />
      <button id="btnReset" class="danger">ì „ì²´ ì´ˆê¸°í™”</button>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>êµ¬ë§¤ì¼</th>
            <th>êµ¬ë§¤ì²˜</th>
            <th>ë¬¸ì„œë²ˆí˜¸</th>
            <th>í’ˆë²ˆ</th>
            <th>ìƒí’ˆëª…</th>
            <th class="num">ë°œì£¼</th>
            <th class="num">ì…ê³ </th>
            <th>ë‹¨ìœ„</th>
            <th class="num">êµ¬ë§¤ë‹¨ê°€</th>
            <th class="num">êµ¬ë§¤ì´ì•¡</th>
            <th>ìƒíƒœ</th>
            <th>ë¹„ê³ </th>
            <th style="text-align:right">ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="pagination" id="pgArea"></div>
    <div class="mini">â€» êµ¬ë§¤ì´ì•¡ = ë°œì£¼ìˆ˜ëŸ‰ Ã— êµ¬ë§¤ë‹¨ê°€. ì…ê³ ì²˜ë¦¬ ì‹œ ì¬ê³ ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
  </div>

  <div class="note-box">
    ğŸ’¡ ì´ í˜ì´ì§€ëŠ” <b>êµ¬ë§¤ ì›ê°€ ê´€ë¦¬</b> ì „ìš©ì…ë‹ˆë‹¤. [ì…ê³ ì²˜ë¦¬] ë²„íŠ¼ìœ¼ë¡œ ì‹¤ì œ ì…ê³ ëœ ìˆ˜ëŸ‰ë§Œ ì¬ê³ ì— ë°˜ì˜ë©ë‹ˆë‹¤.
  </div>
</div>

<!-- â•â•â• Receiving Modal â•â•â• -->
<div id="receiveModal" class="modalBack">
  <div class="modal">
    <h3>ğŸ“¦ ì…ê³  ì²˜ë¦¬</h3>
    <div id="rcvInfo"></div>
    <hr style="border:none;border-top:1px solid var(--line);margin:12px 0" />
    <label>ì´ë²ˆ ì…ê³  ìˆ˜ëŸ‰</label>
    <input id="rcvQty" type="number" min="0" step="0.01" placeholder="ì´ë²ˆ ì…ê³  ìˆ˜ëŸ‰" />
    <div id="rcvRemaining" class="rcv-remaining"></div>
    <div id="rcvError" class="rcv-error"></div>
    <div class="modal-btns">
      <button id="rcvCancel">ì·¨ì†Œ</button>
      <button id="rcvSave" class="save" disabled>ì…ê³  í™•ì¸</button>
    </div>
  </div>
</div>

<!-- â•â•â• Vendor Drawer â•â•â• -->
<div class="drawer-overlay" id="drawerOverlay"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div class="top-row">
      <h3 id="vpName">ê±°ë˜ì²˜ëª…</h3>
      <button class="drawer-close" id="vpClose">âœ•</button>
    </div>
    <div class="drawer-stats">
      <div class="d-stat"><div class="t">ì´ êµ¬ë§¤ì•¡</div><div class="v" id="vpTotal">â‚©0</div></div>
      <div class="d-stat"><div class="t">ê±°ë˜ ê±´ìˆ˜</div><div class="v" id="vpCount">0</div></div>
      <div class="d-stat"><div class="t">ìµœê·¼ ê±°ë˜ì¼</div><div class="v" id="vpLatest">-</div></div>
      <div class="d-stat"><div class="t">ë¯¸ì™„ë£Œ Action</div><div class="v" id="vpTasks">0ê±´</div></div>
    </div>
  </div>
  <!-- Vendor Master Info -->
  <div class="vendor-master" id="vmSection">
    <div id="vmDisplay">
      <div class="vm-row"><span class="vm-label">ë‹´ë‹¹ì</span><span class="vm-value" id="vmContact">-</span></div>
      <div class="vm-row"><span class="vm-label">ì—°ë½ì²˜</span><span class="vm-value" id="vmPhone">-</span></div>
      <div class="vm-row"><span class="vm-label">ì´ë©”ì¼</span><span class="vm-value" id="vmEmail">-</span></div>
      <div class="vm-row"><span class="vm-label">ì£¼ì†Œ</span><span class="vm-value" id="vmAddr">-</span></div>
      <div class="vm-row"><span class="vm-label">ë©”ëª¨</span><span class="vm-value" id="vmMemo">-</span></div>
      <div style="text-align:right;margin-top:8px">
        <button id="vmEditBtn" class="secondary" style="padding:4px 10px;font-size:11px">ìˆ˜ì •</button>
      </div>
    </div>
    <div class="vm-edit-form" id="vmEditForm">
      <label>ë‹´ë‹¹ì</label><input id="vmInContact" placeholder="ë‹´ë‹¹ì" />
      <label>ì—°ë½ì²˜</label><input id="vmInPhone" placeholder="ì „í™”ë²ˆí˜¸" />
      <label>ì´ë©”ì¼</label><input id="vmInEmail" placeholder="ì´ë©”ì¼" />
      <label>ì£¼ì†Œ</label><input id="vmInAddr" placeholder="ì£¼ì†Œ" />
      <label>ë©”ëª¨</label><textarea id="vmInMemo" placeholder="ë©”ëª¨"></textarea>
      <div class="btns" style="margin-top:8px;justify-content:flex-end">
        <button id="vmCancelBtn" style="padding:5px 10px;font-size:11px">ì·¨ì†Œ</button>
        <button id="vmSaveBtn" class="save" style="padding:5px 10px;font-size:11px">ì €ì¥</button>
      </div>
    </div>
  </div>
  <!-- Tabs -->
  <div class="drawer-tabs">
    <div class="drawer-tab active" data-panel="purchases">ìµœê·¼ êµ¬ë§¤ 5ê±´</div>
    <div class="drawer-tab" data-panel="actions">ë¯¸ì™„ë£Œ Action</div>
  </div>
  <div class="drawer-panel active" id="dpPurchases">
    <h4>ìµœê·¼ êµ¬ë§¤</h4>
    <div id="vpPurchases"></div>
  </div>
  <div class="drawer-panel" id="dpActions">
    <h4>ë¯¸ì™„ë£Œ Action</h4>
    <div id="vpTodos"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GoLab v1.6.1 â€” Purchase Ledger
   êµ¬ë§¤ â†’ ì…ê³ ì²˜ë¦¬ â†’ ì¬ê³  ë°˜ì˜ íŒŒì´í”„ë¼ì¸
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Constants â”€â”€ */
const TRADE_KEY = "golab_trade_v1";
const AUDIT_KEY = "golab_trade_audit";
const INV_KEY = "golab_inventory_v01";
const HIST_KEY = "golab_inventory_inbound_history_v01";
const ACTION_KEY = "golab_actions_v15";
const VENDOR_KEY = "golab_vendors_v1";
const PAGE_SIZE = 50;
const DEBOUNCE_MS = 300;
const $ = id => document.getElementById(id);

/* â”€â”€ Audit Log â”€â”€ */
function emitAudit(event, detail){
  try{
    const log = JSON.parse(localStorage.getItem(AUDIT_KEY)||"[]");
    log.push({ event, ts: new Date().toISOString(), detail: detail || {} });
    if(log.length>2000) log.splice(0, log.length-2000);
    localStorage.setItem(AUDIT_KEY, JSON.stringify(log));
  }catch(e){}
}

/* â”€â”€ State â”€â”€ */
let editingId = null;
let currentPage = 1;
let debounceTimer = null;
let _cache = null;
let receivingId = null;

/* â”€â”€ Init date â”€â”€ */
$("inDate").value = new Date().toISOString().substring(0,10);

/* â”€â”€ Helpers â”€â”€ */
function n(v,fb=0){ const x=Number(v); return Number.isFinite(x)?x:fb; }
function esc(s){ return (s||"").replace(/</g,"&lt;"); }
function fmt(v){ return "â‚©"+Math.round(v).toLocaleString(); }
function normStr(s){ return (s==null)?"":String(s).trim(); }
function normUpper(s){ return normStr(s).toUpperCase(); }
function normNum(v){
  if(v==null) return 0;
  if(typeof v==="number") return Number.isFinite(v)?v:0;
  const cleaned = String(v).replace(/[â‚©,\s]/g,"");
  const x = Number(cleaned);
  return Number.isFinite(x)?x:0;
}
function normDate(v){
  if(!v) return "";
  if(v instanceof Date){
    const y=v.getFullYear(), m=String(v.getMonth()+1).padStart(2,"0"), d=String(v.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+d;
  }
  if(typeof v==="number"){
    const base=new Date(1899,11,30);
    base.setDate(base.getDate()+Math.floor(v));
    const y=base.getFullYear(), m=String(base.getMonth()+1).padStart(2,"0"), d=String(base.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+d;
  }
  let s=String(v).trim();
  s=s.replace(/^(\d{4})[./](\d{1,2})[./](\d{1,2})/, (_, y, m, d) =>
    y+"-"+m.padStart(2,"0")+"-"+d.padStart(2,"0")
  );
  if(s.length>=10) return s.substring(0,10);
  return s;
}

function todayStr(){ return new Date().toISOString().substring(0,10); }

/* â”€â”€ Toast â”€â”€ */
function showToast(msg, duration=3000){
  const el = $("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), duration);
}

/* â”€â”€ Deterministic itemId (djb2 hash) â”€â”€ */
function deterministicItemId(vendor, partNo, itemName){
  const src = [vendor, partNo, itemName].map(s=>normStr(s).toLowerCase()).join("|");
  let h = 5381;
  for(let i=0;i<src.length;i++) h = ((h<<5)+h) + src.charCodeAt(i);
  return "item-"+(h>>>0).toString(16).padStart(8,"0");
}

/* â”€â”€ Storage â”€â”€ */
function load(){
  if(_cache) return _cache;
  try{ _cache=JSON.parse(localStorage.getItem(TRADE_KEY)||"[]"); }
  catch{ _cache=[]; }
  return _cache;
}
function save(data){
  _cache=data;
  localStorage.setItem(TRADE_KEY,JSON.stringify(data));
}
function invalidateCache(){ _cache=null; }

/* â”€â”€ Actions (Single Source of Truth) â”€â”€ */
function loadActions(){ try{return JSON.parse(localStorage.getItem(ACTION_KEY)||"[]")}catch{return[]} }

/* â”€â”€ Vendor Master â”€â”€ */
function loadVendors(){ try{return JSON.parse(localStorage.getItem(VENDOR_KEY)||"{}")}catch{return{}} }
function saveVendors(obj){ localStorage.setItem(VENDOR_KEY, JSON.stringify(obj)); }

/* â”€â”€ Normalize record (backward compat: adds receivedQty + status) â”€â”€ */
function normalizeRecord(r){
  const vendor = normStr(r.vendor);
  const partNo = normUpper(r.partNo);
  const itemName = normStr(r.itemName || r.product || "");
  return {
    id: r.id || crypto.randomUUID(),
    purchaseDate: normDate(r.purchaseDate || r.date || ""),
    vendor,
    docNo: normStr(r.docNo),
    itemId: r.itemId || deterministicItemId(vendor, partNo, itemName),
    partNo,
    itemName,
    qty: normNum(r.qty),
    unit: normStr(r.unit) || "ea",
    buyUnitPrice: normNum(r.buyUnitPrice || r.buyPrice || 0),
    receivedQty: normNum(r.receivedQty || 0),
    status: r.status || "ORDERED",
    memo: normStr(r.memo || r.note || ""),
    createdAt: r.createdAt || new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
}

/* â”€â”€ Status helper â”€â”€ */
function computeStatus(qty, receivedQty){
  if(receivedQty >= qty && qty > 0) return "RECEIVED";
  if(receivedQty > 0) return "PARTIAL";
  return "ORDERED";
}
function statusLabel(s){
  if(s==="RECEIVED") return "ì…ê³ ì™„ë£Œ";
  if(s==="PARTIAL") return "ë¶€ë¶„ì…ê³ ";
  return "ë°œì£¼";
}

/* â”€â”€ Autocomplete â”€â”€ */
function uniqueVals(key){
  return [...new Set(load().map(r=>normStr(r[key])).filter(Boolean))].sort();
}
function refreshAC(){
  const fill=(dlId,key)=>{
    const dl=$(dlId); dl.innerHTML="";
    uniqueVals(key).forEach(v=>{ const o=document.createElement("option"); o.value=v; dl.appendChild(o); });
  };
  fill("dlVendor","vendor");
  fill("dlPartNo","partNo");
  fill("dlItem","itemName");
}

/* â”€â”€ Filters â”€â”€ */
function refreshFilterSelects(){
  const sel=$("fVendor");
  const cur=sel.value;
  const opts=uniqueVals("vendor");
  sel.innerHTML='<option value="">ì „ì²´</option>';
  opts.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); });
  sel.value=cur;
}

function getFiltered(){
  let data=load();
  const q=($("fSearch").value||"").trim().toLowerCase();
  const vendor=$("fVendor").value;
  const status=$("fStatus").value;
  const from=$("fFrom").value;
  const to=$("fTo").value;
  if(q){
    data=data.filter(r=>
      (r.itemName||"").toLowerCase().includes(q)||
      (r.partNo||"").toLowerCase().includes(q)||
      (r.vendor||"").toLowerCase().includes(q)||
      (r.memo||"").toLowerCase().includes(q)||
      (r.docNo||"").toLowerCase().includes(q)
    );
  }
  if(vendor) data=data.filter(r=>r.vendor===vendor);
  if(status) data=data.filter(r=>(r.status||"ORDERED")===status);
  if(from) data=data.filter(r=>(r.purchaseDate||"")>=from);
  if(to) data=data.filter(r=>(r.purchaseDate||"")<=to);
  return data;
}

/* â”€â”€ KPI â”€â”€ */
function hasActiveFilter(){
  return !!($("fSearch").value||"").trim()
    || !!$("fVendor").value
    || !!$("fStatus").value
    || !!$("fFrom").value
    || !!$("fTo").value;
}
function computeKPI(){
  const all=load();
  const filtered=getFiltered();
  const isFiltered = hasActiveFilter();

  const calc=(arr)=>{
    let total=0; const vendors=new Set(); let latest=""; let pending=0;
    arr.forEach(r=>{
      total += n(r.buyUnitPrice)*n(r.qty);
      if(r.vendor) vendors.add(r.vendor);
      if(r.purchaseDate && r.purchaseDate>latest) latest=r.purchaseDate;
      if((r.status||"ORDERED")!=="RECEIVED") pending++;
    });
    return {total,count:arr.length,vendors:vendors.size,latest,pending};
  };

  const a=calc(all);
  const f=isFiltered?calc(filtered):null;

  $("kTotal").textContent = fmt(a.total);
  $("kCount").textContent = a.count.toLocaleString()+"ê±´";
  $("kVendors").textContent = a.vendors.toLocaleString();
  $("kPending").textContent = a.pending.toLocaleString();
  $("kLatest").textContent = a.latest || "-";

  if(f){
    $("kTotalSub").textContent = "í•„í„°: "+fmt(f.total);
    $("kCountSub").textContent = "í•„í„°: "+f.count.toLocaleString()+"ê±´";
    $("kVendorsSub").textContent = "í•„í„°: "+f.vendors.toLocaleString();
    $("kPendingSub").textContent = "í•„í„°: "+f.pending;
    $("kLatestSub").textContent = "í•„í„°: "+(f.latest||"-");
  } else {
    $("kTotalSub").textContent="";
    $("kCountSub").textContent="";
    $("kVendorsSub").textContent="";
    $("kPendingSub").textContent="";
    $("kLatestSub").textContent="";
  }
}

/* â”€â”€ Form calc preview â”€â”€ */
function updateFormCalc(){
  const qty=n($("inQty").value);
  const price=n($("inPrice").value);
  const el=$("formCalc");
  if(qty>0 && price>0){
    el.textContent="êµ¬ë§¤ì´ì•¡: "+fmt(qty*price);
  } else {
    el.textContent="";
  }
}

/* â”€â”€ Render â”€â”€ */
function render(){
  const filtered=getFiltered();
  const total=load().length;
  const totalPages=Math.max(1,Math.ceil(filtered.length/PAGE_SIZE));
  if(currentPage>totalPages) currentPage=totalPages;
  const start=(currentPage-1)*PAGE_SIZE;
  const page=filtered.slice(start,start+PAGE_SIZE);

  $("filterInfo").textContent = filtered.length===total
    ? total+"ê±´"
    : filtered.length+" / "+total+"ê±´ (í•„í„° ì ìš© ì¤‘)";

  const tb=$("tbody");
  tb.innerHTML="";
  if(page.length===0){
    tb.innerHTML='<tr><td colspan="13" class="muted" style="text-align:center;padding:24px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
  }
  page.forEach(r=>{
    const buyTotal=n(r.buyUnitPrice)*n(r.qty);
    const st = r.status || "ORDERED";
    const rcvd = n(r.receivedQty);
    const qty = n(r.qty);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="muted">${esc(r.purchaseDate)}</td>
      <td><span class="vendor-link" data-vendor="${esc(r.vendor)}">${esc(r.vendor)}</span></td>
      <td class="muted">${esc(r.docNo)}</td>
      <td class="muted">${esc(r.partNo)}</td>
      <td>${esc(r.itemName)}</td>
      <td class="num">${qty.toLocaleString()}</td>
      <td class="num" style="font-weight:700;${rcvd>0&&rcvd<qty?'color:var(--warn)':rcvd>=qty&&qty>0?'color:var(--accent)':''}">${rcvd.toLocaleString()}</td>
      <td class="muted">${esc(r.unit)}</td>
      <td class="num">${fmt(n(r.buyUnitPrice))}</td>
      <td class="num highlight">${fmt(buyTotal)}</td>
      <td><span class="status-tag ${st}">${statusLabel(st)}</span></td>
      <td class="muted">${esc(r.memo)}</td>
      <td style="text-align:right;white-space:nowrap">
        ${st!=="RECEIVED"?`<button class="receive-btn" data-rcv="${r.id}">ì…ê³ ì²˜ë¦¬</button>`:''}
        <button class="secondary" style="padding:5px 8px;font-size:11px" data-edit="${r.id}">ìˆ˜ì •</button>
        <button class="danger" style="padding:5px 8px;font-size:11px" data-del="${r.id}">ì‚­ì œ</button>
      </td>`;
    tb.appendChild(tr);
  });

  // Bind events
  tb.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.onclick=e=>{ e.stopPropagation(); deleteRecord(btn.dataset.del); };
  });
  tb.querySelectorAll("button[data-edit]").forEach(btn=>{
    btn.onclick=e=>{ e.stopPropagation(); startEdit(btn.dataset.edit); };
  });
  tb.querySelectorAll("button[data-rcv]").forEach(btn=>{
    btn.onclick=e=>{ e.stopPropagation(); openReceiveModal(btn.dataset.rcv); };
  });
  tb.querySelectorAll(".vendor-link").forEach(el=>{
    el.onclick=e=>{ e.stopPropagation(); openDrawer(el.dataset.vendor); };
  });

  // Pagination
  const pg=$("pgArea");
  pg.innerHTML="";
  if(totalPages>1){
    const mk=(label,p,dis)=>{
      const b=document.createElement("button");
      b.textContent=label; b.className="secondary"; b.disabled=dis;
      b.onclick=()=>{ currentPage=p; render(); };
      return b;
    };
    pg.appendChild(mk("â—€ ì´ì „",currentPage-1,currentPage<=1));
    const s=document.createElement("span");
    s.className="current";
    s.textContent=currentPage+" / "+totalPages;
    pg.appendChild(s);
    pg.appendChild(mk("ë‹¤ìŒ â–¶",currentPage+1,currentPage>=totalPages));
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECEIVING MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openReceiveModal(id){
  const r = load().find(x=>x.id===id);
  if(!r) return;
  receivingId = id;
  const qty = n(r.qty);
  const rcvd = n(r.receivedQty);
  const remaining = qty - rcvd;

  $("rcvInfo").innerHTML = `
    <div class="info-row"><span class="label">ìƒí’ˆëª…</span><span class="value">${esc(r.itemName)}</span></div>
    <div class="info-row"><span class="label">êµ¬ë§¤ì²˜</span><span class="value">${esc(r.vendor)}</span></div>
    <div class="info-row"><span class="label">ë°œì£¼ ìˆ˜ëŸ‰</span><span class="value">${qty.toLocaleString()} ${esc(r.unit)}</span></div>
    <div class="info-row"><span class="label">ê¸° ì…ê³ </span><span class="value">${rcvd.toLocaleString()} ${esc(r.unit)}</span></div>
    <div class="info-row"><span class="label" style="color:var(--point);font-weight:700">ì”ì—¬ ìˆ˜ëŸ‰</span><span class="value" style="color:var(--point)">${remaining.toLocaleString()} ${esc(r.unit)}</span></div>
  `;
  $("rcvQty").value = "";
  $("rcvQty").max = remaining;
  $("rcvQty").placeholder = "ì´ë²ˆ ì…ê³  ìˆ˜ëŸ‰ (ìµœëŒ€ "+remaining+")";
  $("rcvRemaining").textContent = "ì”ì—¬ "+remaining+"ê°œ ì…ê³  ê°€ëŠ¥";
  $("rcvError").style.display = "none";
  $("rcvSave").disabled = true;
  $("receiveModal").classList.add("open");
  setTimeout(() => $("rcvQty").focus(), 100);
}

function closeReceiveModal(){
  $("receiveModal").classList.remove("open");
  receivingId = null;
}

function validateReceiveQty(){
  const r = load().find(x=>x.id===receivingId);
  if(!r){ $("rcvSave").disabled=true; return; }
  const remaining = n(r.qty) - n(r.receivedQty);
  const addQty = n($("rcvQty").value);
  const err = $("rcvError");

  if($("rcvQty").value==="" || addQty <= 0){
    err.textContent = "1 ì´ìƒì˜ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    err.style.display = "block";
    $("rcvSave").disabled = true;
    return;
  }
  if(addQty > remaining){
    err.textContent = "ì”ì—¬ ìˆ˜ëŸ‰("+remaining+")ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.";
    err.style.display = "block";
    $("rcvSave").disabled = true;
    return;
  }
  err.style.display = "none";
  $("rcvSave").disabled = false;
}

function saveReceive(){
  if(!receivingId) return;
  const all = load();
  const r = all.find(x=>x.id===receivingId);
  if(!r) return;

  const addQty = n($("rcvQty").value);
  const remaining = n(r.qty) - n(r.receivedQty);
  if(addQty <= 0 || addQty > remaining) return;

  // Update record
  r.receivedQty = n(r.receivedQty) + addQty;
  r.status = computeStatus(n(r.qty), r.receivedQty);
  r.updatedAt = new Date().toISOString();
  save(all);

  // Update inventory
  updateInventoryOnReceive(r, addQty);

  // Audit
  emitAudit("RECEIVE", {
    id: r.id,
    vendor: r.vendor,
    itemName: r.itemName,
    addQty: addQty,
    receivedQty: r.receivedQty,
    status: r.status
  });

  closeReceiveModal();
  computeKPI();
  render();
  showToast("ì…ê³  ìˆ˜ëŸ‰ì´ ë°˜ì˜ë˜ì–´ ì¬ê³ ì— ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVENTORY UPDATE (Moving Average)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateInventoryOnReceive(record, addQty){
  let inv = [];
  try{ inv = JSON.parse(localStorage.getItem(INV_KEY)||"[]"); }catch{}
  let hist = [];
  try{ hist = JSON.parse(localStorage.getItem(HIST_KEY)||"[]"); }catch{}

  // Find or create inventory item
  let target = inv.find(x => x.id === record.itemId)
            || inv.find(x => (x.name||"").trim() === (record.itemName||"").trim());

  if(!target){
    target = {
      id: record.itemId || crypto.randomUUID(),
      name: record.itemName,
      spec: record.unit,
      vendor: record.vendor,
      buyPrice: 0,
      qty: 0,
      minQty: 0,
      note: "",
      updatedAt: new Date().toISOString()
    };
    inv.unshift(target);
  }

  // Moving average cost
  const oldQty = n(target.qty);
  const oldPrice = n(target.buyPrice);
  const newQty = addQty;
  const unitPrice = n(record.buyUnitPrice);
  const totalQty = oldQty + newQty;

  if(totalQty > 0){
    target.buyPrice = (oldQty * oldPrice + newQty * unitPrice) / totalQty;
  } else {
    target.buyPrice = unitPrice;
  }
  target.qty = totalQty;

  const stamp = `ì…ê³  +${newQty}${record.unit} from ${record.vendor} (${todayStr()})`;
  target.note = (target.note ? (target.note + " | ") : "") + stamp;
  target.updatedAt = new Date().toISOString();

  // Record history
  hist.unshift({
    at: new Date().toISOString(),
    batchId: "",
    batchName: "êµ¬ë§¤ì›ì¥ ì…ê³ ì²˜ë¦¬",
    date: todayStr(),
    inventoryItemId: target.id,
    name: record.itemName,
    qty: newQty,
    unit: record.unit,
    unitPriceKrw: unitPrice,
    addedValueKrw: newQty * unitPrice,
    memo: record.memo || ""
  });
  while(hist.length > 500) hist.pop();

  localStorage.setItem(INV_KEY, JSON.stringify(inv));
  localStorage.setItem(HIST_KEY, JSON.stringify(hist));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VENDOR DRAWER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentDrawerVendor = "";

function openDrawer(vendor){
  if(!vendor) return;
  currentDrawerVendor = vendor;
  $("drawer").classList.add("open");
  $("drawerOverlay").classList.add("open");
  $("vpName").textContent = vendor;

  // Stats
  const trades = load().filter(r => r.vendor === vendor);
  const vendorActions = loadActions().filter(a => a.vendorId === vendor && a.status !== "DONE");

  const tTotal = trades.reduce((s,r) => s + n(r.buyUnitPrice) * n(r.qty), 0);
  const allDates = trades.map(r => r.purchaseDate).filter(Boolean).sort();
  $("vpTotal").textContent = fmt(tTotal);
  $("vpCount").textContent = trades.length;
  $("vpLatest").textContent = allDates.length ? allDates[allDates.length-1] : "-";
  $("vpTasks").textContent = vendorActions.length + "ê±´";

  // Vendor Master Info
  const masters = loadVendors();
  const m = masters[vendor] || {};
  $("vmContact").textContent = m.contact || "-";
  $("vmPhone").textContent = m.phone || "-";
  $("vmEmail").textContent = m.email || "-";
  $("vmAddr").textContent = m.address || "-";
  $("vmMemo").textContent = m.memo || "-";
  $("vmDisplay").style.display = "block";
  $("vmEditForm").style.display = "none";

  // Tab: Recent Purchases (5)
  const recent = [...trades].sort((a,b) => (b.purchaseDate||"").localeCompare(a.purchaseDate||"")).slice(0,5);
  const pDiv = $("vpPurchases");
  if(!recent.length){
    pDiv.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px 0">êµ¬ë§¤ ì´ë ¥ ì—†ìŒ</div>';
  } else {
    pDiv.innerHTML = recent.map(r => {
      const st = r.status || "ORDERED";
      return `<div class="drawer-purchase">
        <div class="dp-top">
          <span class="dp-item">${esc(r.itemName)}</span>
          <span class="status-tag ${st}" style="font-size:9px">${statusLabel(st)}</span>
        </div>
        <div class="dp-detail">${esc(r.purchaseDate)} Â· ${n(r.qty).toLocaleString()} ${esc(r.unit)} Â· ${fmt(n(r.buyUnitPrice)*n(r.qty))}</div>
      </div>`;
    }).join("");
  }

  // Tab: Pending Actions
  const todoDiv = $("vpTodos");
  if(!vendorActions.length){
    todoDiv.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px 0">ë¯¸ì™„ë£Œ Action ì—†ìŒ</div>';
  } else {
    todoDiv.innerHTML = "";
    vendorActions.forEach(a => {
      const d = document.createElement("div"); d.className = "drawer-todo";
      const overdueTag = a.dueDate < todayStr() ? ' <span style="color:var(--bad);font-size:10px;font-weight:700">ì§€ì—°</span>' : '';
      d.innerHTML = `<div class="dt-dot"></div><span>${esc(a.title)}${overdueTag}</span>`;
      todoDiv.appendChild(d);
    });
  }

  // Activate first tab
  document.querySelectorAll(".drawer-tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".drawer-panel").forEach(p => p.classList.remove("active"));
  document.querySelector('.drawer-tab[data-panel="purchases"]').classList.add("active");
  $("dpPurchases").classList.add("active");
}

function closeDrawer(){
  $("drawer").classList.remove("open");
  $("drawerOverlay").classList.remove("open");
  currentDrawerVendor = "";
}

// Drawer tab switching
document.querySelectorAll(".drawer-tab").forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll(".drawer-tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".drawer-panel").forEach(p => p.classList.remove("active"));
    tab.classList.add("active");
    $("dp" + tab.dataset.panel.charAt(0).toUpperCase() + tab.dataset.panel.slice(1)).classList.add("active");
  };
});

// Vendor master edit
$("vmEditBtn").onclick = () => {
  const masters = loadVendors();
  const m = masters[currentDrawerVendor] || {};
  $("vmInContact").value = m.contact || "";
  $("vmInPhone").value = m.phone || "";
  $("vmInEmail").value = m.email || "";
  $("vmInAddr").value = m.address || "";
  $("vmInMemo").value = m.memo || "";
  $("vmDisplay").style.display = "none";
  $("vmEditForm").style.display = "block";
};
$("vmCancelBtn").onclick = () => {
  $("vmDisplay").style.display = "block";
  $("vmEditForm").style.display = "none";
};
$("vmSaveBtn").onclick = () => {
  if(!currentDrawerVendor) return;
  const masters = loadVendors();
  masters[currentDrawerVendor] = {
    contact: $("vmInContact").value.trim(),
    phone: $("vmInPhone").value.trim(),
    email: $("vmInEmail").value.trim(),
    address: $("vmInAddr").value.trim(),
    memo: $("vmInMemo").value.trim(),
    updatedAt: new Date().toISOString()
  };
  saveVendors(masters);
  showToast("ê±°ë˜ì²˜ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
  openDrawer(currentDrawerVendor); // refresh
};

$("vpClose").onclick = closeDrawer;
$("drawerOverlay").onclick = closeDrawer;

/* â”€â”€ CRUD â”€â”€ */
function clearForm(){
  $("inDate").value=new Date().toISOString().substring(0,10);
  $("inVendor").value=""; $("inDocNo").value=""; $("inPartNo").value="";
  $("inItem").value=""; $("inQty").value=""; $("inUnit").value="ea";
  $("inPrice").value=""; $("inMemo").value="";
  editingId=null;
  $("btnAdd").textContent="ë“±ë¡";
  $("btnCancel").style.display="none";
  $("formCalc").textContent="";
}

function addOrUpdate(){
  const vendor=normStr($("inVendor").value);
  const itemName=normStr($("inItem").value);
  if(!vendor && !itemName){ alert("êµ¬ë§¤ì²˜ ë˜ëŠ” ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

  const existing = editingId ? load().find(x=>x.id===editingId) : null;

  const rec=normalizeRecord({
    id: editingId||undefined,
    itemId: existing ? existing.itemId : undefined,
    purchaseDate: $("inDate").value,
    vendor,
    docNo: $("inDocNo").value,
    partNo: $("inPartNo").value,
    itemName,
    qty: $("inQty").value,
    unit: $("inUnit").value,
    buyUnitPrice: $("inPrice").value,
    receivedQty: existing ? existing.receivedQty : 0,
    status: existing ? existing.status : "ORDERED",
    memo: $("inMemo").value,
    createdAt: existing ? existing.createdAt : undefined
  });

  // Recompute status in case qty changed
  rec.status = computeStatus(rec.qty, rec.receivedQty);

  const all=load();
  if(editingId){
    const idx=all.findIndex(x=>x.id===editingId);
    if(idx>=0) all[idx]=rec;
    emitAudit("UPDATE",{id:rec.id, vendor:rec.vendor, itemName:rec.itemName});
  } else {
    all.unshift(rec);
    emitAudit("CREATE",{id:rec.id, vendor:rec.vendor, itemName:rec.itemName});
  }
  save(all);
  clearForm();
  refreshAC();
  refreshFilterSelects();
  computeKPI();
  render();
}

function startEdit(id){
  const r=load().find(x=>x.id===id);
  if(!r) return;
  editingId=r.id;
  $("inDate").value=r.purchaseDate||"";
  $("inVendor").value=r.vendor||"";
  $("inDocNo").value=r.docNo||"";
  $("inPartNo").value=r.partNo||"";
  $("inItem").value=r.itemName||"";
  $("inQty").value=n(r.qty)||"";
  $("inUnit").value=r.unit||"ea";
  $("inPrice").value=n(r.buyUnitPrice)||"";
  $("inMemo").value=r.memo||"";
  $("btnAdd").textContent="ì €ì¥";
  $("btnCancel").style.display="block";
  updateFormCalc();
  window.scrollTo({top:0,behavior:"smooth"});
}

function deleteRecord(id){
  if(!confirm("ì´ êµ¬ë§¤ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  const target=load().find(x=>x.id===id);
  if(target) emitAudit("DELETE",{id, vendor:target.vendor, itemName:target.itemName});
  save(load().filter(x=>x.id!==id));
  refreshFilterSelects();
  computeKPI();
  render();
}

/* â”€â”€ Import/Export â”€â”€ */
function exportJson(){
  const data=localStorage.getItem(TRADE_KEY)||"[]";
  const blob=new Blob([data],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="GoLab_PurchaseLedger_"+new Date().toISOString().slice(0,10)+".json";
  a.click();
}

function dupKey(r){
  return [r.purchaseDate, r.vendor, r.partNo, String(r.qty), String(r.buyUnitPrice)].join("|");
}

function importJson(file){
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const raw=JSON.parse(reader.result);
      if(!Array.isArray(raw)) throw new Error("JSON ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.");
      let ok=0, skip=0, dup=0;
      const cleaned=[];
      const existing=load();
      const existingKeys=new Set(existing.map(r=>dupKey(r)));
      raw.forEach((r,i)=>{
        try{
          const rec=normalizeRecord(r);
          const key=dupKey(rec);
          if(existingKeys.has(key)){ dup++; return; }
          existingKeys.add(key);
          cleaned.push(rec);
          ok++;
        }catch(e){ skip++; }
      });
      if(skip>0) alert(skip+"ê±´ì˜ ë°ì´í„°ê°€ í˜•ì‹ ì˜¤ë¥˜ë¡œ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.");
      const merged=[...cleaned,...existing];
      save(merged);
      invalidateCache();
      refreshAC();
      refreshFilterSelects();
      computeKPI();
      render();
      emitAudit("IMPORTED",{added:ok, duplicates:dup, skipped:skip, totalAfter:merged.length});
      let msg=ok+"ê±´ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ (ê¸°ì¡´ "+existing.length+"ê±´ + ì‹ ê·œ "+ok+"ê±´ = ì´ "+merged.length+"ê±´)";
      if(dup>0) msg+="\nì¤‘ë³µ ê±´ë„ˆë›°ê¸°: "+dup+"ê±´";
      alert(msg);
    }catch(e){
      alert("JSON í˜•ì‹ ì˜¤ë¥˜: "+e.message);
    }
  };
  reader.readAsText(file);
}

/* â”€â”€ Debounced filter â”€â”€ */
function debouncedRender(){
  clearTimeout(debounceTimer);
  debounceTimer=setTimeout(()=>{
    currentPage=1;
    computeKPI();
    render();
  },DEBOUNCE_MS);
}

/* â”€â”€ Events â”€â”€ */
$("btnAdd").onclick=addOrUpdate;
$("btnCancel").onclick=clearForm;
$("btnExport").onclick=exportJson;
$("btnImport").onclick=()=>$("fileIn").click();
$("fileIn").addEventListener("change",e=>{
  const f=e.target.files?.[0];
  if(f) importJson(f);
  e.target.value="";
});
$("btnReset").onclick=()=>{
  if(!confirm("êµ¬ë§¤ ì›ì¥ ë°ì´í„°ë¥¼ ì „ì²´ ì´ˆê¸°í™”í• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)")) return;
  localStorage.removeItem(TRADE_KEY);
  invalidateCache();
  currentPage=1;
  refreshAC();
  refreshFilterSelects();
  computeKPI();
  render();
  alert("ì´ˆê¸°í™” ì™„ë£Œ");
};

// Receive modal events
$("rcvQty").addEventListener("input", validateReceiveQty);
$("rcvSave").onclick = saveReceive;
$("rcvCancel").onclick = closeReceiveModal;
$("receiveModal").onclick = e => { if(e.target===$("receiveModal")) closeReceiveModal(); };

// Filter events
$("fSearch").addEventListener("input",debouncedRender);
$("fVendor").addEventListener("change",()=>{ currentPage=1; computeKPI(); render(); });
$("fStatus").addEventListener("change",()=>{ currentPage=1; computeKPI(); render(); });
$("fFrom").addEventListener("change",()=>{ currentPage=1; computeKPI(); render(); });
$("fTo").addEventListener("change",()=>{ currentPage=1; computeKPI(); render(); });

// Form calc preview
$("inQty").addEventListener("input",updateFormCalc);
$("inPrice").addEventListener("input",updateFormCalc);

// Escape key
document.addEventListener("keydown", e => {
  if(e.key==="Escape"){
    closeReceiveModal();
    closeDrawer();
  }
});

/* â”€â”€ Init â”€â”€ */
refreshAC();
refreshFilterSelects();
computeKPI();
render();
</script>
</body>
</html>
